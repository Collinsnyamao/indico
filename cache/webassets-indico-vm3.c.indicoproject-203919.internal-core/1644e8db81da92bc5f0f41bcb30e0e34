V(function(global){'use strict';$(document).ready(function(){setupRegistrationFormScheduleDialogs();setupRegistrationFormSummaryPage();});$(window).scroll(function(){IndicoUI.Effect.followScroll();});function setupRegistrationFormScheduleDialogs(){$('a.js-regform-schedule-dialog').on('click',function(e){e.preventDefault();ajaxDialog({url:$(this).data('href'),title:$(this).data('title'),onClose:function(data){if(data){location.reload();}}});});}\u000afunction setupRegistrationFormSummaryPage(){$('.js-check-conditions').on('click',function(e){var conditions=$('#conditions-accepted');if(conditions.length&&!conditions.prop('checked')){var msg="Please, confirm that you have read and accepted the Terms and Conditions before proceeding.";alertPopup($T.gettext(msg),$T.gettext("Terms and Conditions"));e.preventDefault();}});$('.js-highlight-payment').on('click',function(){$('#payment-summary').effect('highlight',800);});}\u000aglobal.setupRegistrationFormListPage=function setupRegistrationFormListPage(){$('#payment-disabled-notice').on('indico:confirmed','.js-enable-payments',function(evt){evt.preventDefault();var $this=$(this);$.ajax({url:$this.data('href'),method:$this.data('method'),complete:IndicoUI.Dialogs.Util.progress(),error:handleAjaxError,success:function(data){$('#payment-disabled-notice').remove();$('#event-side-menu').html(data.event_menu);}});});};})(window);(function(global){'use strict';global.setupInvitationPage=function setupInvitationPage(){$('#invitation-list').on('indico:confirmed','.js-invitation-action',function(evt){evt.preventDefault();var $this=$(this);$.ajax({url:$this.data('href'),method:$this.data('method'),complete:IndicoUI.Dialogs.Util.progress(),error:handleAjaxError,success:function(data){$('#invitation-list').html(data.invitation_list);}});});$('.js-invite-user').ajaxDialog({onClose:function(data){if(data){$('#invitation-list').html(data.invitation_list);}}});};})(window);(function(global){'use strict';global.setupRegistrationList=function setupRegistrationList(){setupListGenerator();function handleRegListRowSelection(){$('table.i-table input.select-row').on('change',function(){$('.regform-download-attachments').toggleClass('disabled',!$('.list input:checkbox:checked[data-has-files=true]').length);}).trigger('change');}\u000a$('body').on('click','#preview-email',function(){var $this=$(this);ajaxDialog({url:$this.data('href'),title:$T.gettext('Email Preview'),method:'POST',data:function(){return{registration_id:getSelectedRows()[0],subject:$('#subject').val(),body:$('#body').val()};}});});$('.registrations').on('indico:confirmed','.js-delete-registrations',function(evt){evt.preventDefault();var $this=$(this);var selectedRows=getSelectedRows();var msg=$T.ngettext('Do you really want to delete the selected registration?','Do you really want to delete the {0} selected registrations?',selectedRows.length).format(selectedRows.length);confirmPrompt(msg).then(function(){$.ajax({url:$this.data('href'),method:$this.data('method'),data:{registration_id:selectedRows},complete:IndicoUI.Dialogs.Util.progress(),error:handleAjaxError,success:function(){for(var i=0;i<selectedRows.length;i++){var row=$('#registration-'+selectedRows[i]);row.fadeOut('fast',function(){$(this).remove();});}}});});});$('.registrations').on('indico:confirmed','.js-modify-status',function(evt){evt.preventDefault();var $this=$(this);var selectedRows=getSelectedRows();$.ajax({url:$this.data('href'),method:$this.data('method'),data:{registration_id:selectedRows,flag:$this.data('flag')},complete:IndicoUI.Dialogs.Util.progress(),error:handleAjaxError,success:function(data){if(data){$('.list-content').html(data.html);handleRowSelection();handleRegListRowSelection();setupTableSorter();}}});});var principal=$('#indico-user-to-add').principalfield({onAdd:function(users){if(users.length){var url=$('.js-add-user').data('href');location.href=build_url(url,{user:users[0].id});}}});$('.js-add-user').on('click',function(){principal.principalfield('choose');});$('.js-add-multiple-users').ajaxDialog({dialogClasses:'add-multiple-users-dialog',onClose:function(data){if(data){$('.list-content').html(data.html);handleRowSelection();handleRegListRowSelection();setupTableSorter();}}});};})(window);var ndRegForm=angular.module('nd.regform',['ui.sortable','ngResource','ngSanitize']);ndRegForm.value('editionURL',Indico.Urls.Base+'/event/:confId/manage/registration/:confFormId/form/');ndRegForm.value('displayurl',Indico.Urls.Base+'/event/:confId/registration/:confFormId/sections');ndRegForm.value('sortableoptions',{start:function(e,ui){var borderOffset=2;ui.placeholder.height(ui.helper.outerHeight()-borderOffset);},axis:'y',cursor:'move',delay:150,distance:10,opacity:0.90,tolerance:'pointer'});ndRegForm.value('fieldDefaults',{'defaultTextFieldSize':60,'defaultNumberValue':0,'defaultRadioItemType':'dropdown','defaultNumberOfColumns':60,'defaultNumberOfRows':2,'defaultPrice':0,'defaultMinValue':0,'defaultPlacesLimit':0,'defaultDateFormat':'%d/%m/%Y','defaultPhoneSize':30});ndRegForm.config(function(urlProvider){urlProvider.setModulePath('/js/indico/modules/registration/form');});ndRegForm.factory('regFormFactory',function($resource,$http,editionURL,displayurl,fieldDefaults){var defaults=$http.defaults.headers;defaults.common=defaults.common||{};defaults.get=defaults.get||{};defaults.get['Content-Type']=defaults.common['Content-Type']='application/json';defaults.common['X-CSRF-Token']=$('#csrf-token').attr('content');defaults.common['X-Requested-With']='XMLHttpRequest';var urls=Indico.Urls.RegistrationForm;return{processResponse:function(data,callback){callback=callback||{};if(data.error){showErrorDialog(data.error);if(callback.error){callback.error(data);}}else if(callback.success){callback.success(data);}},getDefaultFieldSetting:function(setting){return fieldDefaults[setting];},Sections:$resource(urls.section.add,{confId:'@confId',sectionId:"@sectionId",confFormId:"@confFormId"},{"remove":{method:'DELETE',url:urls.section.modify,isArray:true},"enable":{method:'POST',url:urls.section.toggle,params:{enable:true}},"disable":{method:'POST',url:urls.section.toggle,params:{enable:false}},"move":{method:'POST',url:urls.section.move},"modify":{method:'PATCH',url:urls.section.modify}}),Fields:$resource(urls.field.add,{confId:'@confId',sectionId:"@sectionId",fieldId:"@fieldId",confFormId:"@confFormId"},{"remove":{method:'DELETE',url:urls.field.modify},"enable":{method:'POST',url:urls.field.toggle,params:{enable:true}},"disable":{method:'POST',url:urls.field.toggle,params:{enable:false}},"move":{method:'POST',url:urls.field.move},"modify":{method:'PATCH',url:urls.field.modify}}),Labels:$resource(urls.text.add,{confId:'@confId',sectionId:"@sectionId",fieldId:"@fieldId",confFormId:"@confFormId"},{"remove":{method:'DELETE',url:urls.text.modify},"enable":{method:'POST',url:urls.text.toggle,params:{enable:true}},"disable":{method:'POST',url:urls.text.toggle,params:{enable:false}},"move":{method:'POST',url:urls.text.move},"modify":{method:'PATCH',url:urls.text.modify}})};});ndRegForm.directive('ndRegForm',function($rootScope,url,sortableoptions,regFormFactory){return{replace:true,templateUrl:url.tpl('registrationform.tpl.html'),scope:{confId:'@',confFormId:'@',confCurrency:'@',confSections:'@',eventStartDate:'@',eventEndDate:'@',userInfo:'@',registrationData:'@',registrationMetaData:'@',registrationUuid:'@',csrfToken:'&',editMode:'=',updateMode:'=',management:'=',notifyDefault:'=',postUrl:'=',checkEmailUrl:'=',isModerated:'='},controller:function($scope,$resource,$location,$anchorScroll){$scope.sections=angular.fromJson($scope.confSections);$scope.userInfo=angular.fromJson($scope.userInfo);$scope.registrationData=angular.fromJson($scope.registrationData);$scope.registrationMetaData=angular.fromJson($scope.registrationMetaData);$rootScope.confId=$scope.confId;$rootScope.confFormId=$scope.confFormId;$rootScope.eventStartDate=$scope.eventStartDate;$rootScope.eventEndDate=$scope.eventEndDate;$rootScope.editMode=$scope.editMode;$rootScope.notifyDefault=$scope.notifyDefault;$scope.csrfToken=$('#csrf-token').attr('content');$scope.dialogs={addsection:false,management:false,addsectionManagerOnly:false,error:false};$scope.actions={collapseAll:function(){$scope.$broadcast('collapse',true);},expandAll:function(){$scope.$broadcast('collapse',false);},openAddSection:function(managerOnly){$scope.dialogs[managerOnly?'addsectionManagerOnly':'addsection']=true;},openManagement:function(){$scope.dialogs.management=true;}};$scope.api={createSection:function(data,managerOnly){if(data.sectionCreationForm.$invalid===true){return false;}\u000aregFormFactory.Sections.save({confId:$scope.confId,title:data.newsection.title,description:data.newsection.description,is_manager_only:managerOnly,confFormId:$scope.confFormId},function(newsection){regFormFactory.processResponse(newsection,{success:function(newsection){$scope.sections.push(newsection);$scope.animations.section='section-highlight';$location.hash('section'+newsection.id);$anchorScroll();}});},handleAjaxError);return true;},moveSection:function(section,position){regFormFactory.Sections.move({confId:$scope.confId,sectionId:section.id,endPos:position,confFormId:$scope.confFormId},function(updatedSection){regFormFactory.processResponse(updatedSection,{success:function(updatedSection){section=updatedSection;}});},handleAjaxError);},restoreSection:function(section){regFormFactory.Sections.enable({confId:$rootScope.confId,sectionId:section.id,confFormId:$rootScope.confFormId},function(updatedSection){regFormFactory.processResponse(updatedSection,{success:function(updatedSection){var index=-1;_.find($scope.sections,function(section){index++;return section.id==updatedSection.id;});section.enabled=updatedSection.enabled;$scope.sections.splice(index,1);$scope.sections.push(section);}});},handleAjaxError);},removeSection:function(section){regFormFactory.Sections.remove({confId:$rootScope.confId,sectionId:section.id,confFormId:$rootScope.confFormId},{},function(data){regFormFactory.processResponse(data,{success:function(){$scope.sections=$scope.sections.filter(function(obj){return obj.id!==section.id;});}});},handleAjaxError);}};$scope.sectionSortableOptions={update:function(e,ui){$scope.api.moveSection(ui.item.scope().section,ui.item.index());},disabled:!$rootScope.editMode,handle:".regform-section .section-sortable-handle",placeholder:"regform-section-sortable-placeholder"};$scope.getTpl=function(file){return url.tpl(file);};angular.extend($scope.sectionSortableOptions,sortableoptions);},link:function(scope,element){scope.validationStarted=false;scope.currency=scope.confCurrency;scope.regMetadata={};scope.animations={recoverSectionButton:'',section:''};if(scope.editMode){scope.userdata={};}else if(!scope.updateMode){scope.userdata=_.extend({},scope.userInfo);}else{scope.userdata=_.extend({},scope.registrationData);scope.regMetadata=_.extend({},scope.registrationMetaData);}\u000aelement.on('submit',function(e){if(!scope.validate()){e.preventDefault();scope.dialogs.error=true;}else{$('#regformSubmit').prop('disabled',true);}});scope.validate=function(){scope.validationStarted=true;return scope.registrationForm.$valid;};}};});ndRegForm.directive('ndCurrency',function(url){return{restrict:'E',replace:true,templateUrl:url.tpl('currency.tpl.html')};});ndRegForm.directive('ndAddSectionDialog',function(url){return{require:'ndDialog',controller:function($scope){$scope.templateUrl=url.tpl('dialogs/sectioncreation.tpl.html');},link:function(scope){scope.actions.init=function(){scope.newsection={};};scope.actions.cleanup=function(){scope.newsection=undefined;};}};});ndRegForm.directive('ndSectionManagementDialog',function(url){return{require:'ndDialog',controller:function($scope){$scope.templateUrl=url.tpl('dialogs/sectionmanagement.tpl.html');},link:function(scope){scope.$watch('disabled.length',function(val){if(val===0){scope.show=false;}});}};});ndRegForm.directive('ndErrorDialog',function(url){return{require:'ndDialog',controller:function($scope){$scope.templateUrl=url.tpl('dialogs/errors.tpl.html');}};});ndRegForm.controller('SectionCtrl',function($scope,$rootScope,regFormFactory){$scope.sectionApi={};$scope.actions={};var getRequestParams=function(section){return{confId:$rootScope.confId,sectionId:section.id,confFormId:$rootScope.confFormId};};$scope.sectionApi.disableSection=function(section){$scope.$parent.animations.recoverSectionButton='button-highlight';regFormFactory.Sections.disable(getRequestParams(section),function(updatedSection){regFormFactory.processResponse(updatedSection,{success:function(updatedSection){section.enabled=updatedSection.enabled;}});},handleAjaxError);};$scope.sectionApi.saveConfig=function(section,data){var requestParams=angular.extend(getRequestParams(section),data);regFormFactory.Sections.save(requestParams,function(updatedSection){regFormFactory.processResponse(updatedSection,{success:function(updatedSection){$scope.section=angular.extend($scope.section,updatedSection);}});},handleAjaxError);};$scope.sectionApi.updateTitle=function(section,data){var requestParams=angular.extend(getRequestParams(section),{changes:data});regFormFactory.Sections.modify(requestParams,function(updatedSection){regFormFactory.processResponse(updatedSection,{success:function(updatedSection){$scope.section.title=updatedSection.title;}});},handleAjaxError);};$scope.sectionApi.updateDescription=function(section,data){var requestParams=angular.extend(getRequestParams(section),{changes:data});regFormFactory.Sections.modify(requestParams,function(updatedSection){regFormFactory.processResponse(updatedSection,{success:function(updatedSection){$scope.section.description=updatedSection.description;}});},handleAjaxError);};$scope.sectionApi.moveField=function(section,field,position){var requestParams=angular.extend(getRequestParams(section),{fieldId:field.id,endPos:position});regFormFactory[field.inputType=='label'?'Labels':'Fields'].move(requestParams,function(updatedSection){regFormFactory.processResponse(updatedSection,{success:function(updatedSection){}});},handleAjaxError);};$scope.sectionApi.removeField=function(section,field){$scope.dialogs.removefield.field=field;$scope.dialogs.removefield.callback=function(success){if(success){var requestParams=angular.extend(getRequestParams(section),{fieldId:field.id});$scope.$apply(regFormFactory[field.inputType=='label'?'Labels':'Fields'].remove(requestParams,{},function(updatedSection){regFormFactory.processResponse(updatedSection,{success:function(updatedSection){$scope.section.items=$scope.section.items.filter(function(obj){return obj.id!==field.id;});}});},handleAjaxError));}};$scope.dialogs.removefield.open=true;};$scope.actions.openAddField=function(section,fieldType){$scope.dialogs.newfield=true;var lastEnabledIndex=_.findLastIndex(section.items,function(item){return item.isEnabled;});section.items.splice(lastEnabledIndex+1,0,{id:-1,isEnabled:true,inputType:fieldType});};});ndRegForm.directive('ndSection',function($rootScope,url){return{replace:true,restrict:'E',templateUrl:url.tpl('section.tpl.html'),controller:'SectionCtrl',link:function(scope,element){scope.buttons={newfield:false,config:false,disable:false};scope.dialogs={newfield:false,config:{open:false,actions:{},formData:[]},removefield:{open:false}};scope.state={collapsed:false};scope.$on('collapse',function(event,collapsed){scope.state.collapsed=collapsed;});scope.$watch('state.collapsed',function(val){var content=angular.element(element.children()[2]);if(val){content.slideUp();}else{content.slideDown();}});scope.$watch('section.title',function(newVal,oldVal){if(newVal!==oldVal){scope.sectionApi.updateTitle(scope.section,{title:newVal});}});scope.$watch('section.description',function(newVal,oldVal){if(newVal!==oldVal){scope.sectionApi.updateDescription(scope.section,{description:newVal});}});scope.dialogs.config.actions.onOk=function(dialogScope){if(dialogScope.sectionForm.$invalid===true){return false;}\u000ascope.sectionApi.saveConfig(dialogScope.section,dialogScope.formData);return true;};scope.dialogs.config.actions.onCancel=function(dialogScope){};}};});ndRegForm.directive("ndGeneralSection",function($timeout,url,sortableoptions){return{require:'ndSection',controller:'SectionCtrl',link:function(scope){scope.buttons.newfield=true;scope.buttons.disable=!scope.section.isPersonalData;scope.tplGeneralField=url.tpl('sections/generalfield.tpl.html');scope.sectionApi.removeNewField=function(){$.each(scope.section.items,function(index,item){if(item.id===-1){$timeout(function(){scope.section.items.splice(index,1);},0);return false;}});};scope.fieldSortableOptions={update:function(e,ui){scope.sectionApi.moveField(scope.section,ui.item.scope().field,ui.item.index());},handle:".regform-field .field-sortable-handle",placeholder:"regform-field-sortable-placeholder"};angular.extend(scope.fieldSortableOptions,sortableoptions);}};});ndRegForm.directive('ndSectionDialog',function(url){return{require:'ndDialog',controller:function($scope){$scope.templateUrl=url.tpl('sections/dialogs/base.tpl.html');$scope.actions.init=function(){$scope.section=$scope.data;$scope.formData={};$scope.formData.items=[];_.each($scope.config.formData,function(item){if(Array.isArray(item)&&$scope.section[item[0]]!==undefined){$scope.formData[item[1]]=angular.copy($scope.section[item[0]][item[1]]);}else{$scope.formData[item]=angular.copy($scope.section[item]);}});_.each($scope.section.items,function(item,ind){$scope.formData.items[ind]=angular.copy(item);});$scope.tabSelected=$scope.config.tabs[0].id;};$scope.addItem=function(args){$scope.formData.items.push($.extend({id:'isNew',cancelled:false,pricePerPlace:false},args));};},link:function(scope){scope.getTabTpl=function(section_id,tab_type){return url.tpl('sections/dialogs/{0}-{1}.tpl.html'.format(section_id,tab_type));};}};});ndRegForm.filter('possibleDeparture',function(){return function(departure,scope){if(scope.accommodation.arrival!==undefined){var arrival=moment(scope.accommodation.arrival,'DD/MM/YYY');var possibleDepartures={};_.each(scope.section.departureDates,function(value,key){var departure=moment(key,'DD/MM/YYY');if(arrival.isBefore(departure)||arrival.isSame(departure)){possibleDepartures[key]=value;}});return possibleDepartures;}else{return scope.section.departureDates;}};});ndRegForm.controller('FieldCtrl',function($scope,regFormFactory){$scope.fieldApi={};$scope.getDefaultFieldSetting=regFormFactory.getDefaultFieldSetting;var getRequestParams=function(field){return{confId:$scope.confId,sectionId:$scope.section.id,fieldId:field.id,confFormId:$scope.confFormId};};$scope.fieldApi.disableField=function(field){regFormFactory[field.inputType==='label'?'Labels':'Fields'].disable(getRequestParams(field),function(updatedField){regFormFactory.processResponse(updatedField,{success:function(updatedField){var index=-1;_.find($scope.section.items,function(item){index++;return item.id===$scope.field.id;});$scope.field.isEnabled=updatedField.view_data.isEnabled;$scope.section.items.splice(index,1);$scope.section.items.push($scope.field);}});},handleAjaxError);};$scope.fieldApi.enableField=function(field){regFormFactory[field.inputType==='label'?'Labels':'Fields'].enable(getRequestParams(field),function(updatedField){regFormFactory.processResponse(updatedField,{success:function(updatedField){var lastEnabledIndex=_.findLastIndex($scope.section.items,function(item){return item.isEnabled;});var updatedFieldIndex=$scope.section.items.indexOf($scope.field);$scope.section.items.splice(updatedFieldIndex,1);$scope.field.isEnabled=updatedField.view_data.isEnabled;$scope.section.items.splice(lastEnabledIndex+1,0,$scope.field);}});},handleAjaxError);};$scope.fieldApi.removeField=function(field){$scope.sectionApi.removeField($scope.section,field);};$scope.fieldApi.updateField=function(field,data){var postData=angular.extend(getRequestParams(field),{fieldData:data});if($scope.isNew()){delete postData['fieldId'];}\u000aregFormFactory[field.inputType==='label'?'Labels':'Fields'][$scope.isNew()?'save':'modify'](postData,function(response){regFormFactory.processResponse(response,{success:function(response){$scope.field=angular.extend($scope.field,response.view_data);}});},handleAjaxError);};$scope.openFieldSettings=function(){$scope.dialog.open=true;};$scope.canBeDeleted=function(field){return!field.fieldIsPersonalData;};$scope.canBeDisabled=function(field){return!field.fieldIsRequired;};$scope.isNew=function(){return $scope.field.id===-1;};$scope.getNumberOfSlots=function(item){if(!item||!item.maxExtraSlots){return 0;}\u000areturn item.maxExtraSlots+1;};$scope.showExtraSlotsInput=function(item,userdata,itemChecked,placesLeft){var field=$scope.field,showExtraSlots=field.withExtraSlots&&item.maxExtraSlots&&itemChecked;if(!placesLeft&&itemChecked&&userdata&&userdata[item.id]===1){return false;}\u000areturn showExtraSlots;};$scope.settings={isBillable:false,date:false,defaultValue:false,singleColumn:false,itemtable:false,isRequired:true,number:false,placesLimit:false,rowsAndColumns:false,size:false,withExtraSlots:false,formData:['title','description','isRequired']};$scope.dialog={open:false,title:function(){return $scope.isNew()?$T('New Field'):$T('Edit Field');},okButton:function(){return $scope.isNew()?$T('Add'):$T('Update');},onOk:function(dialogScope){if(dialogScope.optionsForm.$invalid===true){dialogScope.$apply(dialogScope.setSelectedTab('tab-options'));return false;}\u000aif($.isFunction($scope.validateFieldSettings)&&!$scope.validateFieldSettings(dialogScope)){return false;}\u000a$scope.fieldApi.updateField($scope.field,dialogScope.formData);return true;},onCancel:function(){if($scope.isNew()){$scope.sectionApi.removeNewField();}}};var _checkEmailRemote=_.debounce(function _checkEmailRemote(email){$.ajax({url:$scope.checkEmailUrl,data:{email:email,update:$scope.updateMode?$scope.registrationUuid:null},error:handleAjaxError,success:function(data){var msg;var name=data.user?$('<span>',{text:data.user}).html():null;if(data.conflict=='email-already-registered'){msg=$T.gettext('There is already a registration with this email address.');}else if(data.conflict=='user-already-registered'){msg=$T.gettext('The user associated with this email address is already registered.');}else if(data.conflict=='no-user'){msg=$T.gettext('There is no Indico user associated with this email address.');}else if(data.status=='error'&&(data.conflict=='email-other-user'||data.conflict=='email-no-user')){msg=$T.gettext("This email address is not associated with your Indico account.");}else if(data.conflict=='email-other-user'){msg=$T.gettext("The registration will be re-associated to a different user (<strong>{0}</strong>).").format(name);}else if(data.conflict=='email-no-user'){msg=$T.gettext("The registration will be disassociated from the current user (<strong>{0}</strong>).").format(name);}else if(!data.user){msg=$T.gettext('The registration will not be associated with any Indico account.');}else if(data.self){msg=$T.gettext('The registration will be associated with your Indico account.');}else if(data.same){msg=$T.gettext('The registration will remain associated with the Indico account <strong>{0}</strong>.').format(name);}else{msg=$T.gettext('The registration will be associated with the Indico account <strong>{0}</strong>.').format(name);}\u000a$('#regformSubmit').prop('disabled',data.status=='error');$scope.emailInfoError=data.status=='error';$scope.emailInfoWarning=data.status=='warning';$scope.emailInfoMessage=msg;$scope.$apply();}});},250);function checkEmail(email){email=email.trim();if(email===$scope.checkedEmail){return;}\u000a$scope.emailInfoError=false;$scope.emailInfoWarning=false;$scope.emailInfoMessage=email?$T.gettext('Checking email address...'):'';$scope.checkedEmail=email;if(email){_checkEmailRemote(email);}}\u000a$scope.fieldName=$scope.field.htmlName;$scope.emailInfoMessage='';$scope.emailInfoError=false;$scope.emailInfoWarning=false;if($scope.field.htmlName=='email'&&!$scope.editMode){$('#registrationForm').on('change input','input[name=email]',_.debounce(function(){checkEmail($(this).val());$scope.$apply();},250));checkEmail($scope.userdata.email||'');}});ndRegForm.controller('BillableCtrl',function($scope,$filter){$scope.getBillableStr=function(item,uservalue){var str='';if($scope.changesPrice(item)){str+=' {0} {1}'.format(item.price,$scope.currency);}\u000aif($scope.hasPlacesLimit(item)){if($scope.hasPlacesLeft(item,uservalue)){str+=' [{0} {1}]'.format($scope.getPlacesLeft(item,uservalue),$filter('i18n')('place(s) left'));}else{str+=' [{0}]'.format($filter('i18n')('no places left'));}}\u000areturn str;};$scope.getPlacesLeft=function(item,uservalue,selectedvalue){var places=item.placesLimit;if($scope.field.inputType=='checkbox'||$scope.field.inputType=='bool'){places-=($scope.field.placesUsed||0);}else if($scope.field.inputType=='single_choice'||$scope.field.inputType=='accommodation'){places-=($scope.field.placesUsed[item.id]||0);}else if($scope.field.inputType=='multi_choice'){places-=($scope.field.placesUsed[item.id]||0);}\u000areturn places;};$scope.isDisabled=function(item,uservalue){item=item||{};return!$scope.hasPlacesLeft(item,uservalue)||!item.isEnabled;};$scope.hasPlacesLeft=function(item,uservalue){item=item||{};if(!$scope.hasPlacesLimit(item)){return true;}else{return $scope.getPlacesLeft(item,uservalue)>0;}};$scope.hasPlacesLimit=function(item){item=item||{};if(item.placesLimit!==undefined){return item.placesLimit!==0;}\u000areturn false;};$scope.paymentBlocked=function(item,userdata,registrationMetaData,validation){item=item||{};userdata=userdata||{};if(validation!==undefined){return($scope.changesPrice(item)&&registrationMetaData.paid)||validation(userdata);}else{return $scope.changesPrice(item)&&registrationMetaData.paid;}};$scope.hasBillableOptions=function(field){return!!_.find(field.choices,function(item){return item.isBillable&&item.price!==0;});};$scope.isVisible=function(field){return field.isEnabled&&!field.remove;};});ndRegForm.directive('ndField',function($rootScope,url,regFormFactory){return{restrict:'E',replace:true,templateUrl:url.tpl('field.tpl.html'),controller:'FieldCtrl',link:function(scope){scope.changesPrice=function(item){return item&&item.isBillable&&item.price!==0;};scope.$parent.$watch('dialogs.newfield',function(val){if(val&&scope.isNew()){scope.dialog.open=true;scope.$parent.dialogs.newfield=false;}\u000ascope.field.billableDisabled=(scope.regMetadata.paid&&(scope.field.isBillable&&scope.field.price>0))||(scope.selectedItemIsBillable&&scope.selectedItemIsBillable(scope.userdata,scope.regMetadata));});}};});ndRegForm.directive('ndCheckboxField',function(url){return{require:'ndField',controller:function($scope){$scope.tplInput=url.tpl('fields/checkbox.tpl.html');},link:function(scope){scope.checkboxValue=false;scope.settings.fieldName=$T("Checkbox");scope.settings.isBillable=true;scope.settings.singleColumn=true;scope.settings.placesLimit=true;scope.settings.formData.push('isBillable');scope.settings.formData.push('price');scope.settings.formData.push('placesLimit');scope.$watch('userdata[fieldName]',function(){scope.checkboxValue=scope.userdata[scope.fieldName];});}};});ndRegForm.directive('ndCountryField',function(url){return{require:'ndField',controller:function($scope){$scope.tplInput=url.tpl('fields/country.tpl.html');},link:function(scope){scope.settings.fieldName=$T("Country");}};});function splitDateTime(dt,fmt){if(!dt){return{date:'',time:null};}\u000avar dtObj=moment(dt),fmtParts=fmt.split(' ');return{date:dtObj.format(fmtParts[0]),time:fmtParts[1]?dtObj.format(fmtParts[1]):null};}\u000andRegForm.directive('ndDateField',function(url){return{require:'ndField',controller:function($scope){$scope.tplInput=url.tpl('fields/date.tpl.html');},link:function(scope){var fmt=scope.field.dateFormat||scope.getDefaultFieldSetting('defaultDateFormat');fmt=fmt.replace(/%([HMdmY])/g,function(match,c){return{H:'HH',M:'mm',d:'DD',m:'MM',Y:'YYYY'}[c];});scope.dateTime=splitDateTime(scope.userdata[scope.field.htmlName],fmt);scope.settings.fieldName=$T("Date");scope.settings.date=true;scope.settings.formData.push('displayFormats');scope.settings.formData.push('dateFormat');}};});ndRegForm.directive('ndFileField',function(url){return{require:'ndField',controller:function($scope){$scope.tplInput=url.tpl('fields/file.tpl.html');},link:function(scope){scope.settings.fieldName=$T("File");scope.removeAttachment=function(){delete scope.userdata[scope.field.htmlName];};}};});ndRegForm.directive('ndLabelField',function(url){return{require:'ndField',controller:function($scope){$scope.tplInput=url.tpl('fields/label.tpl.html');},link:function(scope){scope.settings.fieldName=$T("Free Text");scope.settings.singleColumn=true;scope.settings.isBillable=false;scope.settings.isRequired=false;}};});ndRegForm.directive('ndNumberField',function(url){return{require:'ndField',controller:function($scope){$scope.tplInput=url.tpl('fields/number.tpl.html');},link:function(scope){scope.settings.fieldName=$T("Number");scope.settings.isBillable=true;scope.settings.number=true;scope.settings.formData.push('isBillable');scope.settings.formData.push('price');scope.settings.formData.push('minValue');scope.settings.formData.push('length');scope.updateSubtotal=function(){var value=scope.userdata[scope.fieldName];if((isNaN(parseInt(value,10))||parseInt(value,10)<0)){scope.subtotal=0;}else{scope.subtotal=parseInt(value,10)*parseInt(scope.field.price,10);}};scope.$watch('userdata[fieldName]',function(){scope.updateSubtotal();});}};});var ndSelectController=function($scope){$scope.initFormData=function(formData,field){formData.choices=[];_.each(field.choices,function(item,ind){formData.choices[ind]=angular.copy(item);});};$scope.validateFieldSettings=function(dialogScope){if(!dialogScope.hasRadioItems()){dialogScope.setSelectedTab('tab-editItems');dialogScope.$apply();return false;}\u000avar settingsValid=true,choices=dialogScope.formData.choices.filter(function(item){return item.remove!==true;});settingsValid=settingsValid&&_.all(choices,function(item){return!!item.caption;});settingsValid=settingsValid&&_.all(choices,function(item){return/^(\u005cd*(\u005c.\u005cd{1,2})?)?$/.test(item.price);});settingsValid=settingsValid&&_.all(choices,function(item){return/^\u005cd*$/.test(item.placesLimit);});if(dialogScope.settings.withExtraSlots){settingsValid=settingsValid&&_.all(choices,function(item){return/^\u005cd*$/.test(item.maxExtraSlots);});}\u000aif(!settingsValid){dialogScope.settingsError=true;dialogScope.setSelectedTab('tab-editItems');dialogScope.$apply();return false;}\u000areturn true;};$scope.onSingleFieldItemChange=function(item){var valueElement=$('input[name={0}]'.format($scope.field.htmlName)),data={};if(item.id){data[item.id]=(+$('#extraSlotsSelect-{0}'.format(item.id)).val()+1)||1;}\u000avalueElement.val(JSON.stringify(data));};$scope.multiFieldItemChecked=function(event){var valueElement=$('input[name={0}]'.format($scope.field.htmlName)),data=JSON.parse(valueElement.val()||'{}'),target=$(event.target);if(!$scope.checkedIds){$scope.checkedIds=[];}\u000aif(target.prop('checked')){data[target.prop('id')]=(+$('#extraSlotsSelect-{0}'.format(target.prop('id'))).val())||1;$scope.checkedIds.push(target.prop('id'));}else{delete data[target.prop('id')];$scope.checkedIds.splice($scope.checkedIds.indexOf(target.prop('id')),1);}\u000aif($scope.checkedIds.length===0){delete $scope.checkedIds;}\u000avalueElement.val(JSON.stringify(data));};$scope.onExtraSlotsChanged=function(item,value){var valueElement=$('[name={0}]'.format($scope.field.htmlName)),data=JSON.parse(valueElement.val()||'{}');if(data[item.id]){data[item.id]=value;valueElement.val(JSON.stringify(data));}};$scope.selectedItemIsBillable=function(userdata,registrationMetaData){if(registrationMetaData.paid){var item=_.find($scope.field.choices,function(item){return userdata[$scope.field.htmlName]?!!userdata[$scope.field.htmlName][item.id]:false;})||{};return $scope.changesPrice(item);}\u000areturn false;};};ndRegForm.directive('ndRadioField',function(url){return{require:'ndField',controller:ndSelectController,link:function(scope){scope.settings.fieldName=$T("Choice");scope.tplInput=url.tpl('fields/radio.tpl.html');scope.settings.defaultValue=true;scope.settings.itemtable=true;scope.settings.withExtraSlots=true;scope.radioValue={};scope.$watch('userdata[fieldName]',function(){scope.radioValue.id=scope.getUserdataValue();});scope.getUserdataValue=function(){return scope.getId(scope.fieldName);};scope.getInputTpl=function(itemType){return url.tpl('fields/{0}.tpl.html'.format(itemType));};scope.getId=function(fieldName){if(!scope.userdata[fieldName]||scope.userdata[fieldName]===''){if(scope.field.defaultItem&&scope.field.captions){return scope.field.defaultItem;}else{return'';}}else{return _.keys(scope.userdata[fieldName])[0];}};scope.getChoiceValue=function(fieldName){if(scope.userdata[fieldName]){return scope.userdata[fieldName];}\u000avar val={};var key=scope.getId(fieldName);if(key){val[scope.getId(fieldName)]=1;}\u000areturn val;};scope.getSelectedItem=function(itemId){return _.find(scope.field.choices,function(item){return item.id==itemId;});};scope.settings.formData.push('defaultItem');scope.settings.formData.push('itemType');scope.settings.formData.push('withExtraSlots');scope.settings.editionTable={sortable:false,actions:['remove','sortable'],colNames:[$T("Caption"),$T("Billable"),$T("Price"),$T("Places limit"),$T("Max. extra slots"),$T("Extra slots pay"),$T("Enabled")],colModel:[{name:'caption',index:'caption',align:'center',width:160,editable:true,edittype:"text",editoptions:{size:"30",}},{name:'isBillable',index:'isBillable',width:50,editable:true,align:'center',defaultVal:false,edittype:'bool_select'},{name:'price',index:'price',align:'center',width:50,editable:true,edittype:'text',pattern:'/^(\u005c\u005cd+(\u005c\u005c.\u005c\u005cd{1,2})?)?$/',editoptions:{size:"7",maxlength:"20"}},{name:'placesLimit',index:'placesLimit',align:'center',width:50,editable:true,edittype:"text",pattern:'/^\u005c\u005cd*$/',editoptions:{size:"7",maxlength:"20"}},{name:'maxExtraSlots',index:'maxExtraSlots',align:'center',width:50,editable:true,edittype:"text",pattern:'/^\u005c\u005cd*$/',className:'extra-slots',editoptions:{size:"7",maxlength:"2"}},{name:'extraSlotsPay',index:'extraSlotsPay',align:'center',width:50,editable:true,edittype:"bool_select",className:'extra-slots',defaultVal:false},{name:'isEnabled',index:'isEnabled',width:50,editable:true,align:'center',edittype:'bool_select',defaultVal:true}]};}};});ndRegForm.directive('ndPhoneField',function(url){return{require:'ndField',controller:function($scope){$scope.tplInput=url.tpl('fields/phone.tpl.html');},link:function(scope){scope.settings.fieldName=$T("Phone");scope.settings.formData.push('length');}};});ndRegForm.directive('ndTextField',function(url){return{require:'ndField',controller:function($scope){$scope.tplInput=url.tpl('fields/text.tpl.html');},link:function(scope){scope.settings.fieldName=$T("Text");scope.settings.size=true;scope.settings.formData.push('length');}};});ndRegForm.directive('ndTextareaField',function(url){return{require:'ndField',controller:function($scope){$scope.tplInput=url.tpl('fields/textarea.tpl.html');},link:function(scope){scope.settings.fieldName=$T("Textarea");scope.settings.rowsAndColumns=true;scope.settings.formData.push('numberOfColumns');scope.settings.formData.push('numberOfRows');}};});ndRegForm.directive('ndBoolField',function(url){return{require:'ndField',controller:function($scope){$scope.tplInput=url.tpl('fields/bool.tpl.html');},link:function(scope){scope.settings.fieldName=$T("Yes/No");scope.settings.isBillable=true;scope.settings.placesLimit=true;scope.settings.defaultValues=[$T("yes"),$T("no")];scope.settings.formData.push('isBillable');scope.settings.formData.push('price');scope.settings.formData.push('placesLimit');scope.settings.formData.push('defaultValue');}};});ndRegForm.directive('ndEmailField',function(url){return{require:'ndField',controller:function($scope){$scope.tplInput=url.tpl('fields/email.tpl.html');},link:function(scope){scope.settings.fieldName=$T("Email address");}};});ndRegForm.directive('ndAccommodationField',function(url){return{require:'ndField',controller:function($scope){$scope.tplInput=url.tpl('fields/accommodation.tpl.html');$scope.areArrivalDatesValid=function(data){return moment(data['arrivalDateTo'],"DD/MM/YYYY").isAfter(moment(data['arrivalDateFrom'],"DD/MM/YYYY"));};$scope.areDepartureDatesValid=function(data){return moment(data['departureDateTo'],"DD/MM/YYYY").isAfter(moment(data['departureDateFrom'],"DD/MM/YYYY"));};$scope.areAccommodationOptionsDefined=function(data){var choices=data.choices.filter(function(item){return item.remove!==true&&!item.isNoAccommodation;});return choices.length!==0;};$scope.validateFieldSettings=function(dialogScope){var data=dialogScope.formData;if(!$scope.areArrivalDatesValid(data)){dialogScope.setSelectedTab('tab-accommodation');dialogScope.$apply();return false;}\u000aif(!$scope.areDepartureDatesValid(data)){dialogScope.setSelectedTab('tab-accommodation');dialogScope.$apply();return false;}\u000aif(!$scope.areAccommodationOptionsDefined(data)){dialogScope.setSelectedTab('tab-accommodation-options');dialogScope.$apply();return false;}\u000avar settingsValid=true,choices=dialogScope.formData.choices.filter(function(item){return item.remove!==true;});settingsValid=settingsValid&&_.all(choices,function(item){return!!item.caption;});settingsValid=settingsValid&&_.all(choices,function(item){return/^(\u005cd*(\u005c.\u005cd{1,2})?)?$/.test(item.price);});settingsValid=settingsValid&&_.all(choices,function(item){return/^\u005cd*$/.test(item.placesLimit);});if(!settingsValid){dialogScope.settingsError=true;dialogScope.setSelectedTab('tab-accommodation-options');dialogScope.$apply();return false;}\u000areturn true;};function formatDate(date){if(date){return moment(date).format('DD/MM/YYYY');}}\u000a$scope.initFormData=function(formData,field){var eventStartDate=$scope.eventStartDate,eventEndDate=$scope.eventEndDate;formData.choices=[];formData.arrivalDateFrom=formatDate(field.arrivalDateFrom)||moment(eventStartDate).subtract(2,'days').format('DD/MM/YYYY');formData.arrivalDateTo=formatDate(field.arrivalDateTo)||moment(eventEndDate).format('DD/MM/YYYY');formData.departureDateFrom=formatDate(field.departureDateFrom)||moment(eventStartDate).add(1,'days').format('DD/MM/YYYY');formData.departureDateTo=formatDate(field.departureDateTo)||moment(eventEndDate).add(3,'days').format('DD/MM/YYYY');_.each(field.choices,function(item,ind){formData.choices[ind]=angular.copy(item);});if(!field.choices){formData.choices.push({caption:'No accommodation',isBillable:false,isEnabled:true,isNoAccommodation:true,placesLimit:0,price:0,placeholder:$T('Title of the "None" option')});}};},link:function(scope){scope.settings.accommodationField=true;scope.settings.fieldName=$T("Accommodation");scope.accommodation={};scope.$watch('userdata[fieldName]',function(){var accUserData=scope.userdata[scope.field.htmlName];if(accUserData===undefined||accUserData.choice===null){return;}\u000ascope.accommodation.choice=accUserData.choice;scope.accommodation.arrivalDate=accUserData.arrivalDate;scope.accommodation.departureDate=accUserData.departureDate;});function updateAccommodationPostData(fieldName,value){var accommodationField=$('[name=field_{0}]'.format(scope.field.id)),accommodationData=accommodationField.val()?JSON.parse(accommodationField.val()):{};accommodationData[fieldName]=value;accommodationField.val(JSON.stringify(accommodationData));}\u000ascope.$watch('accommodation.arrivalDate',function(newValue){updateAccommodationPostData('arrivalDate',moment(newValue).format('YYYY-MM-DD'));});scope.$watch('accommodation.departureDate',function(newValue){updateAccommodationPostData('departureDate',moment(newValue).format('YYYY-MM-DD'));});scope.$watch('accommodation.choice',function(newValue){if(!newValue){$('#registrationForm input[name=field_{0}]'.format(scope.field.id)).val('{}');}else{updateAccommodationPostData('choice',newValue);updateAccommodationPostData('isNoAccommodation',scope.isNoAccommodationChoice(newValue,scope.field));}});scope.isNoAccommodationChoice=function(choice,field){return!!_.find(field.choices,function(c){return c.id===choice&&c.isNoAccommodation;});};scope.billableOptionPayed=function(userdata,registrationMetaData){if(userdata[scope.field.htmlName]!==undefined){var choice=_.find(scope.field.choices,function(choice){return userdata[scope.field.htmlName].choice==choice.id;});return choice&&choice.isBillable&&registrationMetaData.paid;}\u000areturn false;};scope.possibleDeparture=function(departure){if(scope.arrival!==undefined){var arrival=moment(scope.arrival,'DD/MM/YYY');departure=moment(departure[0],'DD/MM/YYY');return arrival.isBefore(departure);}\u000areturn true;};scope.settings.formData.push('arrivalDateFrom');scope.settings.formData.push('arrivalDateTo');scope.settings.formData.push('departureDateFrom');scope.settings.formData.push('departureDateTo');scope.settings.formData.push('choices');scope.settings.isRequired=false;scope.settings.editionTable={sortable:false,colNames:[$T("Accommodation option"),$T("Billable"),$T("Price"),$T("Places limit"),$T("Enabled")],actions:['remove'],colModel:[{name:'caption',index:'caption',align:'center',width:100,editoptions:{size:"30"},editable:true,edittype:"text"},{name:'isBillable',index:'isBillable',width:60,editable:true,align:'center',edittype:'bool_select',defaultVal:true},{name:'price',index:'price',align:'center',width:50,editable:true,edittype:"text",pattern:'/^(\u005c\u005cd+(\u005c\u005c.\u005c\u005cd{1,2})?)?$/',editoptions:{size:"7",maxlength:"20"}},{name:'placesLimit',index:'placesLimit',align:'center',width:80,editable:true,edittype:"text",pattern:'/^\u005c\u005cd*$/',editoptions:{size:"7",maxlength:"20"}},{name:'isEnabled',index:'isEnabled',width:60,editable:true,align:'center',defaultVal:false,edittype:'bool_select'}]};}};});ndRegForm.directive('ndMultiChoiceField',function(url){return{require:'ndField',controller:ndSelectController,link:function(scope){scope.tplInput=url.tpl('fields/multi_choice.tpl.html');scope.settings.fieldName=$T("Multi choice");scope.settings.itemtable=true;scope.settings.withExtraSlots=true;if(scope.userdata[scope.fieldName]){scope.checkedIds=_.keys(scope.userdata[scope.fieldName]);}\u000ascope.settings.editionTable={sortable:false,actions:['remove','sortable'],colNames:[$T("Caption"),$T("Billable"),$T("Price"),$T("Places limit"),$T("Max. extra slots"),$T("Extra slots pay"),$T("Enabled")],colModel:[{name:'caption',index:'caption',align:'center',width:160,editable:true,edittype:'text',editoptions:{size:'30'}},{name:'isBillable',index:'isBillable',width:50,editable:true,align:'center',defaultVal:false,edittype:'bool_select'},{name:'price',index:'price',align:'center',width:50,editable:true,edittype:'text',pattern:'/^(\u005c\u005cd+(\u005c\u005c.\u005c\u005cd{1,2})?)?$/',editoptions:{size:'7',maxlength:'20'}},{name:'placesLimit',index:'placesLimit',align:'center',width:50,editable:true,edittype:'text',pattern:'/^\u005c\u005cd*$/',editoptions:{size:'7',maxlength:'20'}},{name:'maxExtraSlots',index:'maxExtraSlots',align:'center',width:50,editable:true,edittype:'text',pattern:'/^\u005c\u005cd*$/',className:'extra-slots',editoptions:{size:'7',maxlength:'2'}},{name:'extraSlotsPay',index:'extraSlotsPay',align:'center',width:50,editable:true,edittype:'bool_select',className:'extra-slots',defaultVal:false},{name:'isEnabled',index:'isEnabled',width:50,editable:true,align:'center',edittype:'bool_select',defaultVal:true}]};scope.settings.formData.push('withExtraSlots');}};});ndRegForm.directive('ndFieldDialog',function(url){return{require:'ndDialog',controller:function($scope){$scope.templateUrl=url.tpl('fields/dialogs/base.tpl.html');$scope.actions.init=function(){$scope.field=$scope.data;$scope.settings=$scope.config;$scope.formData={};$scope.formData.inputType=$scope.field.inputType;$scope.formData.isEnabled=$scope.field.isEnabled;$scope.formData.withExtraSlots=$scope.field.withExtraSlots;_.each($scope.settings.formData,function(item){if(Array.isArray(item)&&$scope.field[item[0]]!==undefined){$scope.formData[item[1]]=angular.copy($scope.field[item[0]][item[1]]);}else{$scope.formData[item]=angular.copy($scope.field[item]);}});if($.isFunction($scope.$parent.initFormData)){$scope.$parent.initFormData($scope.formData,$scope.field);}\u000a$scope.toggleExtraSlotsColumns($scope.formData.withExtraSlots);$scope.tabSelected="tab-options";$scope.parsePrice();};$scope.parsePrice=function(){if($scope.formData.price!==undefined){$scope.formData.price=parseFloat($scope.formData.price);if(isNaN($scope.formData.price)){$scope.formData.price=0;}}};$scope.addItem=function(){$scope.formData.choices.push({placesLimit:0,price:0,isEnabled:true,isBillable:false,maxExtraSlots:0});$scope.toggleExtraSlotsColumns($scope.formData.withExtraSlots);};$scope.addAccommodationOption=function(){$scope.formData.choices.push({isEnabled:true,price:0,placesLimit:0});};$scope.sortItems=function(){$scope.formData.choices=_.sortBy($scope.formData.choices,function(radioitem){return radioitem.caption.toLowerCase();});};$scope.toggleExtraSlotsColumns=function(value){if(!!value){$('.regform-table .extra-slots').show();}else{_.delay(function(){$('.regform-table .extra-slots').hide();},500);}};$scope.$watch('formData.withExtraSlots',function(newValue){$scope.toggleExtraSlotsColumns(newValue);});},link:function(scope){scope.getTpl=function(file){return url.tpl(file);};scope.hasRadioItems=function(){return _.any(scope.formData.choices,function(item){return item.remove!==true;});};scope.arrivalDatesValid=function(){return scope.$parent.areArrivalDatesValid(scope.formData);};scope.departureDatesValid=function(){return scope.$parent.areDepartureDatesValid(scope.formData);};scope.hasAccommodationOptions=function(){return scope.$parent.areAccommodationOptionsDefined(scope.formData);};}};});ndRegForm.directive("ndSectionToolbar",function(url){return{replace:true,templateUrl:url.tpl('sectiontoolbar.tpl.html'),controller:'SectionCtrl',scope:{section:'=',buttons:'=',dialogs:'=',fieldtypes:'=',state:'='},link:function(scope){scope.openConfig=function(){scope.dialogs.config.open=true;};scope.toggleCollapse=function(e){scope.state.collapsed=!scope.state.collapsed;};}};});ndRegForm.directive('ndFieldPicker',function($http,$compile,$templateCache,url){return{link:function(scope,element){$http.get(url.tpl('fieldpicker.tpl.html'),{cache:$templateCache}).success(function(template){var content=$compile(template)(scope);element.qtip({content:{title:{text:$T('Add new field')},text:content},position:{my:'top center',at:'bottom center'},show:{event:'click',solo:true,modal:{on:true}},hide:{event:'unfocus click',fixed:true},style:{classes:'add-field-qtip',name:'light'},events:{render:function(event,api){$(api.elements.content).on('click','a',function(){api.hide();});}}});});}};});ndRegForm.directive("ndTable",function(url,sortableoptions){return{restrict:'E',replace:true,templateUrl:url.tpl('table.tpl.html'),scope:{config:"=",formData:"=",filter:"=",filterValue:"=",validationStarted:"="},controller:function($scope){$scope.actionIsArray=function(action){return _.isArray(action);};$scope.actionItem=function(item,action){if(action=="remove"){item["remove"]=true;}else if(action=="cancel"){item["cancelled"]=true;}else if(action=="uncancel"){item["cancelled"]=false;}};$scope.isSortable=function(){return $scope.config.actions.indexOf('sortable')!=-1;};$scope.matchFilter=function(item){if(item.remove===true){return false;}else if($scope.filter!==undefined&&$scope.filterValue!==undefined){return item[$scope.filter]===$scope.filterValue;}else if(!item.id){return true;}else{return true;}};$scope.itemSortableOptions={helper:function(e,tr){var $originals=tr.children();var $helper=tr.clone();$helper.children().each(function(index){$(this).width($originals.eq(index).width());});return $helper;},containment:'parent',disabled:!$scope.isSortable(),handle:".table-sortable-handle",placeholder:"regform-table-sortable-placeholder"};angular.extend($scope.itemSortableOptions,sortableoptions);}};});
p1
.