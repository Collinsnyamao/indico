V(function(root){var serverSide=typeof module!=='undefined'&&module.exports;var getnlp=function(){if(!getnlp._nlp){if(serverSide){getnlp._nlp=require('./nlp')}else if(!(getnlp._nlp=root._RRuleNLP)){throw new Error('You need to include rrule/nlp.js for fromText/toText to work.')}}\u000areturn getnlp._nlp;};var dateutil={MONTH_DAYS:[31,28,31,30,31,30,31,31,30,31,30,31],ONE_DAY:1000*60*60*24,MAXYEAR:9999,ORDINAL_BASE:new Date(1970,0,1),PY_WEEKDAYS:[6,0,1,2,3,4,5],getYearDay:function(date){var dateNoTime=new Date(date.getFullYear(),date.getMonth(),date.getDate());return Math.ceil((dateNoTime-new Date(date.getFullYear(),0,1))/dateutil.ONE_DAY)+1;},isLeapYear:function(year){if(year instanceof Date){year=year.getFullYear();}\u000areturn((year%4===0)&&(year%100!==0))||(year%400===0);},tzOffset:function(date){return date.getTimezoneOffset()*60*1000},daysBetween:function(date1,date2){var date1_ms=date1.getTime()-dateutil.tzOffset(date1);var date2_ms=date2.getTime()-dateutil.tzOffset(date2);var difference_ms=Math.abs(date1_ms-date2_ms);return Math.round(difference_ms/dateutil.ONE_DAY);},toOrdinal:function(date){return dateutil.daysBetween(date,dateutil.ORDINAL_BASE);},fromOrdinal:function(ordinal){var millisecsFromBase=ordinal*dateutil.ONE_DAY;return new Date(dateutil.ORDINAL_BASE.getTime()\u000a-dateutil.tzOffset(dateutil.ORDINAL_BASE)\u000a+millisecsFromBase\u000a+dateutil.tzOffset(new Date(millisecsFromBase)));},monthRange:function(year,month){var date=new Date(year,month,1);return[dateutil.getWeekday(date),dateutil.getMonthDays(date)];},getMonthDays:function(date){var month=date.getMonth();return month==1&&dateutil.isLeapYear(date)?29:dateutil.MONTH_DAYS[month];},getWeekday:function(date){return dateutil.PY_WEEKDAYS[date.getDay()];},combine:function(date,time){time=time||date;return new Date(date.getFullYear(),date.getMonth(),date.getDate(),time.getHours(),time.getMinutes(),time.getSeconds());},clone:function(date){var dolly=new Date(date.getTime());dolly.setMilliseconds(0);return dolly;},cloneDates:function(dates){var clones=[];for(var i=0;i<dates.length;i++){clones.push(dateutil.clone(dates[i]));}\u000areturn clones;},sort:function(dates){dates.sort(function(a,b){return a.getTime()-b.getTime();});},timeToUntilString:function(time){var date=new Date(time);var comp,comps=[date.getUTCFullYear(),date.getUTCMonth()+1,date.getUTCDate(),'T',date.getUTCHours(),date.getUTCMinutes(),date.getUTCSeconds(),'Z'];for(var i=0;i<comps.length;i++){comp=comps[i];if(!/[TZ]/.test(comp)&&comp<10){comps[i]='0'+String(comp);}}\u000areturn comps.join('');},untilStringToDate:function(until){var re=/^(\u005cd{4})(\u005cd{2})(\u005cd{2})(T(\u005cd{2})(\u005cd{2})(\u005cd{2})Z)?$/;var bits=re.exec(until);if(!bits){throw new Error('Invalid UNTIL value: '+until)}\u000areturn new Date(Date.UTC(bits[1],bits[2]-1,bits[3],bits[5]||0,bits[6]||0,bits[7]||0));}};dateutil.Time=function(hour,minute,second){this.hour=hour;this.minute=minute;this.second=second;};dateutil.Time.prototype={getHours:function(){return this.hour;},getMinutes:function(){return this.minute;},getSeconds:function(){return this.second;},getTime:function(){return((this.hour*60*60)\u000a+(this.minute*60)\u000a+this.second)*1000;}};var range=function(start,end){if(arguments.length===1){end=start;start=0;}\u000avar rang=[];for(var i=start;i<end;i++){rang.push(i);}\u000areturn rang;};var repeat=function(value,times){var i=0,array=[];if(value instanceof Array){for(;i<times;i++){array[i]=[].concat(value);}}else{for(;i<times;i++){array[i]=value;}}\u000areturn array;};var pymod=function(a,b){var r=a%b;return(r*b<0)?r+b:r;};var divmod=function(a,b){return{div:Math.floor(a/b),mod:pymod(a,b)};};var plb=function(obj){return(obj instanceof Array&&obj.length==0)?false:Boolean(obj);};var contains=function(arr,val){return arr.indexOf(val)!=-1;};var M365MASK=[].concat(repeat(1,31),repeat(2,28),repeat(3,31),repeat(4,30),repeat(5,31),repeat(6,30),repeat(7,31),repeat(8,31),repeat(9,30),repeat(10,31),repeat(11,30),repeat(12,31),repeat(1,7));var M366MASK=[].concat(repeat(1,31),repeat(2,29),repeat(3,31),repeat(4,30),repeat(5,31),repeat(6,30),repeat(7,31),repeat(8,31),repeat(9,30),repeat(10,31),repeat(11,30),repeat(12,31),repeat(1,7));var\u000aM28=range(1,29),M29=range(1,30),M30=range(1,31),M31=range(1,32);var MDAY366MASK=[].concat(M31,M29,M31,M30,M31,M30,M31,M31,M30,M31,M30,M31,M31.slice(0,7));var MDAY365MASK=[].concat(M31,M28,M31,M30,M31,M30,M31,M31,M30,M31,M30,M31,M31.slice(0,7));M28=range(-28,0);M29=range(-29,0);M30=range(-30,0);M31=range(-31,0);var NMDAY366MASK=[].concat(M31,M29,M31,M30,M31,M30,M31,M31,M30,M31,M30,M31,M31.slice(0,7));var NMDAY365MASK=[].concat(M31,M28,M31,M30,M31,M30,M31,M31,M30,M31,M30,M31,M31.slice(0,7));var M366RANGE=[0,31,60,91,121,152,182,213,244,274,305,335,366];var M365RANGE=[0,31,59,90,120,151,181,212,243,273,304,334,365];var WDAYMASK=(function(){for(var wdaymask=[],i=0;i<55;i++){wdaymask=wdaymask.concat(range(7));}\u000areturn wdaymask;}());var Weekday=function(weekday,n){if(n===0){throw new Error('Can\u005c't create weekday with n == 0');}\u000athis.weekday=weekday;this.n=n;};Weekday.prototype={nth:function(n){return this.n==n?this:new Weekday(this.weekday,n);},equals:function(other){return this.weekday==other.weekday&&this.n==other.n;},toString:function(){var s=['MO','TU','WE','TH','FR','SA','SU'][this.weekday];if(this.n){s=(this.n>0?'+':'')+String(this.n)+s;}\u000areturn s;},getJsWeekday:function(){return this.weekday==6?0:this.weekday+1;}};var RRule=function(options,noCache){this._string=null;options=options||{};this._cache=noCache?null:{all:false,before:[],after:[],between:[]};this.origOptions={};var invalid=[],keys=Object.keys(options),defaultKeys=Object.keys(RRule.DEFAULT_OPTIONS);keys.forEach(function(key){this.origOptions[key]=options[key];if(!contains(defaultKeys,key))invalid.push(key);},this);if(invalid.length){throw new Error('Invalid options: '+invalid.join(', '))}\u000aif(!RRule.FREQUENCIES[options.freq]&&options.byeaster===null){throw new Error('Invalid frequency: '+String(options.freq))}\u000adefaultKeys.forEach(function(key){if(!contains(keys,key))options[key]=RRule.DEFAULT_OPTIONS[key];});var opts=this.options=options;if(opts.byeaster!==null){opts.freq=RRule.YEARLY;}\u000aif(!opts.dtstart){opts.dtstart=new Date();opts.dtstart.setMilliseconds(0);}\u000aif(opts.wkst===null){opts.wkst=RRule.MO.weekday;}else if(typeof opts.wkst=='number'){}else{opts.wkst=opts.wkst.weekday;}\u000aif(opts.bysetpos!==null){if(typeof opts.bysetpos=='number'){opts.bysetpos=[opts.bysetpos];}\u000afor(var i=0;i<opts.bysetpos.length;i++){var v=opts.bysetpos[i];if(v==0||!(-366<=v&&v<=366)){throw new Error('bysetpos must be between 1 and 366,'+' or between -366 and -1');}}}\u000aif(!(plb(opts.byweekno)||plb(opts.byyearday)||plb(opts.bymonthday)||opts.byweekday!==null||opts.byeaster!==null))\u000a{switch(opts.freq){case RRule.YEARLY:if(!opts.bymonth){opts.bymonth=opts.dtstart.getMonth()+1;}\u000aopts.bymonthday=opts.dtstart.getDate();break;case RRule.MONTHLY:opts.bymonthday=opts.dtstart.getDate();break;case RRule.WEEKLY:opts.byweekday=dateutil.getWeekday(opts.dtstart);break;}}\u000aif(opts.bymonth!==null&&!(opts.bymonth instanceof Array)){opts.bymonth=[opts.bymonth];}\u000aif(opts.byyearday!==null&&!(opts.byyearday instanceof Array)){opts.byyearday=[opts.byyearday];}\u000aif(opts.bymonthday===null){opts.bymonthday=[];opts.bynmonthday=[];}else if(opts.bymonthday instanceof Array){var bymonthday=[],bynmonthday=[];for(i=0;i<opts.bymonthday.length;i++){var v=opts.bymonthday[i];if(v>0){bymonthday.push(v);}else if(v<0){bynmonthday.push(v);}}\u000aopts.bymonthday=bymonthday;opts.bynmonthday=bynmonthday;}else{if(opts.bymonthday<0){opts.bynmonthday=[opts.bymonthday];opts.bymonthday=[];}else{opts.bynmonthday=[];opts.bymonthday=[opts.bymonthday];}}\u000aif(opts.byweekno!==null&&!(opts.byweekno instanceof Array)){opts.byweekno=[opts.byweekno];}\u000aif(opts.byweekday===null){opts.bynweekday=null;}else if(typeof opts.byweekday=='number'){opts.byweekday=[opts.byweekday];opts.bynweekday=null;}else if(opts.byweekday instanceof Weekday){if(!opts.byweekday.n||opts.freq>RRule.MONTHLY){opts.byweekday=[opts.byweekday.weekday];opts.bynweekday=null;}else{opts.bynweekday=[[opts.byweekday.weekday,opts.byweekday.n]];opts.byweekday=null;}}else{var byweekday=[],bynweekday=[];for(i=0;i<opts.byweekday.length;i++){var wday=opts.byweekday[i];if(typeof wday=='number'){byweekday.push(wday);}else if(!wday.n||opts.freq>RRule.MONTHLY){byweekday.push(wday.weekday);}else{bynweekday.push([wday.weekday,wday.n]);}}\u000aopts.byweekday=plb(byweekday)?byweekday:null;opts.bynweekday=plb(bynweekday)?bynweekday:null;}\u000aif(opts.byhour===null){opts.byhour=(opts.freq<RRule.HOURLY)?[opts.dtstart.getHours()]:null;}else if(typeof opts.byhour=='number'){opts.byhour=[opts.byhour];}\u000aif(opts.byminute===null){opts.byminute=(opts.freq<RRule.MINUTELY)?[opts.dtstart.getMinutes()]:null;}else if(typeof opts.byminute=='number'){opts.byminute=[opts.byminute];}\u000aif(opts.bysecond===null){opts.bysecond=(opts.freq<RRule.SECONDLY)?[opts.dtstart.getSeconds()]:null;}else if(typeof opts.bysecond=='number'){opts.bysecond=[opts.bysecond];}\u000aif(opts.freq>=RRule.HOURLY){this.timeset=null;}else{this.timeset=[];for(i=0;i<opts.byhour.length;i++){var hour=opts.byhour[i];for(var j=0;j<opts.byminute.length;j++){var minute=opts.byminute[j];for(var k=0;k<opts.bysecond.length;k++){var second=opts.bysecond[k];this.timeset.push(new dateutil.Time(hour,minute,second));}}}\u000adateutil.sort(this.timeset);}};RRule.FREQUENCIES=['YEARLY','MONTHLY','WEEKLY','DAILY','HOURLY','MINUTELY','SECONDLY'];RRule.YEARLY=0;RRule.MONTHLY=1;RRule.WEEKLY=2;RRule.DAILY=3;RRule.HOURLY=4;RRule.MINUTELY=5;RRule.SECONDLY=6;RRule.MO=new Weekday(0);RRule.TU=new Weekday(1);RRule.WE=new Weekday(2);RRule.TH=new Weekday(3);RRule.FR=new Weekday(4);RRule.SA=new Weekday(5);RRule.SU=new Weekday(6);RRule.DEFAULT_OPTIONS={freq:null,dtstart:null,interval:1,wkst:RRule.MO,count:null,until:null,bysetpos:null,bymonth:null,bymonthday:null,byyearday:null,byweekno:null,byweekday:null,byhour:null,byminute:null,bysecond:null,byeaster:null};RRule.parseText=function(text,language){return getnlp().parseText(text,language)};RRule.fromText=function(text,language){return getnlp().fromText(text,language)};RRule.optionsToString=function(options){var key,keys,defaultKeys,value,strValues,pairs=[];keys=Object.keys(options);defaultKeys=Object.keys(RRule.DEFAULT_OPTIONS);for(var i=0;i<keys.length;i++){if(!contains(defaultKeys,keys[i]))continue;key=keys[i].toUpperCase();value=options[keys[i]];strValues=[];if(value===null||value instanceof Array&&!value.length){continue;}\u000aswitch(key){case'FREQ':value=RRule.FREQUENCIES[options.freq];break;case'WKST':value=value.toString();break;case'BYWEEKDAY':key='BYDAY';if(!(value instanceof Array)){value=[value];}\u000afor(var wday,j=0;j<value.length;j++){wday=value[j];if(wday instanceof Weekday){}else if(wday instanceof Array){wday=new Weekday(wday[0],wday[1]);}else{wday=new Weekday(wday);}\u000astrValues[j]=wday.toString();}\u000avalue=strValues;break;case'DTSTART':case'UNTIL':value=dateutil.timeToUntilString(value);break;default:if(value instanceof Array){for(var j=0;j<value.length;j++){strValues[j]=String(value[j]);}\u000avalue=strValues;}else{value=String(value);}}\u000apairs.push([key,value]);}\u000avar strings=[];for(var i=0;i<pairs.length;i++){var attr=pairs[i];strings.push(attr[0]+'='+attr[1].toString());}\u000areturn strings.join(';');};RRule.prototype={all:function(iterator){if(iterator){return this._iter(new CallbackIterResult('all',{},iterator));}else{var result=this._cacheGet('all');if(result===false){result=this._iter(new IterResult('all',{}));this._cacheAdd('all',result);}\u000areturn result;}},between:function(after,before,inc,iterator){var args={before:before,after:after,inc:inc}\u000aif(iterator){return this._iter(new CallbackIterResult('between',args,iterator));}else{var result=this._cacheGet('between',args);if(result===false){result=this._iter(new IterResult('between',args));this._cacheAdd('between',result,args);}\u000areturn result;}},before:function(dt,inc){var args={dt:dt,inc:inc},result=this._cacheGet('before',args);if(result===false){result=this._iter(new IterResult('before',args));this._cacheAdd('before',result,args);}\u000areturn result;},after:function(dt,inc){var args={dt:dt,inc:inc},result=this._cacheGet('after',args);if(result===false){result=this._iter(new IterResult('after',args));this._cacheAdd('after',result,args);}\u000areturn result;},count:function(){return this.all().length;},toString:function(){return RRule.optionsToString(this.origOptions);},toText:function(gettext,language){return getnlp().toText(this,gettext,language);},isFullyConvertibleToText:function(){return getnlp().isFullyConvertible(this)},_cacheAdd:function(what,value,args){if(!this._cache)return;if(value){value=(value instanceof Date)?dateutil.clone(value):dateutil.cloneDates(value);}\u000aif(what=='all'){this._cache.all=value;}else{args._value=value;this._cache[what].push(args);}},_cacheGet:function(what,args){if(!this._cache){return false;}\u000avar cached=false;if(what=='all'){cached=this._cache.all;}else{loopItems:for(var item,i=0;i<this._cache[what].length;i++){item=this._cache[what][i];for(var k in args){if(args.hasOwnProperty(k)&&String(args[k])!=String(item[k])){continue loopItems;}}\u000acached=item._value;break;}}\u000aif(!cached&&this._cache.all){var iterResult=new IterResult(what,args);for(var i=0;i<this._cache.all.length;i++){if(!iterResult.accept(this._cache.all[i])){break;}}\u000acached=iterResult.getValue();this._cacheAdd(what,cached,args);}\u000areturn cached instanceof Array?dateutil.cloneDates(cached):(cached instanceof Date?dateutil.clone(cached):cached);},clone:function(){return new RRule(this.origOptions);},_iter:function(iterResult){var dtstart=this.options.dtstart;var\u000ayear=dtstart.getFullYear(),month=dtstart.getMonth()+1,day=dtstart.getDate(),hour=dtstart.getHours(),minute=dtstart.getMinutes(),second=dtstart.getSeconds(),weekday=dateutil.getWeekday(dtstart),yearday=dateutil.getYearDay(dtstart);var\u000afreq=this.options.freq,interval=this.options.interval,wkst=this.options.wkst,until=this.options.until,bymonth=this.options.bymonth,byweekno=this.options.byweekno,byyearday=this.options.byyearday,byweekday=this.options.byweekday,byeaster=this.options.byeaster,bymonthday=this.options.bymonthday,bynmonthday=this.options.bynmonthday,bysetpos=this.options.bysetpos,byhour=this.options.byhour,byminute=this.options.byminute,bysecond=this.options.bysecond;var ii=new Iterinfo(this);ii.rebuild(year,month);var getdayset={};getdayset[RRule.YEARLY]=ii.ydayset;getdayset[RRule.MONTHLY]=ii.mdayset;getdayset[RRule.WEEKLY]=ii.wdayset;getdayset[RRule.DAILY]=ii.ddayset;getdayset[RRule.HOURLY]=ii.ddayset;getdayset[RRule.MINUTELY]=ii.ddayset;getdayset[RRule.SECONDLY]=ii.ddayset;getdayset=getdayset[freq];var timeset;if(freq<RRule.HOURLY){timeset=this.timeset;}else{var gettimeset={};gettimeset[RRule.HOURLY]=ii.htimeset;gettimeset[RRule.MINUTELY]=ii.mtimeset;gettimeset[RRule.SECONDLY]=ii.stimeset;gettimeset=gettimeset[freq];if((freq>=RRule.HOURLY&&plb(byhour)&&!contains(byhour,hour))||(freq>=RRule.MINUTELY&&plb(byminute)&&!contains(byminute,minute))||(freq>=RRule.SECONDLY&&plb(bysecond)&&!contains(bysecond,minute)))\u000a{timeset=[];}else{timeset=gettimeset.call(ii,hour,minute,second);}}\u000avar filtered,total=0,count=this.options.count;var iterNo=0;var i,j,k,dm,div,mod,tmp,pos,dayset,start,end,fixday;while(true){tmp=getdayset.call(ii,year,month,day);dayset=tmp[0];start=tmp[1];end=tmp[2];filtered=false;for(j=start;j<end;j++){i=dayset[j];if((plb(bymonth)&&!contains(bymonth,ii.mmask[i]))||(plb(byweekno)&&!ii.wnomask[i])||(plb(byweekday)&&!contains(byweekday,ii.wdaymask[i]))||(plb(ii.nwdaymask)&&!ii.nwdaymask[i])||(byeaster!==null&&!contains(ii.eastermask,i))||((plb(bymonthday)||plb(bynmonthday))&&!contains(bymonthday,ii.mdaymask[i])&&!contains(bynmonthday,ii.nmdaymask[i]))||(plb(byyearday)&&((i<ii.yearlen&&!contains(byyearday,i+1)&&!contains(byyearday,-ii.yearlen+i))||(i>=ii.yearlen&&!contains(byyearday,i+1-ii.yearlen)&&!contains(byyearday,-ii.nextyearlen+i-ii.yearlen)))))\u000a{dayset[i]=null;filtered=true;}}\u000aif(plb(bysetpos)&&plb(timeset)){var daypos,timepos,poslist=[];for(i,j=0;j<bysetpos.length;j++){var pos=bysetpos[j];if(pos<0){daypos=Math.floor(pos/timeset.length);timepos=pymod(pos,timeset.length);}else{daypos=Math.floor((pos-1)/timeset.length);timepos=pymod((pos-1),timeset.length);}\u000atry{tmp=[];for(k=start;k<end;k++){var val=dayset[k];if(val===null){continue;}\u000atmp.push(val);}\u000aif(daypos<0){i=tmp.slice(daypos)[0];}else{i=tmp[daypos];}\u000avar time=timeset[timepos];var date=dateutil.fromOrdinal(ii.yearordinal+i);var res=dateutil.combine(date,time);if(!contains(poslist,res)){poslist.push(res);}}catch(e){}}\u000adateutil.sort(poslist);for(j=0;j<poslist.length;j++){var res=poslist[j];if(until&&res>until){this._len=total;return iterResult.getValue();}else if(res>=dtstart){++total;if(!iterResult.accept(res)){return iterResult.getValue();}\u000aif(count){--count;if(!count){this._len=total;return iterResult.getValue();}}}}}else{for(j=start;j<end;j++){i=dayset[j];if(i!==null){var date=dateutil.fromOrdinal(ii.yearordinal+i);for(k=0;k<timeset.length;k++){var time=timeset[k];var res=dateutil.combine(date,time);if(until&&res>until){this._len=total;return iterResult.getValue();}else if(res>=dtstart){++total;if(!iterResult.accept(res)){return iterResult.getValue();}\u000aif(count){--count;if(!count){this._len=total;return iterResult.getValue();}}}}}}}\u000afixday=false;if(freq==RRule.YEARLY){year+=interval;if(year>dateutil.MAXYEAR){this._len=total;return iterResult.getValue();}\u000aii.rebuild(year,month);}else if(freq==RRule.MONTHLY){month+=interval;if(month>12){div=Math.floor(month/12);mod=pymod(month,12);month=mod;year+=div;if(month==0){month=12;--year;}\u000aif(year>dateutil.MAXYEAR){this._len=total;return iterResult.getValue();}}\u000aii.rebuild(year,month);}else if(freq==RRule.WEEKLY){if(wkst>weekday){day+=-(weekday+1+(6-wkst))+interval*7;}else{day+=-(weekday-wkst)+interval*7;}\u000aweekday=wkst;fixday=true;}else if(freq==RRule.DAILY){day+=interval;fixday=true;}else if(freq==RRule.HOURLY){if(filtered){hour+=Math.floor((23-hour)/interval)*interval;}\u000awhile(true){hour+=interval;dm=divmod(hour,24);div=dm.div;mod=dm.mod;if(div){hour=mod;day+=div;fixday=true;}\u000aif(!plb(byhour)||contains(byhour,hour)){break;}}\u000atimeset=gettimeset.call(ii,hour,minute,second);}else if(freq==RRule.MINUTELY){if(filtered){minute+=Math.floor((1439-(hour*60+minute))/interval)*interval;}\u000awhile(true){minute+=interval;dm=divmod(minute,60);div=dm.div;mod=dm.mod;if(div){minute=mod;hour+=div;dm=divmod(hour,24);div=dm.div;mod=dm.mod;if(div){hour=mod;day+=div;fixday=true;filtered=false;}}\u000aif((!plb(byhour)||contains(byhour,hour))&&(!plb(byminute)||contains(byminute,minute))){break;}}\u000atimeset=gettimeset.call(ii,hour,minute,second);}else if(freq==RRule.SECONDLY){if(filtered){second+=Math.floor((86399-(hour*3600+minute*60+second))/interval)*interval;}\u000awhile(true){second+=interval;dm=divmod(second,60);div=dm.div;mod=dm.mod;if(div){second=mod;minute+=div;dm=divmod(minute,60);div=dm.div;mod=dm.mod;if(div){minute=mod;hour+=div;dm=divmod(hour,24);div=dm.div;mod=dm.mod;if(div){hour=mod;day+=div;fixday=true;}}}\u000aif((!plb(byhour)||contains(byhour,hour))&&(!plb(byminute)||contains(byminute,minute))&&(!plb(bysecond)||contains(bysecond,second)))\u000a{break;}}\u000atimeset=gettimeset.call(ii,hour,minute,second);}\u000aif(fixday&&day>28){var daysinmonth=dateutil.monthRange(year,month-1)[1];if(day>daysinmonth){while(day>daysinmonth){day-=daysinmonth;++month;if(month==13){month=1;++year;if(year>dateutil.MAXYEAR){this._len=total;return iterResult.getValue();}}\u000adaysinmonth=dateutil.monthRange(year,month-1)[1];}\u000aii.rebuild(year,month);}}}}};RRule.parseString=function(rfcString){rfcString=rfcString.replace(/^\u005cs+|\u005cs+$/,'');if(!rfcString.length){return null;}\u000avar i,j,key,value,attr,attrs=rfcString.split(';'),options={};for(i=0;i<attrs.length;i++){attr=attrs[i].split('=');key=attr[0];value=attr[1];switch(key){case'FREQ':options.freq=RRule[value];break;case'WKST':options.wkst=RRule[value];break;case'COUNT':case'INTERVAL':case'BYSETPOS':case'BYMONTH':case'BYMONTHDAY':case'BYYEARDAY':case'BYWEEKNO':case'BYHOUR':case'BYMINUTE':case'BYSECOND':if(value.indexOf(',')!=-1){value=value.split(',');for(j=0;j<value.length;j++){if(/^[+-]?\u005cd+$/.test(value[j])){value[j]=Number(value[j]);}}}else if(/^[+-]?\u005cd+$/.test(value)){value=Number(value);}\u000akey=key.toLowerCase();options[key]=value;break;case'BYDAY':var n,wday,day,days=value.split(',');options.byweekday=[];for(j=0;j<days.length;j++){day=days[j];if(day.length==2){wday=RRule[day];options.byweekday.push(wday);}else{day=day.match(/^([+-]?\u005cd)([A-Z]{2})$/);n=Number(day[1]);wday=day[2];wday=RRule[wday].weekday;options.byweekday.push(new Weekday(wday,n));}}\u000abreak;case'DTSTART':options.dtstart=dateutil.untilStringToDate(value);break;case'UNTIL':options.until=dateutil.untilStringToDate(value);break;case'BYEASTER':options.byeaster=Number(value);break;default:throw new Error("Unknown RRULE property '"+key+"'");}}\u000areturn options;};RRule.fromString=function(string){return new RRule(RRule.parseString(string));};var Iterinfo=function(rrule){this.rrule=rrule;this.lastyear=null;this.lastmonth=null;this.yearlen=null;this.nextyearlen=null;this.yearordinal=null;this.yearweekday=null;this.mmask=null;this.mrange=null;this.mdaymask=null;this.nmdaymask=null;this.wdaymask=null;this.wnomask=null;this.nwdaymask=null;this.eastermask=null;};Iterinfo.prototype.easter=function(y,offset){offset=offset||0;var a=y%19,b=Math.floor(y/100),c=y%100,d=Math.floor(b/4),e=b%4,f=Math.floor((b+8)/25),g=Math.floor((b-f+1)/3),h=Math.floor(19*a+b-d-g+15)%30,i=Math.floor(c/4),k=c%4,l=Math.floor(32+2*e+2*i-h-k)%7,m=Math.floor((a+11*h+22*l)/451),month=Math.floor((h+l-7*m+114)/31),day=(h+l-7*m+114)%31+1,date=Date.UTC(y,month-1,day+offset),yearStart=Date.UTC(y,0,1);return[Math.ceil((date-yearStart)/(1000*60*60*24))];}\u000aIterinfo.prototype.rebuild=function(year,month){var rr=this.rrule;if(year!=this.lastyear){this.yearlen=dateutil.isLeapYear(year)?366:365;this.nextyearlen=dateutil.isLeapYear(year+1)?366:365;var firstyday=new Date(year,0,1);this.yearordinal=dateutil.toOrdinal(firstyday);this.yearweekday=dateutil.getWeekday(firstyday);var wday=dateutil.getWeekday(new Date(year,0,1));if(this.yearlen==365){this.mmask=[].concat(M365MASK);this.mdaymask=[].concat(MDAY365MASK);this.nmdaymask=[].concat(NMDAY365MASK);this.wdaymask=WDAYMASK.slice(wday);this.mrange=[].concat(M365RANGE);}else{this.mmask=[].concat(M366MASK);this.mdaymask=[].concat(MDAY366MASK);this.nmdaymask=[].concat(NMDAY366MASK);this.wdaymask=WDAYMASK.slice(wday);this.mrange=[].concat(M366RANGE);}\u000aif(!plb(rr.options.byweekno)){this.wnomask=null;}else{this.wnomask=repeat(0,this.yearlen+7);var no1wkst,firstwkst,wyearlen;no1wkst=firstwkst=pymod(7-this.yearweekday+rr.options.wkst,7);if(no1wkst>=4){no1wkst=0;wyearlen=this.yearlen+pymod(this.yearweekday-rr.options.wkst,7);}else{wyearlen=this.yearlen-no1wkst;}\u000avar div=Math.floor(wyearlen/7);var mod=pymod(wyearlen,7);var numweeks=Math.floor(div+(mod/4));for(var n,i,j=0;j<rr.options.byweekno.length;j++){n=rr.options.byweekno[j];if(n<0){n+=numweeks+1;}if(!(0<n&&n<=numweeks)){continue;}if(n>1){i=no1wkst+(n-1)*7;if(no1wkst!=firstwkst){i-=7-firstwkst;}}else{i=no1wkst;}\u000afor(var k=0;k<7;k++){this.wnomask[i]=1;i++;if(this.wdaymask[i]==rr.options.wkst){break;}}}\u000aif(contains(rr.options.byweekno,1)){var i=no1wkst+numweeks*7;if(no1wkst!=firstwkst){i-=7-firstwkst;}\u000aif(i<this.yearlen){for(var j=0;j<7;j++){this.wnomask[i]=1;i+=1;if(this.wdaymask[i]==rr.options.wkst){break;}}}}\u000aif(no1wkst){var lnumweeks;if(!contains(rr.options.byweekno,-1)){var lyearweekday=dateutil.getWeekday(new Date(year-1,0,1));var lno1wkst=pymod(7-lyearweekday+rr.options.wkst,7);var lyearlen=dateutil.isLeapYear(year-1)?366:365;if(lno1wkst>=4){lno1wkst=0;lnumweeks=Math.floor(52\u000a+pymod(lyearlen+pymod(lyearweekday-rr.options.wkst,7),7)/4);}else{lnumweeks=Math.floor(52+pymod(this.yearlen-no1wkst,7)/4);}}else{lnumweeks=-1;}\u000aif(contains(rr.options.byweekno,lnumweeks)){for(var i=0;i<no1wkst;i++){this.wnomask[i]=1;}}}}}\u000aif(plb(rr.options.bynweekday)&&(month!=this.lastmonth||year!=this.lastyear)){var ranges=[];if(rr.options.freq==RRule.YEARLY){if(plb(rr.options.bymonth)){for(j=0;j<rr.options.bymonth.length;j++){month=rr.options.bymonth[j];ranges.push(this.mrange.slice(month-1,month+1));}}else{ranges=[[0,this.yearlen]];}}else if(rr.options.freq==RRule.MONTHLY){ranges=[this.mrange.slice(month-1,month+1)];}\u000aif(plb(ranges)){this.nwdaymask=repeat(0,this.yearlen);for(var j=0;j<ranges.length;j++){var rang=ranges[j];var first=rang[0],last=rang[1];last-=1;for(var k=0;k<rr.options.bynweekday.length;k++){var wday=rr.options.bynweekday[k][0],n=rr.options.bynweekday[k][1];if(n<0){i=last+(n+1)*7;i-=pymod(this.wdaymask[i]-wday,7);}else{i=first+(n-1)*7;i+=pymod(7-this.wdaymask[i]+wday,7);}\u000aif(first<=i&&i<=last){this.nwdaymask[i]=1;}}}}\u000athis.lastyear=year;this.lastmonth=month;}\u000aif(rr.options.byeaster!==null){this.eastermask=this.easter(year,rr.options.byeaster);}};Iterinfo.prototype.ydayset=function(year,month,day){return[range(this.yearlen),0,this.yearlen];};Iterinfo.prototype.mdayset=function(year,month,day){var set=repeat(null,this.yearlen);var start=this.mrange[month-1];var end=this.mrange[month];for(var i=start;i<end;i++){set[i]=i;}\u000areturn[set,start,end];};Iterinfo.prototype.wdayset=function(year,month,day){var set=repeat(null,this.yearlen+7);var i=dateutil.toOrdinal(new Date(year,month-1,day))-this.yearordinal;var start=i;for(var j=0;j<7;j++){set[i]=i;++i;if(this.wdaymask[i]==this.rrule.options.wkst){break;}}\u000areturn[set,start,i];};Iterinfo.prototype.ddayset=function(year,month,day){var set=repeat(null,this.yearlen);var i=dateutil.toOrdinal(new Date(year,month-1,day))-this.yearordinal;set[i]=i;return[set,i,i+1];};Iterinfo.prototype.htimeset=function(hour,minute,second){var set=[],rr=this.rrule;for(var i=0;i<rr.options.byminute.length;i++){minute=rr.options.byminute[i];for(var j=0;j<rr.options.bysecond.length;j++){second=rr.options.bysecond[j];set.push(new dateutil.Time(hour,minute,second));}}\u000adateutil.sort(set);return set;};Iterinfo.prototype.mtimeset=function(hour,minute,second){var set=[],rr=this.rrule;for(var j=0;j<rr.options.bysecond.length;j++){second=rr.options.bysecond[j];set.push(new dateutil.Time(hour,minute,second));}\u000adateutil.sort(set);return set;};Iterinfo.prototype.stimeset=function(hour,minute,second){return[new dateutil.Time(hour,minute,second)];};var IterResult=function(method,args){this.init(method,args)};IterResult.prototype={init:function(method,args){this.method=method;this.args=args;this._result=[];this.minDate=null;this.maxDate=null;if(method=='between'){this.maxDate=args.inc?args.before:new Date(args.before.getTime()-1);this.minDate=args.inc?args.after:new Date(args.after.getTime()+1);}else if(method=='before'){this.maxDate=args.inc?args.dt:new Date(args.dt.getTime()-1);}else if(method=='after'){this.minDate=args.inc?args.dt:new Date(args.dt.getTime()+1);}},accept:function(date){var tooEarly=this.minDate&&date<this.minDate,tooLate=this.maxDate&&date>this.maxDate;if(this.method=='between'){if(tooEarly)\u000areturn true;if(tooLate)\u000areturn false;}else if(this.method=='before'){if(tooLate)\u000areturn false;}else if(this.method=='after'){if(tooEarly)\u000areturn true;this.add(date);return false;}\u000areturn this.add(date);},add:function(date){this._result.push(date);return true;},getValue:function(){switch(this.method){case'all':case'between':return this._result;case'before':case'after':return this._result.length?this._result[this._result.length-1]:null;}}};var CallbackIterResult=function(method,args,iterator){var allowedMethods=['all','between'];if(!contains(allowedMethods,method)){throw new Error('Invalid method "'+method\u000a+'". Only all and between works with iterator.');}\u000athis.add=function(date){if(iterator(date,this._result.length)){this._result.push(date);return true;}\u000areturn false;};this.init(method,args);};CallbackIterResult.prototype=IterResult.prototype;if(serverSide){module.exports={RRule:RRule}}\u000aif(typeof ender==='undefined'){root['RRule']=RRule;}\u000aif(typeof define==="function"&&define.amd){define("rrule",[],function(){return RRule;});}}(this));function go_to_room(roomLocation,roomId,clone_booking){var url;if(clone_booking){url=build_url(Indico.Urls.RoomBookingCloneBooking,{roomLocation:roomLocation,room:roomId,resvID:clone_booking});}\u000aelse{url=build_url(Indico.Urls.RoomBookingBookRoom,{roomLocation:roomLocation,roomID:roomId});}\u000aindicoRequest('roomBooking.room.bookingPermission',{room_id:roomId},function(result,error){if(!error){if(result.can_book){window.location.href=url;}else{var popup=new AlertPopup('Booking Not Allowed',"You're not allowed to book this room");popup.open();}}else{showErrorDialog(error);}});}\u000atype("RoomMap",["IWidget"],{initialize:function(mapCanvas,aspectsCanvas,filterCanvas,aspects,buildings,filters,customWidgets,startupRoomFilters,startupBuildingFilters){this.initData(aspects,buildings,filters,customWidgets,startupRoomFilters,startupBuildingFilters);this.createMap(mapCanvas);this.initializeBounds();this.createAspectChangeLinks(aspectsCanvas);this.createBuildingMarkers();this.createFilters(filterCanvas);this.embedWidgets();this.setDefaultFilterValues();this.updateFiltersState();this.filterMarkers(true);},initData:function(aspects,buildings,filters,customWidgets,startupRoomFilters,startupBuildingFilters){this.aspects=aspects;this.buildings=buildings;this.filters=filters;this.customWidgets=customWidgets;this.startupRoomFilters=startupRoomFilters;this.startupBuildingFilters=startupBuildingFilters;this.buildingNumberFilter=_.find(this.filters,function(f){return f.filterType=='building'&&f.property=='number';});},createMap:function(mapCanvas){this.markers=[];var options={zoom:17,mapTypeId:google.maps.MapTypeId.HYBRID};this.map=new google.maps.Map(mapCanvas,options);google.maps.event.addListener(this.map,"click",this.createMapClickHandler());},createMapClickHandler:function(){return _.bind(function(){this.closeInfoBaloon();},this);},createBuildingMarkers:function(){_.each(this.buildings,function(building){building.point=new google.maps.LatLng(building.latitude,building.longitude);var marker=new google.maps.Marker({position:building.point,map:this.map,visible:false});marker.building=building;building.marker=marker;marker.onClick=this.createMarkerClickHandler(marker);google.maps.event.addListener(marker,"click",marker.onClick);this.markers.push(marker);},this);},createMarkerClickHandler:function(marker){return _.bind(function(){if(!exists(marker.infoWindow)){marker.infoWindow=new google.maps.InfoWindow({content:this.createBuildingInfo(marker.building)});}\u000athis.closeInfoBaloon();this.activeInfoWindow=marker.infoWindow;marker.infoWindow.open(this.map,marker);},this);},closeInfoBaloon:function(){if(exists(this.activeInfoWindow)){this.activeInfoWindow.close();this.activeInfoWindow=null;}},setSelectedAspectStyle:function(link){if(this.selectedLink){this.selectedLink.dom.className=this.constructAspectCss(false);}\u000athis.selectedLink=link;link.dom.className=this.constructAspectCss(true);},createAspectChangeFunction:function(aspect,link){return _.bind(function(){this.activeAspect=aspect;this.map.setCenter(new google.maps.LatLng(aspect.center_latitude,aspect.center_longitude));this.map.setZoom(aspect.zoom_level);this.setSelectedAspectStyle(link);return false;},this);},constructAspectCss:function(selected){var selectionClass=selected?'mapAspectSelected':'mapAspectUnselected';return'mapAspectsItem '+selectionClass;},createAspectChangeLinks:function(aspectsCanvas){var links=Html.ul({className:'mapAspectsList'}).dom;_.each(this.aspects,function(aspect,i){var link=Html.a({'href':'#',className:this.constructAspectCss(false)},aspect.name);var itemClassName=i==0?'first ':(i==this.aspects.length-1?'last ':'');var item=Html.li({className:itemClassName+'browserDefault'},link.dom);aspect.applyAspect=this.createAspectChangeFunction(aspect,link);aspect.link=link;if(aspect.default_on_startup){aspect.applyAspect();}\u000alink.observeClick(aspect.applyAspect);links.appendChild(item.dom);},this);aspectsCanvas.appendChild(links);},createRoomInfo:function(building,room){var address=building.number+'/'+room.floor+'-'+room.number;var caption=$("<span/>").text($T("Room")+' '+address);var addr=$("<span/>").addClass('mapRoomAddress').text(address);var book=$('<a/>').addClass('mapBookRoomLink').attr('href',room.booking_url).attr('target','_blank').text($T('Book'));var more=$('<a/>').addClass('mapRoomInfoLink').text($T('More')+'...');var details=$('<a/>').attr('href',room.details_url).attr('target','_blank').text($T('Details')+'...');details=$('<span/>').addClass('mapRoomDetailsLink').append(details);var title=$('<div/>',{'class':'mapRoomTooltipTitle'}).append($('<div/>').css({float:'left'}).append(caption),$('<div/>').css({float:'right'}).append(details));var help=$('<div/>').append($('<img/>',{src:room.large_photo_url,width:'212px',height:'140px','class':'mapRoomTooltipImage'}),$('<div class="mapRoomTooltipDescription"/>').append(room.marker_description));help.children().wrap('<p/>');more.qtip({content:{text:help,title:{text:title,button:true}},show:{event:'click'},hide:{event:'unfocus'},position:{target:'mouse',adjust:{mouse:false}}});var roomInfo=$('<p/>').addClass('mapRoomInfo').append(addr).append(' - ').append(book).append(more);return roomInfo;},createBuildingInfo:function(building){var title=$("<p/>").addClass("mapBuildingTitle").text(building.title);var roomsInfo=$("<div/>").addClass("mapRoomsInfo");_.each(building.rooms,function(room){if(room.show_on_map){roomsInfo.append(this.createRoomInfo(building,room));}},this);var buildingInfo=$("<div/>").addClass("mapBuildingInfo").append(title).append(roomsInfo);return buildingInfo.get(0);},showMarkers:function(isStartup){var bounds=this.map.getBounds();var inBoundsCount=0;this.aloneBuilding=null;this.exactBuilding=null;var exactBuildingNumber=null;if(this.buildingNumberFilter){exactBuildingNumber=this.getFilterValue(this.buildingNumberFilter);}\u000a_.each(this.buildings,function(building){if(building.show_on_map){if(this.visibleBuildingsCount==1){this.aloneBuilding=building;}\u000aif(exactBuildingNumber!=null&&building.number==exactBuildingNumber){this.exactBuilding=building;}\u000avar pos=new google.maps.LatLng(building.latitude,building.longitude);_.each(this.bounds,function(bound,i){this.boundCounters[i]+=bound.contains(pos)?building.visibleRoomsSize:0;},this);}\u000abuilding.marker.setVisible(building.show_on_map);},this);},centerBuilding:function(building){this.map.setCenter(new google.maps.LatLng(building.latitude,building.longitude));},getFilterPropertyOptions:function(room_building_filter){return _.uniq(_.flatten(_.map(this.buildings,function(building){if(room_building_filter.filterType=='building'){return building[room_building_filter.property];}\u000areturn _.map(building.rooms,function(room){room[room_building_filter.property];});})));},updateFiltersState:function(){_.each(this.filters,function(f){f.enabled=!exists(f.enabledIf)||f.enabledIf(this);f.input.dom.disabled=!f.enabled;f.active=!exists(f.activeIf)||f.activeIf(this);},this);},createFilterWidget:function(room_building_filter){var input;if(_.contains(['text','subtext'],room_building_filter.inputType)){input=Html.input('text',{className:'mapFilterTextbox'});}else if(room_building_filter.inputType=='boolean'){input=Html.checkbox({className:'mapFilterCheckbox'});}else if(room_building_filter.inputType=='list_contains'){input=Html.checkbox({className:'mapFilterCheckbox'});}else if(room_building_filter.inputType=='hidden'){input=null;}else if(room_building_filter.inputType=='combo'){input=Html.select({className:'mapFilterCombo'},_.map(this.getFilterPropertyOptions(room_building_filter),function(option){return Html.option({value:option},option);}));}\u000aif(input){room_building_filter.input=input;input.observeKeyPress(_.bind(function(key){this.onFiltersInputChanged();},this));input.observeChange(_.bind(function(key){this.onFiltersInputChanged();},this));var label=Html.span({className:'mapFilterLabel'},room_building_filter.label);if(_.contains(['text','subtext','combo'],room_building_filter.inputType)){return Widget.inline([label,input]);}\u000areturn Widget.inline([input,label]);}else{return null;}},onFiltersInputChanged:function(){this.updateFiltersState();},setDefaultFilterValue:function(room_building_filter){if(room_building_filter.group!==undefined){if(room_building_filter.defaultValue!==undefined){room_building_filter.mainCheckbox.dom.checked=room_building_filter.defaultValue;room_building_filter.mainCheckbox.dispatchEvent('change');}\u000a_.each(room_building_filter.group,function(filterGroup){this.setDefaultFilterValue(filterGroup);},this);}else{if(room_building_filter.defaultValue!==undefined&&room_building_filter.input){if(_.contains(['boolean','list_contains'],room_building_filter.inputType)){room_building_filter.input.dom.checked=room_building_filter.defaultValue;}else{room_building_filter.input.dom.value=room_building_filter.defaultValue;}\u000aroom_building_filter.input.dispatchEvent('change');}}},setDefaultFilterValues:function(){_.each(this.filters,function(room_building_filter){this.setDefaultFilterValue(room_building_filter);},this);_.each(this.customWidgets,function(customWidget){customWidget.resetFields();});},createGroupWidget:function(room_building_filter){var widgets=Html.div({className:"mapFilterGroup"},this.createFilterWidgets(room_building_filter.group));var mainCheckbox=Html.checkbox({className:'mapFilterCheckbox'});function onMainCheckboxClick(){if(mainCheckbox.dom.checked){IndicoUI.Effect.appear(widgets);}else{IndicoUI.Effect.disappear(widgets);}}\u000amainCheckbox.observeChange(onMainCheckboxClick);onMainCheckboxClick();var label=Html.span({className:'mapFilterLabel'},room_building_filter.label);var top=Html.div({},mainCheckbox,label);room_building_filter.widgets=widgets;room_building_filter.mainCheckbox=mainCheckbox;return Html.div({},top,widgets);},createFilterWidgets:function(filters){return Widget.lines(_.map(filters,function(f){return exists(f.group)?this.createGroupWidget(f):this.createFilterWidget(f);},this))},createFilters:function(filterCanvas){var lines=[];var title=Html.div({className:'mapFilterTitle'},$T('Search criteria')+':');lines.push(title);var filterWidgets=this.createFilterWidgets(this.filters);lines.push(filterWidgets);this.customWidgetsHolder=Html.div('mapCustomWidgetsHolder','');lines.push(this.customWidgetsHolder);var self=this;$('#filters_canvas').on('keydown',':input:not(button)',function(e){if(e.which==13){self.filterMarkers(false);}});var filterButton=Html.button('mapButton',$T("Filter"));filterButton.observeClick(_.bind(function(){this.filterMarkers(false);},this));var resetButton=Html.button('mapButton',$T("Reset"));resetButton.observeClick(_.bind(function(){this.setDefaultFilterValues();this.filterMarkers(false);this.resetAspectPosition();},this));this.buttons=Html.div({},filterButton,resetButton);lines.push(this.buttons);this.progress=Html.span({},progressIndicator(true,true)).dom;this.resultsInfo=Html.span('mapResultsInfo','');lines.push(this.resultsInfo);filterCanvas.appendChild(Widget.lines(lines).dom);},matchesCriteria:function(x,criteria){return _.all(criteria,function(criterium){return criterium(x);});},filterByCriteria:function(items,criteria){return _.reduce(items,function(mem,item){item.show_on_map=this.matchesCriteria(item,criteria);return mem+item.show_on_map;},0,this);},filterBuildingsByCriteria:function(buildingCriteria,roomCriteria){this.filterByCriteria(this.buildings,buildingCriteria);_.each(this.buildings,function(building){if(building.show_on_map){building.visibleRoomsSize=this.filterByCriteria(building.rooms,roomCriteria);this.visibleRoomsCount+=building.visibleRoomsSize;if(building.visibleRoomsSize>0){this.visibleBuildingsCount++;}else{building.show_on_map=false;}}else{building.visibleRoomsSize=0;}},this);},building:function(number){return _.find(this.buildings,function(building){return building.number==number;});},filterInput:function(index){return this.getFilterValue(this.filters[index]);},createPropertyFilter:function(inputType,propertyName,expectedValue){if(inputType=='list_contains'){return function(obj){return _.contains(obj[propertyName],expectedValue);}}else if(inputType=='subtext'){return function(obj){return str(obj[propertyName]).match(new RegExp(expectedValue,"gi"));}}else{return function(obj){return obj[propertyName]==expectedValue;}}},getFilterValue:function(room_building_filter){var value;if(room_building_filter.inputType=='boolean'){value=room_building_filter.input.dom.checked;if(value&&room_building_filter.checkedValue!==undefined){value=room_building_filter.checkedValue;}else if(value&&room_building_filter.filterFunction!==undefined){value=room_building_filter.filterFunction;}}else if(room_building_filter.inputType=='list_contains'){value=room_building_filter.input.dom.checked?room_building_filter.value:'';}else if(room_building_filter.inputType=='hidden'){value=room_building_filter.defaultValue;}else{value=room_building_filter.input.dom.value;}\u000areturn value;},addFilterFunctionToCriteria:function(filter,func,buildingCriteria,roomCriteria){if(filter.filterType=='building'){buildingCriteria.push(func);}else{roomCriteria.push(func);}},addFiltersToCriteria:function(filters,buildingCriteria,roomCriteria){_.each(filters,function(f){if(f.group!==undefined){var value=f.mainCheckbox.dom.checked;if(!f.optional||value){if(f.property){var func=this.createPropertyFilter('boolean',f.property,value);this.addFilterFunctionToCriteria(f,func,buildingCriteria,roomCriteria);}\u000athis.addFiltersToCriteria(f.group,buildingCriteria,roomCriteria);}}else{var value=this.getFilterValue(f);if((!f.optional||value)&&f.active&&f.enabled){var func;if(f.filterFunction){func=_.partial(f.filterFunction,this);}else{func=this.createPropertyFilter(f.inputType,f.property,value);}\u000athis.addFilterFunctionToCriteria(f,func,buildingCriteria,roomCriteria);}}},this);},resetFilteringCycle:function(){this.visibleBuildingsCount=0;this.visibleRoomsCount=0;_.each(this.buildings,function(building){building.marker.infoWindow=null;});this.boundCounters=_.map(this.boundCounters,function(){return 0;})},addCustomWidgetFiltersToCriteria:function(buildingCriteria,roomCriteria,filterCallback){var counter=0;var total=this.customWidgets.length;function filtersCallback(buildingFilters,roomFilters){counter++;_.each(buildingFilters,function(bf){buildingCriteria.push(bf);})\u000a_.each(roomFilters,function(rf){roomCriteria.push(rf);})}\u000a_.each(this.customWidgets,function(customWidget){customWidget.getFilters(filtersCallback);});function waitResponses(){if(counter==total){filterCallback();}else{setTimeout(waitResponses,50);}};setTimeout(waitResponses,50);},addStartupFiltersToCriteria:function(buildingCriteria,roomCriteria){_.each(this.startupBuildingFilters,function(sbf){buildingCriteria.push(sbf);});_.each(this.startupRoomFilters,function(srf){roomCriteria.push(srf);});},resetAspectPosition:function(){this.activeAspect.applyAspect();},adjustProperAspect:function(){var isDefaultAspectEmpty=false;var maxResultsAspect;var maxResults=0;function adjust(aspect,boundCounter){if(aspect==this.activeAspect&&boundCounter==0){isDefaultAspectEmpty=true;}\u000aif(maxResults<boundCounter){maxResults=boundCounter;maxResultsAspect=aspect;}}\u000a_.each(_.zip(this.aspects,this.boundCounters),function(pair,i){adjust.apply(this,pair);},this);if(isDefaultAspectEmpty&&maxResults>0){maxResultsAspect.applyAspect();}},adjustMapCenter:function(isStartup){if(this.exactBuilding!=null){this.centerBuilding(this.exactBuilding);}\u000aif(isStartup&&this.aloneBuilding!=null){this.centerBuilding(this.aloneBuilding);}},adjustMarkerInfo:function(){if(this.aloneBuilding!=null){this.aloneBuilding.marker.onClick();}},postFilterAdjustments:function(isStartup){this.adjustProperAspect();this.adjustMapCenter(isStartup);this.adjustMarkerInfo();},filterMarkers:function(isStartup){this.buttons.dom.appendChild(this.progress);var mapView=this;var buildingCriteria=[];var roomCriteria=[];function filterCallback(){mapView.filterBuildingsByCriteria(buildingCriteria,roomCriteria);mapView.showMarkers(isStartup);mapView.showResultsInfo();mapView.updateAspectsInfo();mapView.postFilterAdjustments(isStartup);mapView.buttons.dom.removeChild(mapView.progress);}\u000asetTimeout(function(){mapView.resetFilteringCycle();mapView.closeInfoBaloon();if(isStartup){mapView.addStartupFiltersToCriteria(buildingCriteria,roomCriteria);}\u000amapView.addFiltersToCriteria(mapView.filters,buildingCriteria,roomCriteria);mapView.addCustomWidgetFiltersToCriteria(buildingCriteria,roomCriteria,filterCallback);},0);},showResultsInfo:function(){this.resultsInfo.dom.innerHTML=$T('Total')+' '\u000a+this.visibleRoomsCount+' '+$T('room(s)')\u000a+' / '+this.visibleBuildingsCount+' '+$T('building(s)');},initializeBounds:function(){this.bounds=[];this.boundCounters=[];_.each(this.aspects,function(aspect){var sw=new google.maps.LatLng(aspect.top_left_latitude,aspect.top_left_longitude);var ne=new google.maps.LatLng(aspect.bottom_right_latitude,aspect.bottom_right_longitude);this.bounds.push(new google.maps.LatLngBounds(sw,ne));this.boundCounters.push(0);},this);},updateAspectsInfo:function(){function format(aspect,counter){aspect.link.dom.innerHTML=aspect.name+'('+counter+')';}\u000a_.each(_.zip(this.aspects,this.boundCounters),function(pair){format.apply(this,pair);},this);},embedWidgets:function(){_.each(this.customWidgets,function(customWidget){this.customWidgetsHolder.dom.appendChild(customWidget.widget);},this);}},function(mapCanvas,aspectsCanvas,filterCanvas,aspects,buildings,filters,customWidgets,startupRoomFilters,startupBuildingFilters){this.initialize(mapCanvas,aspectsCanvas,filterCanvas,aspects,buildings,filters,customWidgets,startupRoomFilters,startupBuildingFilters);this.values={};this.extraComponents=[];});function set_repeatition_comment(){var s='';var repType=parseInt($('#repeatability').val(),10);if(repType>0){var date=new Date(parseInt($('#sYear').val(),10),parseInt($('#sMonth').val()-1,10),parseInt($('#sDay').val(),10));var weekDays=['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];s='on '+weekDays[date.getDay()];if(repType==4){var weekNr=Math.floor(date.getDate()/7)+1;var postfix=['st','nd','rd','th','th'];var weekNrStr='the '+weekNr+postfix[weekNr-1]+' ';s='on '+weekNrStr+weekDays[date.getDay()]+' of a month';}}\u000a$('#repComment').html(s);}\u000afunction saveFormData(){var selectedRooms=$("#roomselector").roomselector("selection");var filterData=$("#roomselector").roomselector("userdata");var rbDict={startDate:$('#sDatePlace').datepicker('getDate'),endDate:$('#eDatePlace').datepicker('getDate'),startTime:$('#timerange').timerange('getStartTime'),endTime:$('#timerange').timerange('getEndTime'),"capacity":filterData.capacity,"videoconference":filterData.videoconference,"webcast":filterData.webcast,"projector":filterData.projector,"publicroom":filterData.publicroom,"filter":filterData.search,"selectedRooms":selectedRooms,"finishDate":$('#finishDate').val(),"flexibleDatesRange":$("#flexibleDates input[name=flexible_dates_range]:checked").val(),repeatFrequency:$('input[name=repeat_frequency]:checked').val(),repeatInterval:$('#repeat_interval').val(),roomIds:$('#room_ids').val()};$.jStorage.set(userId,rbDict);$.jStorage.setTTL(userId,7200000);}\u000a$(document).ready(function(){var backLink=$('#js-back-to-period');if(backLink.length){var data=$.jStorage.get(userId);if(!data||!data.startDate){backLink.contents().unwrap();}\u000aelse{backLink.on('click',function(e){e.preventDefault();var form=$('<form>',{method:'POST',action:''});form.append([$('<input>',{type:'hidden',name:'step',value:1}),$('<input>',{type:'hidden',name:'start_dt',value:moment(data.startDate).format('D/MM/YYYY')+' '+data.startTime}),$('<input>',{type:'hidden',name:'end_dt',value:moment(data.endDate).format('D/MM/YYYY')+' '+data.endTime}),$('<input>',{type:'hidden',name:'repeat_frequency',value:data.repeatFrequency}),$('<input>',{type:'hidden',name:'repeat_interval',value:data.repeatInterval}),$('<input>',{type:'hidden',name:'flexible_dates_range',value:data.flexibleDatesRange})]);form.append($.map(data.roomIds,function(value){return $('<input>',{type:'hidden',name:'room_ids',value:value});}));form.appendTo(document.body).submit();});}}});var START_H=6;var DAY_WIDTH_PX=35*12*2;var barClasses=['barBlocked','barPreB','barPreConc','barUnaval','barCand','barPreC','barConf','barOutOfRange'];var calendarLegend=Html.div({style:{clear:'both',padding:pixels(5),marginBottom:pixels(10),border:"1px solid #eaeaea",borderRadius:pixels(2)}},Html.div({className:'barLegend',style:{color:'black'}},$T('Legend:')),Html.div({className:'barLegend barCand'},$T('Available')),Html.div({className:'barLegend barConf'},$T('Conflict')),Html.div({className:'barLegend barUnaval'},$T('Booked')),Html.div({className:'barLegend barPreB',style:{color:'black'}},$T('PRE-Booking')),Html.div({className:'barLegend barPreC',style:{color:'white'}},$T('Conflict with PRE-Booking')),Html.div({className:'barLegend barPreConc',style:{color:'white'}},$T('Concurrent PRE-Bookings')),Html.div({className:'barLegend barBlocked'},$T('Blocked')),Html.div({className:'barLegend barOutOfRange'},$T('Too early to book')));function compare_alphanum(elem1,elem2){var i_elem1=parseInt(elem1),i_elem2=parseInt(elem2);elem1=isNaN(i_elem1)?(elem1||'').toLowerCase():i_elem1;elem2=isNaN(i_elem2)?(elem2||'').toLowerCase():i_elem2;return elem1==elem2?0:(elem1<elem2?-1:1);}\u000atype("RoomBookingRoom",[],{getFullName:function(){var fullName=this.building+"-"+this.floor+"-"+this.number;if(fullName==this.name)\u000areturn fullName;else\u000areturn fullName+" ("+this.name+")";},getFullNameHtml:function(breakLine){var fullName=this.building+"-"+this.floor+"-"+this.number;if(fullName==this.name)\u000areturn Html.div({},fullName);else\u000areturn Html.div({},fullName,breakLine?Html.br():"",Html.small({},"("+this.name+")"));}},function(roomData,date){this.id=roomData.id;this.number=roomData.number;this.floor=roomData.floor;this.building=roomData.building;this.location_name=roomData.location_name;this.name=roomData.name;this.type=roomData.kind;this.max_advance_days=roomData.max_advance_days;this.details_url=roomData.details_url;this.bookingUrl=build_url(roomData.booking_url,{start_date:date});});type("RoomBookingCalendarBar",[],{},function(barInfo,room){this.room=room;this.startDT=IndicoUtil.parseJsonDate(barInfo.startDT);this.endDT=IndicoUtil.parseJsonDate(barInfo.endDT);this.canReject=barInfo.canReject;this.rejectURL=barInfo.rejectURL;this.blocking=barInfo.blocking_data;if(barInfo.forReservation){this.reason=barInfo.forReservation.reason;this.owner=barInfo.forReservation.bookedForName;this.url=barInfo.forReservation.bookingUrl;this.inDB=barInfo.forReservation.id!==null;}else if(barInfo.type==0&&barInfo.blocking_data.type=='blocking'){this.url=barInfo.blocking_data.blocking_url;this.inDB=true}else if(barInfo.type==0&&barInfo.blocking_data.type=='nonbookable'){this.inDB=false}else{this.inDB=false;}\u000athis.type=barClasses[parseInt(barInfo.type)];this.resvStartDT=barInfo.resvStartDT&&IndicoUtil.parseJsonDate(barInfo.resvStartDT);this.resvEndDT=barInfo.resvEndDT&&IndicoUtil.parseJsonDate(barInfo.resvEndDT);});type("RoomBookingCalendarRoom",[],{getBars:function(){return this.bars;}},function(roomInfo,date,empty){var self=this;this.bars=[];this.date=date;if(!empty){this.room=new RoomBookingRoom(roomInfo.room,date);each(roomInfo.bars,function(bar){self.bars.push(new RoomBookingCalendarBar(bar,self.room));});}else{this.room=new RoomBookingRoom(roomInfo.room,date);}});type("RoomBookingCalendarDay",[],{getBars:function(){var bars=[];each(this.rooms,function(room){bars=bars.concat(room.getBars());});return bars;}},function(dayInfo,date){var self=this;this.date=date;this.rooms=[];each(dayInfo,function(room){self.rooms.push(new RoomBookingCalendarRoom(room,date));});});type("RoomBookingCalendarData",[],{getBars:function(){var bars=[];for(var day=0;day<_.size(this.days);++day)\u000abars=bars.concat(this.days[day].getBars());return bars;},getDayClass:function(day){if(!this.dayAttrs[day.date]){return;}\u000areturn this.dayAttrs[day.date].className||'';},getDayTooltip:function(day){if(!this.dayAttrs[day.date]){return;}\u000areturn this.dayAttrs[day.date].tooltip||'';}},function(options){$.extend(this,options);this.days=[];for(var date in this.bars){this.days.push(new RoomBookingCalendarDay(this.bars[date],date));}\u000athis.days.sort(function(day1,day2){return IndicoUtil.compare(day1.date,day2.date);});if(this.finishDate=='true'&&this.days.length){this.endD=this.days[this.days.length-1].date;this.startD=this.days[0].date;}\u000adelete this.bars;});type("RoomBookingCalendarDrawer",[],{drawBar:function(bar,showCandidateTip){var self=this;var startHour=bar.startDT.getHours()-START_H;var left=(startHour<0?0:startHour*60+bar.startDT.getMinutes())/(24*60)*DAY_WIDTH_PX;var diff=(bar.endDT.getHours()-bar.startDT.getHours()+(startHour<0?startHour:0))*60+(bar.endDT.getMinutes()-bar.startDT.getMinutes());var width=diff/(24*60)*DAY_WIDTH_PX-1;var resvInfo;if(width<0){return Html.div({});}\u000aif(bar.type=="barCand"){if(showCandidateTip){resvInfo=$T("Click to book it")+'<br>'+bar.startDT.print("%H:%M")+"  -  "+bar.endDT.print("%H:%M");}\u000aelse{resvInfo=$T('This bar indicates the time which will be booked.');}}else if(bar.type=="barBlocked"){resvInfo=(bar.blocking.type=='nonbookable')?[]:[$T("Room blocked by"),':<br/>',bar.blocking.creator,'<br/>'];resvInfo=[].concat.apply([],[resvInfo,[$T('Reason'),': ',bar.blocking.reason]]);}else if(bar.type=='barOutOfRange'){resvInfo=$T('Booking not allowed for this period.<br>This room can only be booked {0} days in advance.').format(bar.room.max_advance_days)}else{resvInfo=bar.startDT.print("%H:%M")+"  -  "+\u000abar.endDT.print("%H:%M")+"<br />"+\u000abar.owner+"<br />"+\u000abar.reason;}\u000avar barDiv=Html.div({className:bar.type+" barDefault",style:{cursor:(bar.inDB||(bar.type=='barCand'&&showCandidateTip)?'pointer':''),width:pixels(parseInt(width)),left:pixels(parseInt(left))}});if(bar.inDB){$(barDiv.dom).on('click',function(){if(self.data.openDetailsInNewTab){window.open(bar.url);}\u000aelse{location.href=bar.url;}});}\u000aelse if(bar.type=='barCand'&&showCandidateTip){$(barDiv.dom).click(function(){self._ajaxClick(bar,$(this));});}\u000a$(barDiv.dom).qtip({content:{text:resvInfo},style:{classes:"bold"},position:{target:'mouse',adjust:{mouse:true,x:11,y:13}},events:{show:function(event,api){if((navigator.platform.indexOf("iPad")!=-1)||(navigator.platform.indexOf("iPhone")!=-1)){event.preventDefault();}}}});return barDiv;},_ajaxClick:function(bar,element){var conflicts=$('.barDefaultHover').closest('.dayCalendarDiv').map(function(){return $(this).find('.barConf').length;}).get();var blocked=_.any($('.barDefaultHover').closest('.dayCalendarDiv').map(function(){return $(this).find('.barBlocked').length;}).get());var outOfRange=_.any($('.barDefaultHover').closest('.dayCalendarDiv').map(function(){return $(this).find('.barOutOfRange').length;}).get());if(outOfRange){this._setDialog("search-again");$('#booking-dialog-content').html($T("This room cannot booked more than {0} days in advance.").format(bar.room.max_advance_days));$('#booking-dialog').dialog("open");return;}\u000avar any_conflict=_.any(conflicts);var all_conflicts=conflicts.length&&_.every(conflicts,function(e){return!!e;});if(all_conflicts&&!blocked){this._setDialog("search-again");$('#booking-dialog-content').html($T("This room cannot be booked due to conflicts with existing reservations or room blockings."));$('#booking-dialog').dialog("open");}else if(any_conflict&&!blocked){this._setDialog("skip-conflict",bar);$('#booking-dialog-content').html($T("This booking contains conflicts with existing reservations or blockings."));$('#booking-dialog').dialog("open");}else{if(bar.room.type!="privateRoom"&&!blocked){this._proceedToBooking(bar);}else{this._handleProtected(element,bar.room.id,bar.blocking&&bar.blocking.id,bar);}}},_handleProtected:function(element,room_id,blocking_id,bar){var self=this;indicoRequest("roomBooking.room.bookingPermission",{room_id:room_id,blocking_id:blocking_id,start_dt:bar.resvStartDT.print('%H:%M %Y-%m-%d'),end_dt:bar.resvEndDT.print('%H:%M %Y-%m-%d')},function(result,error){if(!error&&!exists(result.error)){if(!result.can_book){self._setDialog("search-again");element.addClass("barProt");if(result.is_reservable&&result.group){var protection='<strong>'+result.group+'</strong>';$('#booking-dialog-content').html(format($T("Bookings of this room are limited to members of {0}."),[protection]));}else{$('#booking-dialog-content').html($T("You are not authorized to book this room."));}\u000a$('#booking-dialog').dialog("open");}\u000aelse if(result.blocked){var flexibility='.'+element.data('flexibility');$('.barDefault.barCand'+flexibility).addClass('barConf');self._setDialog("search-again");$('#booking-dialog-content').html((result.blocking_type==='blocking')?$T("This room is blocked on this date and you don't have permissions to book it."):$T("This room is not available on this date."));$('#booking-dialog').dialog("open");}\u000aelse{self._proceedToBooking(bar);}}else{showErrorDialog(error||result.error);}});},_proceedToBooking:function(bar){$('#start_dt').val(Util.formatDateTime(bar.resvStartDT));$('#end_dt').val(Util.formatDateTime(bar.resvEndDT));$('#room_id').val(bar.room.id);$('#periodForm').submit();},_setDialog:function(type,bar){var self=this;$('#booking-dialog').dialog({modal:true,resizable:false,autoOpen:false,show:"fade",title:$T("Unable to book")});switch(type){case"search-again":$('#booking-dialog').dialog({buttons:{"Search again":function(){location.href=location.href.replace(/#.*$/,'');},Close:function(){$(this).dialog('close');}}});break;case"skip-conflict":$('#booking-dialog').dialog({buttons:{"Skip conflicting days":function(){self._proceedToBooking(bar);},Close:function(){$(this).dialog('close');}}});break;default:$('#booking-dialog').dialog({buttons:{Close:function(){$(this).dialog('close');}}});}},drawSmallHours:function(){var hours=$('<div/>');for(var i=START_H;i<25;i+=2){var left=(i-START_H)/24*DAY_WIDTH_PX;hours.append($('<div class="calHour" />').css('left',left).text(i));}\u000areturn hours.children();},drawHeader:function(){},drawHours:function(){var hours=[];for(var i=START_H;i<25;i+=2){var left=(i-START_H)/24*DAY_WIDTH_PX;hours.push(Html.div({className:'calHour',style:{'left':left,fontSize:pixels(10)}},i,Html.span({style:{fontSize:pixels(8)}},":00")));}\u000areturn Html.div('dayCalendarDivHeader',hours);},drawContent:function(){return"";},draw:function(){return Html.div({},this.drawHeader(),this.drawContent());}},function(data){this.data=data;});type("RoomBookingManyRoomsCalendarDrawer",["RoomBookingCalendarDrawer"],{drawRoom:function(roomInfo){var self=this;var roomLink=Html.a({href:roomInfo.room.bookingUrl,className:'roomLink '+roomInfo.room.type},roomInfo.room.getFullNameHtml(true));var day_content=$('<div class="dayCalendarDiv">').append($('<div class="time-bar"/>'));$.each(roomInfo.bars,function(i,bar){day_content.append(self.drawBar(bar,true).dom);});var roomHasBars=_.some(roomInfo.bars,function(bar){return bar.type!='barBlocked';});var container=$('<div class="room-row">').data('protected',roomInfo.room.type).toggleClass('room-row-empty',!roomHasBars).append($('<div class="link">').append(roomLink.dom),day_content);return new XElement(container.get(0));},drawDay:function(day,highlight){var self=this;var rooms=[];var hasNonEmpty=false;each(day.rooms,function(room){var roomDiv=self.drawRoom(room);if(roomDiv){var roomHasBars=_.some(room.bars,function(bar){return bar.type!='barBlocked';});rooms.push(roomDiv);if(roomHasBars){hasNonEmpty=true;}}});if(_.size(rooms)>0){return Html.div({className:"wholeDayCalendarDiv "+(hasNonEmpty?'':'day-empty'),style:(highlight?{border:'2px solid #D9EDF7'}:{})},Html.div({className:(highlight?'wholeDayCalendarDayHighlight':''),style:{width:pixels(800),height:pixels(20),borderBottom:"1px solid #eaeaea",clear:"both"}},Html.div({style:{cssFloat:'left',fontWeight:'bold'}},$.datepicker.formatDate('DD, d MM yy',$.datepicker.parseDate('yy-mm-dd',day.date)))),this.drawHours(),rooms);}},drawContent:function(){var self=this;var days=[];$.each(this.data.days,function(index,day){var highlight=!self.data.repeatFrequency||(index==self.data.flexibleDays||(index-self.data.flexibleDays)%(2*self.data.flexibleDays+1)==0);days.push(self.drawDay(day,highlight));});return this.data.days.length!=0?Html.div({},days):Html.div({style:{width:pixels(700),margin:'2em auto'},className:'info-message'},$T('No results found in the given period of time.'));}},function(data){this.RoomBookingCalendarDrawer(data);});type("RoomBookingSingleRoomCalendarDrawer",["RoomBookingCalendarDrawer"],{drawDay:function(day){var self=this;var day_content=$('<div class="dayCalendarDiv">').append($('<div class="time-bar"/>'));$.each(day.rooms[0].bars,function(i,bar){day_content.append(self.drawBar(bar,false).dom);});var dateClass="weekday";var dateArray=day.date.split('-');var date=new Date(dateArray[0],dateArray[1]-1,dateArray[2]);if(date.getDay()==0||date.getDay()==6){dateClass="weekend";}\u000aif(this.room.nonBookableDates){return Html.span({title:$T("This room cannot be booked for this date"),className:"unavailable"},Util.formatDateTime(day.date,IndicoDateTimeFormats.DefaultHourless,"%Y-%m-%d"));}else{if(this.data.getDayClass(day)){dateClass=this.data.getDayClass(day);}\u000avar tt=this.data.getDayTooltip(day);if(tt){tt=tt.replace(/\u005cn/g,'<br>');}\u000avar link=Html.a({href:build_url(Indico.Urls.RoomBookingBookRoom,{start_date:day.date,roomLocation:this.room.location_name,roomID:this.room.id}),className:'dateLink '+dateClass},Util.formatDateTime(day.date,IndicoDateTimeFormats.DefaultHourless,"%Y-%m-%d"));var container=$('<div class="room-row">').append($('<div class="link">').append(link.dom),day_content);if(tt){$(link.dom).qtip({content:{text:tt},position:{target:'mouse',adjust:{mouse:true,x:11,y:13}}});}\u000areturn new XElement(container.get(0));}},drawHeader:function(){if(this.room)\u000avar detailsUrl=build_url(this.room.details_url,{preview_months:3});var singleDayHeader=Html.div({className:"bookingTitle",style:{marginBottom:pixels(20),marginTop:pixels(18),padding:0}},Html.a({href:detailsUrl,style:{paddingLeft:pixels(5),fontSize:"x-small"}},$T("( show 3 months preview )")));return Html.div({},singleDayHeader,this.RoomBookingCalendarDrawer.prototype.drawHeader.call(this));},drawContent:function(){var self=this;var days=[];each(this.data.days,function(day){days.push(self.drawDay(day));});if(days.length!=0)\u000areturn Html.div({style:{clear:'both',width:pixels(840),marginTop:pixels(15),marginBottom:pixels(40)}},Html.div({style:{width:pixels(120),height:pixels(20)}},Html.div({style:{cssFloat:'left',fontWeight:'bold'}},$T("Date")),this.drawHours()),days);return"";}},function(data){this.RoomBookingCalendarDrawer(data);this.room=this.data.days.length>0?this.data.days[0].rooms[0].room:null;});type("RoomBookingCalendarSummaryDrawer",[],{COMPARE_FUNCTIONS:{room:function(elem1,elem2){if(elem1.room.building!=elem2.room.building){return compare_alphanum(elem1.room.building,elem2.room.building);}else if(elem1.room.floor!=elem2.room.floor){return compare_alphanum(elem1.room.floor,elem2.room.floor);}else if(elem1.room.number!=elem2.room.number){return compare_alphanum(elem1.room.number,elem2.room.number);}\u000areturn 0;},date:function(elem1,elem2){return compare_alphanum(elem1.startDT.print("%y%m%d"),elem2.startDT.print("%y%m%d"));},time:function(elem1,elem2){return compare_alphanum(elem1.startDT.print("%H%M"),elem2.startDT.print("%H%M"));},owner:function(elem1,elem2){return compare_alphanum(elem1.owner,elem2.owner);},reason:function(elem1,elem2){return compare_alphanum(elem1.reason,elem2.reason);},},drawBars:function(sortBy){var self=this;sortBy=sortBy||'room';this.bars.sort(function(elem1,elem2){return self.ascendingSort*self.COMPARE_FUNCTIONS[sortBy](elem1,elem2);});this.sortedBy=sortBy;return _.map(this.bars,this.drawReservation.bind(this));},drawReservation:function(bar){if(!(bar.type=='barPreC'||bar.type=='barConf'||bar.type=='barPreConc'||bar.type=='barCand')){var showBookingLink=Html.a({href:bar.url},$T("Show"));var rejectionLink;if(bar.canReject){rejectionLink=Html.p({className:"fake-link"},$T("Reject"));rejectionLink.observeClick(function(){var textArea=Html.textarea({rows:4,cols:40});var popup=new ConfirmPopup($T("Rejecting a booking"),Html.div({style:{textAlign:'center'}},Html.p({},$T('Are you sure you want to REJECT the booking for '+bar.startDT.print("%H:%M %d/%m/%Y")+'?')),Html.p({},$T('If so, please give a reason:')),textArea),function(value){if(value){window.location=build_url(bar.rejectURL,{reason:textArea.dom.value});}}).open();});}\u000avar attrs={},cursorStyle='';if(bar.inDB||bar.type=='barCand'){attrs.onclick="window.open("+JSON.stringify(bar.url)+");";cursorStyle='pointer';}\u000areturn Html.div({onmouseover:"this.style.backgroundColor='#f0f0f0';",onmouseout:"this.style.backgroundColor='#ffffff';",style:{clear:'both',overflow:'auto',cursor:cursorStyle}},Html.div(attrs,Html.p({style:{cssFloat:'left',width:pixels(175),height:pixels(40)}},bar.room.getFullNameHtml(true)),Html.p({style:{cssFloat:'left',width:pixels(350),height:'auto'}},bar.reason,Html.br(),bar.owner),Html.p({style:{cssFloat:'left',width:pixels(90),height:pixels(40)}},bar.startDT.print("%d/%m/%Y")),Html.p({style:{cssFloat:'left',width:pixels(75),height:pixels(40)}},bar.startDT.print("%H:%M"),Html.br(),bar.endDT.print("%H:%M"))),Html.p({style:{cssFloat:'left',width:pixels(40),height:pixels(40)}},showBookingLink,rejectionLink));}else{return null;}},drawSummary:function(){var self=this,sort_links={},header=$('<div class="booking-list-header">');function draw_sort_link(criterion,caption){return $('<a href="#"/ class="sort-link sort-link-'+criterion+'">').append(caption,$('<img class="arrow arrow-up"/>').attr('src',imageSrc('upArrow')).hide(),$('<img class="arrow arrow-down"/>').attr('src',imageSrc('downArrow')).hide()).click(function(){var $this=$(this);self.ascendingSort=self.sortedBy==criterion?-self.ascendingSort:1;header.find('.arrow').hide();$this.find(self.ascendingSort==1?'.arrow-up':'.arrow-down').show();self.barsDiv.set(self.drawBars(criterion));return false;});}\u000athis.ascendingSort=1;[['room',$T('Room')],['reason',$T('Reason')],['owner',$T('Booked for')],['date',$T('Date')],['time',$T('Time')]].forEach(function(el){sort_links[el[0]]=draw_sort_link(el[0],el[1]);});sort_links.room.find('.arrow-up').show();header.append(sort_links.room,$('<span class="sort-link sort-link-reason-for"/>').append(sort_links.reason,' / ',sort_links.owner),sort_links.date,sort_links.time);this.barsDiv=Html.div({},this.drawBars("room"));return Html.div({},new Html(header.get(0)),this.barsDiv);},draw:function(){if(_.size(this.bars)>0){var self=this;var contentLoaded=false;var showContent=false;var arrowDown=Html.img({src:imageSrc("menu_arrow_black"),style:{display:"inline"}});var toggleSummary=Html.span({className:"fake-link",style:{paddingRight:pixels(2)}},$T("Display room booking summary "));toggleSummary.observeClick(function(){if(!contentLoaded){contentLoaded=true;content.set(self.drawSummary());}\u000aif(showContent){showContent=false;content.dom.style.display="none";toggleSummary.dom.innerHTML=$T("Display room booking summary ");arrowDown.dom.style.display='inline';}\u000aelse{showContent=true;content.dom.style.display="block";toggleSummary.dom.innerHTML=$T("Hide room booking summary");arrowDown.dom.style.display='none';}});var content=Html.div({});var rejectAllDiv=null;if(this.rejectAllLink){rejectAllDiv=Html.div({className:"fake-link",style:{width:pixels(800),textAlign:"center",paddingBottom:pixels(10)}},$T("Reject ALL Conflicting PRE-Bookings"));rejectAllDiv.observeClick(function(){new ConfirmPopup($T("Reject ALL Conflicting PRE-Bookings"),Html.div({},$T('Are you sure you want to REJECT ALL conflicting PRE-bookings?')),function(value){if(value)\u000awindow.location=self.rejectAllLink;}).open();});}\u000areturn Html.div({style:{clear:'both',marginTop:pixels(20)}},rejectAllDiv,Html.div({style:{width:pixels(800),textAlign:'center',paddingTop:pixels(10),paddingBottom:pixels(10)}},toggleSummary,arrowDown),content);}}},function(data){this.data=data;this.rejectAllLink=data.rejectAllLink;this.bars=this.data.getBars();});type("RoomBookingNavBar",[],{draw:function(firstHeader){var self=this;var startD=moment(self.data.firstDay,['YYYY-MM-DD','DD/MM/YYYY']);var endD=moment(self.data.lastDay,['YYYY-MM-DD','DD/MM/YYYY']);var periodDays=endD.diff(startD,'days')+1;var periodTitle=periodDays==1?$T('day'):periodDays==7?$T('week'):$T('period');var format='dddd, DD MMMM YYYY';var verbosePeriod=(self.data.firstDay==self.data.lastDay)?endD.format(format):'{0} \u279f {1}'.format(startD.format(format),endD.format(format));function loadNewPeriod(start,end){var form=$('#room-booking-calendar-form');form.find('input[name="start_date"]').val(moment(start).format(self.data.paramFormat));form.find('input[name="end_date"]').val(moment(end).format(self.data.paramFormat));form.submit();}\u000afunction showDateSelector(){var dlg=new DateRangeSelector(startD.toDate(),endD.toDate(),loadNewPeriod,$T("Choose Period"),true);dlg.open();}\u000avar keyHideEmpty='rb-hide-empty-rows-'+$('body').data('userId');function toggleHideEmpty(e,state){$('.room-row-empty, .day-empty').toggle(!state);$.jStorage.set(keyHideEmpty,state);}\u000a_.defer(function(){toggleHideEmpty(undefined,$.jStorage.get(keyHideEmpty,false));});var calendarButton=$('<a>',{'href':'#','title':self.data.canNavigate?$T('Change period'):undefined,'class':'i-button icon-calendar '+(self.data.canNavigate?'arrow':''),'html':verbosePeriod,'css':{'fontWeight':'normal','cursor':self.data.canNavigate?'pointer':'default','pointerEvents':self.data.canNavigate?'auto':'none'},'click':function(e){e.preventDefault();if(self.data.canNavigate){showDateSelector();}}});var prevButton=$('<a>',{'href':'#','title':$T('Previous')+' '+periodTitle,'class':'i-button icon-only icon-prev','click':function(e){e.preventDefault();loadNewPeriod(startD.subtract(periodDays,'days'),endD.subtract(periodDays,'days'));}});var nextButton=$('<a>',{'href':'#','title':$T('Next')+' '+periodTitle,'class':'i-button icon-only icon-next','click':function(e){e.preventDefault();loadNewPeriod(startD.add(periodDays,'days'),endD.add(periodDays,'days'));}});var filterButton=$('<a>',{'href':'#','title':'Filters','class':'i-button icon-only arrow icon-filter','data-toggle':'dropdown'});var filterDropdown=$('<ul class="dropdown">');$('<li>',{'class':'toggle','text':$T('Hide empty rooms/days'),'data':{'state':$.jStorage.get(keyHideEmpty,true)}}).on('menu_toggle',toggleHideEmpty).appendTo(filterDropdown);var toolbarContainer=$('<div>',{'class':'clearfix',css:{'marginBottom':'15px'}});var toolbar=$('<div>',{'class':'toolbar left','css':{'width':'810px'}}).appendTo(toolbarContainer);var toolbarGroup=$('<div>',{'class':'group left'}).appendTo(toolbar);if(!self.data.canNavigate){toolbarGroup.append(calendarButton);}\u000aelse{toolbarGroup.append(prevButton);toolbarGroup.append(calendarButton);toolbarGroup.append(nextButton);if(firstHeader){toolbarGroup=$('<div>',{'class':'group right'}).appendTo(toolbar);toolbarGroup.append(filterButton);toolbarGroup.append(filterDropdown);toolbar.dropdown();}}\u000areturn Html.div({},toolbarContainer[0]);}},function(data){this.data=data;});type("RoomBookingCalendar",[],{draw:function(){var parts=[];if(this.data.showLegend){parts.push(calendarLegend);}\u000aif(this.data.showNavBar){parts.push(new RoomBookingNavBar(this.data).draw(true));}\u000aparts.push(this.roomBookingCalendarContent.draw());if(this.data.showNavBar){parts.push(new RoomBookingNavBar(this.data).draw(false));}\u000aif(this.data.showSummary){parts.push(this.roomBookingCalendarSummary.draw());}\u000areturn parts;},addRepeatabilityBarsHovers:function(){var flexibleNumber=this.data.repeatFrequency?(2*this.data.flexibleDays+1):0;$('.wholeDayCalendarDiv').each(function(indexDiv){var flexibleIndex=flexibleNumber?indexDiv%flexibleNumber:indexDiv;$(this).find('.barCand').each(function(indexCand){var flexibility='repetition-{0}-{1}'.format(indexCand,flexibleIndex);$(this).addClass(flexibility).data('flexibility',flexibility);});});$('.barCand, .barBlocked').each(function(){var $this=$(this);var candBar=$this.hasClass('barCand')?$this:$this.prev('.barCand');var flexibility=candBar.data('flexibility');$(this).mouseover(function(){$('.wholeDayCalendarDiv').find('.barCand.'+flexibility).addClass('barDefaultHover');}).mouseleave(function(){$('.barCand').removeClass('barDefaultHover');});});}},function(options){options=$.extend({},{bars:null,dayAttrs:null,firstDay:null,lastDay:null,specificRoom:false,repeatFrequency:'0',finishDate:null,flexibleDays:0,rejectAllLink:'',openDetailsInNewTab:false,showLegend:true,showSummary:true,showNavBar:true,canNavigate:true,paramFormat:'DD/MM/YYYY'},options);this.data=new RoomBookingCalendarData(options);if(!this.data.specificRoom){this.roomBookingCalendarContent=new RoomBookingManyRoomsCalendarDrawer(this.data);}\u000aelse{this.roomBookingCalendarContent=new RoomBookingSingleRoomCalendarDrawer(this.data);}\u000athis.roomBookingCalendarSummary=new RoomBookingCalendarSummaryDrawer(this.data);});(function($){$.widget("indico.roomselector",{options:{allowEmpty:true,rooms:[],myRooms:[],roomMaxCapacity:0,userData:{},selectName:"roomselection",simpleMode:false,selectedRooms:null},_create:function(){var self=this;self._initData();self._initWidget();self._draw();self._setBindings();},destroy:function(){var self=this;self.select.multiselect("destroy");},selection:function(){var selection=[];$('.ui-multiselect-checkboxes :checkbox').each(function(index){if($(this).attr('aria-selected')=="true"){selection.push(index);}});return selection;},userdata:function(){var self=this;var data={};data.search=self.filter.search.val();data.videoconference=self.filter.videoconference.prop("checked");data.webcast=self.filter.webcast.prop("checked");data.projector=self.filter.projector.prop('checked');data.publicroom=self.filter.publicroom.prop("checked");data.capacity=self.filter.capacity.val();return data;},validate:function(){return this.select.val()!==null||this.options.allowEmpty;},scrollToFirstSelected:function(){var element=this.parts.list.find(':checkbox:checked').first();if(!element.length){return;}\u000avar parent=element.scrollParent();parent.scrollTop(parent.scrollTop()+element.position().top-element.height());},_initData:function(){var self=this;var name=self.options.selectName;var rooms=self.options.rooms;self.select=$("<select id='"+name+"' name='"+name+"' multiple='multiple'/>").appendTo(self.element);jQuery.map(rooms,function(room,i){var roomLoc=room.building+"-"+room.floor+"-"+room.number;var roomName=roomLoc+(roomLoc==room.name?'':' - '+room.name);var option=$("<option/>").attr("label",room.has_vc+":"+\u000aroom.has_webcast_recording+":"+\u000aroom.has_projector+":"+\u000aroom.is_public+":"+\u000a(room.capacity||'?')).attr("value",room.id).append($("<span/>").text(roomName)).append($("<span/>").text(" ("+room.location_name+")")).appendTo(self.select);});},_initWidget:function(){var self=this;self.select.multiselect({height:355,checkAllText:'All',uncheckAllText:'None',noneSelectedText:'0 selected',autoOpen:true,beforeclose:function(event,ui){return false;},classes:"RoomBooking",appendTo:"#"+$(self.element).prop('id'),position:{my:"left top",at:"left top",collision:"fitflip"}}).multiselectfilter({label:"",placeholder:$T('Filter rooms')}).multiselectfilter('advancedFilter');self.element.addClass('roomselector');self.element.find("button").css("display","none");self.widget=self.select.multiselect("widget");self.parts={list:self.widget.find(".ui-multiselect-checkboxes").scrollblocker(),header:self.widget.find(".ui-widget-header")};if(self.options.simpleMode){self.element.addClass('simple');}},_draw:function(){var self=this;self.select.on("multiselectrefresh",function(event,ui){self.element.find(".ui-multiselect").empty();self._drawHeader();self._drawRooms();self._drawFooter();});self.select.multiselect("refresh");$('input[name=multiselect_{0}]'.format(self.options.selectName)).each(function(idx,elem){$(elem).prop('name','');});self._restoreData();},_setBindings:function(){var self=this;var select=self.select;select.on("multiselectclick",function(event,ui){self._changestyle(self.parts.list.find('input[value="'+ui.value+'"]'));self._updateSelectionCounter();});select.on("multiselectcheckall",function(event,ui){self._changeSelectedStyleAll();self._updateSelectionCounter();});select.on("multiselectuncheckall",function(event,ui){self._changeSelectedStyleAll();self._updateSelectionCounter();});self.parts.list.on("click",".attributes",function(e){e.preventDefault();});self.parts.list.on("mouseleave",function(){$(this).find('label').removeClass('ui-state-hover');});},_applyShowMine:function(key,toggle){var filterIcon=this.parts.header.addClass("toolbar thin").find('.icon-filter');var state=$.jStorage.get(key,false);if(toggle){state=!state;}\u000a$.jStorage.set(key,state);$('.room-not-mine').toggle(!state);filterIcon.toggleClass('highlight',state);},_drawHeader:function(){var self=this;var header=self.parts.header.addClass("toolbar thin");var myRooms=self.options.myRooms;var filter=(self.filter={});self.filter.search=header.find(".ui-multiselect-filter input").attr("type","text");self.filter.videoconference=$("<input type='checkbox' id='videoconference' name='advanced_options'/>");self.filter.webcast=$("<input type='checkbox' id='webcast' name='advanced_options'/>");self.filter.projector=$("<input type='checkbox' id='projector' name='advanced_options'/>");self.filter.publicroom=$("<input type='checkbox' id='publicroom' name='advanced_options'/>");self.filter.capacity=$("<input type='text' id='capacity' value='0'/>");var keyShowMine='rb-show-my-rooms-'+$('body').data('userId');_.defer(function(){self._applyShowMine(keyShowMine);});var filterButton=$('<a>',{'href':'#','title':'Filters','class':'i-button icon-only arrow icon-filter'});if(myRooms.length>0){filterButton.attr('data-toggle','dropdown');}else{filterButton.addClass('disabled');}\u000avar filterDropdown=$('<ul class="dropdown">');$('<li>',{'class':'toggle','text':$T('Show only my rooms'),'data':{'state':$.jStorage.get(keyShowMine,false)}}).on('menu_toggle',function(e){self._applyShowMine(keyShowMine,true);}).appendTo(filterDropdown);header.find(".ui-multiselect-filter").addClass("group").empty().append($("<span class='i-button label icon-search'/>")).append(filter.search).on('click','a',function(e){e.stopPropagation();}).append(filterButton).append(filterDropdown).dropdown();filter.search.realtimefilter({callback:function(){self._updateFilter();}});var checkall=header.find(".ui-helper-reset .ui-multiselect-all").each(function(){$(this).html($(this).find("span:last-child").text());});var checknone=header.find(".ui-helper-reset .ui-multiselect-none").each(function(){$(this).html($(this).find("span:last-child").text());});var userId=$('body').data('userId');self.selecttools=$("<div/>").addClass("group").append($("<span class='i-button label'/>").text($T("Select"))).append(checkall.addClass("i-button")).append(checknone.addClass("i-button"));header.find(".ui-helper-reset").replaceWith(function(){return self.selecttools;});self.filtertools=$("<div class='group i-selection requirements'/>").append($("<span class='i-button label'/>").text($T("Require"))).append(filter.videoconference).append($("<label for='videoconference' class='i-button icon-camera'/>").attr("title",$T('Videoconference'))).append(filter.webcast).append($("<label for='webcast' class='i-button icon-broadcast'/>").attr("title",$T('Webcast'))).append(filter.projector).append($("<label for='projector' class='i-button icon-projector'/>").attr("title",$T('Projector'))).append(filter.publicroom).append($("<label for='publicroom' class='i-button icon-unlocked'/>").attr("title",$T('Public room'))).on("click","input",function(){self._updateFilter();}).appendTo(header);self.slider=$("<div class='group with-slider'/>").append($("<span class='i-button label'/>").text($T("Capacity"))).append($("<span class='i-button label slider'/>").append($("<span/>").slider({range:"min",min:0,max:self.options.roomMaxCapacity,value:1,step:5,create:function(event,ui){self._updateCapacitySlider(event,ui);},start:function(event,ui){self._updateCapacitySlider(event,ui);},slide:function(event,ui){self._updateCapacitySlider(event,ui);},stop:function(event,ui){filter.capacity.realtimefilter("update");}}))).append(filter.capacity).appendTo(header);filter.capacity.realtimefilter({clearable:false,emptyvalue:0,callback:function(){self._updateCapacitySlider();self._updateFilter();},validation:function(e){var val=e.val();if(val!==''&&(val<0||val>self.options.roomMaxCapacity||parseInt(val,10).toString()=='NaN')){return false;}else{return true;}}});},_drawRooms:function(){var self=this;var rooms=self.options.rooms;var myRooms=self.options.myRooms;var icons=["icon-camera","icon-broadcast",'icon-projector',"icon-unlocked","icon-user"];var activetitles=[$T("Videoconference available"),$T("Webcast/Recording available"),$T('Projector available'),$T("Public room"),$T("Maximum capacity")];var disabledtitles=[$T("Videoconference not available"),$T("Webcast/Recording not available"),$T('Projector not available'),$T("Private room")];var userId=$('body').data('userId');self.select.find("option").each(function(index){var labelparts=$(this).attr('label').split(":");var roomId=Number($(this).val());var item=self.parts.list.find('input[value="'+roomId+'"]').parent();if(!_.contains(myRooms,roomId)){item.addClass('room-not-mine');}\u000aitem.children("span").addClass("room-id").children(":first-child").addClass("roomname").next().addClass("roomlocation");var pic=$('<a>',{'class':'roompicture js-lightbox'}).append($("<img src='"+rooms[index].small_photo_url+"'/>")).prependTo(item);if(rooms[index].has_photo){pic.find("img").attr("title",$T("Expand picture")).addClass("active");pic.attr("href",rooms[index].large_photo_url);}\u000avar checkbox=$("<span class='checkbox'/>").prependTo(item);var attributes=$("<span class='attributes'/>").append($("<span class='icon-camera'/>")).append($("<span class='icon-broadcast'/>")).append($('<span class="icon-projector"/>')).append($("<span class='icon-unlocked'/>")).appendTo(item);var capacity=$("<span class='capacity'/>").append($("<span/>")).append($("<i class='icon-user'/>")).appendTo(item);for(var i=0;i<labelparts.length;i++){if(labelparts[i]!='None'&&labelparts[i].toLowerCase()!='false'){attributes.find("."+icons[i]).attr("title",activetitles[i]).addClass("active");if(!isNaN(labelparts[i])){var val=(labelparts[i]==="0")?"?":labelparts[i];capacity.attr("title",activetitles[i]).find("span").text(val);}}else{var attribute=attributes.find("."+icons[i]);attribute.attr("title",disabledtitles[i]);if(attribute.hasClass("icon-unlocked")){attribute.removeClass("icon-unlocked");attribute.addClass("icon-lock");}}}});},_drawFooter:function(){var self=this;self.parts.footer=$('<div class="ui-widget-footer"/>').append($('<div/>').addClass('ui-multiselect-selection-counter')).append($('<div/>').addClass('ui-multiselect-selection-summary')).appendTo(self.widget);self._updateSelectionCounter();},_restoreData:function(){var self=this;var userdata=self.options.userData;restoreSelection(userdata.selectedRooms);if(self.options.selectedRooms){restoreSelectedRooms();}\u000arestoreFilter(userdata);self._changeSelectedStyleAll();self.scrollToFirstSelected();function restoreSelection(selectedRooms){self.parts.list.find(":checkbox").each(function(index){if(_.contains(selectedRooms,index)){this.click();}});self._updateSelectionCounter();}\u000afunction restoreSelectedRooms(){self.parts.list.find(':checkbox:not(:checked)').each(function(){if(_.contains(self.options.selectedRooms,+this.value)){this.click();}});self._updateSelectionCounter();}\u000afunction restoreFilter(data){self.filter.search.realtimefilter('setValue',data.filter).trigger("propertychange");if(!self.options.simpleMode){self.filter.videoconference.prop('checked',data.videoconference);self.filter.webcast.prop('checked',data.webcast);self.filter.projector.prop('checked',data.projector);self.filter.publicroom.prop('checked',data.publicroom);self.filter.capacity.val(data.capacity).trigger("focusout");}\u000aself._updateFilter();}},_updateCapacitySlider:function(event,ui){var self=this;var capacity=self.filter.capacity;if(event&&event.type!="slidecreate"){capacity.val(ui.value);}\u000aself.parts.header.find(".ui-slider").slider('value',capacity.val());},_updateSelectionCounter:_.debounce(function(){var self=this;var opt=self.select.multiselect("option");var counter=self.parts.footer.find(".ui-multiselect-selection-counter");var count=self.parts.list.find("input:checked").length;var str=opt.selectedText.replace("#",count);counter.text(str).effect("pulsate",{times:1});},50),_updateFilter:function(){var self=this;var filter=self.filter;var filterString=filter.videoconference.is(':checked')+":"+\u000afilter.webcast.is(':checked')+":"+\u000afilter.projector.is(':checked')+':'+\u000afilter.publicroom.is(':checked')+":"+\u000afilter.capacity.val();self.select.multiselectfilter('advancedFilter',filterString);var total=self.parts.list.find("li").length;var displayed=self.parts.list.find('li:visible').length;self.parts.footer.find(".ui-multiselect-selection-summary").text(displayed+" / "+total+" rooms").effect("pulsate",{times:1});},_changeSelectedStyleAll:function(){var self=this;self.parts.list.find("input").each(function(){self._changestyle($(this));});},_changestyle:function(selector){selector.parent().toggleClass('ui-state-selected',selector.prop('checked'));}});})(jQuery);(function(){var validatingBooking=false;var validatingConflicts=false;var clickedButton=null;window.generateValidEndDates=function generateValidEndDates(startDate,endDate,frequency){if(!(startDate instanceof Date)||!(endDate instanceof Date)||[RRule.DAILY,RRule.WEEKLY,RRule.MONTHLY].indexOf(frequency)===-1){return null;}\u000avar position=Math.ceil(startDate.getDate()/7);if(position===5){position=-1;}\u000avar rule_data={freq:frequency,dtstart:startDate,until:endDate}\u000aif(frequency==RRule.MONTHLY){_.extend(rule_data,{byweekday:RRule[startDate.getDayName().slice(0,2).toUpperCase()],bysetpos:position});}\u000avar rule=new RRule(rule_data);return _.map(rule.all(),function(dt){if(dt<=startDate){return null;}\u000areturn dt.setHours(0,0,0,0);});};window.validateForm=function validateForm(){var isValid=true;if(!validatingBooking&&!validatingConflicts){return true;}\u000aif($('#timerange').length){isValid=isValid&&$('#timerange').timerange('validate');}\u000aif($('#repeatability').length){isValid=isValid&&validate_repeatability();}\u000afunction validInput($element){if($element.attr('id')==='room_usage'){return $('input[name=room_usage]:checked').val()!==undefined;}else if($element.attr('id')==='booked-for-user-wrapper'){if($('input[name=room_usage]:checked').val()==='other_user'){return $('#booked_for_user').val()!='[]';}\u000areturn true;}else{return!!$element.val().trim();}};$('#room_usage, #booked-for-user-wrapper, #booking_reason').each(function(){var $this=$(this);if(!validatingConflicts){var valid=validInput($this);isValid=isValid&&valid;$this.toggleClass('hasError',!valid);}else{$this.removeClass('hasError');}});if($('#uses_vc').length){var vcEnabled=$('#uses_vc').prop('checked');var vcErrors=vcEnabled!=!!$('.js-vc-row input:not(#needs_vc_assistance):checked').length;var vcLabel=$('label[for="uses_vc"]');vcLabel.toggleClass('text-error',vcErrors);if(vcErrors){vcLabel.attr('title','You need to select at least one piece of Videoconference equipment');}\u000aelse{vcLabel.qtip('destroy',true).removeAttr('title');}\u000aisValid=isValid&&!vcErrors;}\u000areturn isValid;};function validate_repeatability(){var valid=true;var single_day=false;var repeat_frequency=$('input[name=repeat_frequency]:checked').val();var repeatability;var message;switch(repeat_frequency){case"0":single_day=true;break;case"1":repeatability=RRule.DAILY;message=$T("Invalid end date for daily repetition");break;case"2":repeatability=RRule.WEEKLY;message=$T("Invalid end date for weekly repetition");break;case"3":repeatability=RRule.MONTHLY;message=$T("Invalid end date for monthly repetition");break;default:valid=false;}\u000avar start_date=$('#sDatePlace').datepicker('getDate');var end_date=$('#eDatePlace').datepicker('getDate');if(valid&&!single_day){valid=end_date>start_date;if(valid){var validEndDates=window.generateValidEndDates(start_date,end_date,repeatability);valid=!!validEndDates.length&&validEndDates.indexOf(end_date.getTime())!==-1;}}\u000avar label=$('#repeatability .label');if(!valid){if(typeof label.data('qtip')!=="object"){label.qtip({content:{text:message}});}else{label.qtip("api").set("content.text",message);}\u000alabel.addClass('invalid');$('#edate').addClass('invalid');}else{label.removeClass('invalid');if(typeof label.data('qtip')==="object"){label.qtip("api").destroy();}}\u000areturn valid;}\u000afunction validate_conflict(){var canSubmit=_.every($('.js-confirm-warning'),function(e){return e.checked;});var buttons=$('.js-submit-booking');var tooltip=$T('Please, confirm first you understood the implications of the conflicts mentioned above.');if($('#bookingForm').data('onlyConflicts')){tooltip=$T('Unable to book for the selected day(s).');canSubmit=false;}\u000abuttons.prop('disabled',!canSubmit);if(!canSubmit){if(!buttons.parent().hasClass('qtip-disabled-wrapper')){buttons.wrap($('<span>',{class:'qtip-disabled-wrapper'}));buttons.after($('<span>',{class:'qtip-disabled-holder',title:tooltip}));}}else{if(buttons.parent().hasClass('qtip-disabled-wrapper')){buttons.siblings('.qtip-disabled-holder').remove();buttons.unwrap();}}\u000areturn canSubmit;}\u000a$(function(){$('#searchForm').on('submit',function(e){validatingBooking=true;if(!validateForm()){e.preventDefault();}else if(!$("#roomselector").roomselector("validate")){new AlertPopup($T("Error"),$T('Please select a room (or several rooms).')).open();e.preventDefault();}else{saveFormData();}});$('.js-submit-booking, #submit_check').on('click',function(e){clickedButton=$(this).attr('name');if($(this).data('validation')=='check'){validatingConflicts=true;validatingBooking=false;}else{validatingConflicts=false;validatingBooking=true;}\u000aif(!validateForm()){e.preventDefault();new AlertPopup($T("Error"),$T('Please fill in all the required fields (highlighted in red).')).open();}});$('#bookingForm :input').on('input change',function(){validateForm();});$('#bookingForm').on('submit',function(e){if(validatingConflicts){return;}\u000ae.preventDefault();var extraData={};extraData[clickedButton]='1';var killProgress=IndicoUI.Dialogs.Util.progress();$(this).ajaxSubmit({dataType:'json',data:extraData,error:handleAjaxError,success:function(data){if(handleAjaxError(data)){return;}\u000aif(data.success){var userId=$('body').data('userId');$.jStorage.set('rb-user-{0}'.format(userId),{});location.href=data.url;}else{var error_box=$('.js-booking-creation-error-box').clone().show();var errors=error_box.find('.js-booking-creation-error-message');$.each(data.msg.split('\u005cn'),function addError(_,error){errors.append($('<li>',{text:error}));});new AlertPopup($T("Booking creation error"),error_box[0]).open();}},complete:function(){killProgress();}});});$('.js-confirm-warning').on('change',function(){validate_conflict();});validate_conflict();});})();
p1
.