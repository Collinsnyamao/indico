Vtype("UnscheduledContributionList",["SelectableListWidget"],{draw:function(){var self=this;var lastSort='friendly_id';var selectAll=Html.span('fake-link',$T('All'));var selectNone=Html.span('fake-link',$T('None'));var sortById=Html.span({className:'fake-link',id:'sortById',style:{fontWeight:'bold'}},$T('ID'));var sortByTitle=Html.span({className:'fake-link',id:'sortByTitle'},$T('Title'));var toolbar=Html.div({className:'toolbar',style:{margin:pixels(3)}},$T('Sort by: '),sortById,', ',sortByTitle,' ',$T('Select: '),selectAll,', ',selectNone);sortById.observeClick(function(){self._sortList('friendly_id',lastSort=='friendly_id');lastSort='friendly_id';});sortByTitle.observeClick(function(){self._sortList('title',lastSort=='title');lastSort='title';});selectAll.observeClick(function(){self.selectAll();});selectNone.observeClick(function(){self._clearSelection();});return[toolbar,this.SelectableListWidget.prototype.draw.call(this)];},_drawItem:function(pair){var self=this;var elem=pair.get();var speakers=translate(elem.get('speakerList'),function(speaker){return speaker.familyName;}).join(", ");var selected=false;var id=Html.em({'data-id':elem.get('friendly_id'),style:{paddingLeft:"5px",fontSize:'0.9em'}},elem.get('friendly_id'));return Html.div({},id," - ",elem.get('title')+(speakers?(' ('+speakers+')'):''));},_sortList:function(type,second_click){var self=this;var selected=_(this.getSelectedList().getAll()).map(function(item){return item.get('id');});var initial=_(self.getAll());$('#sortById').css('font-weight',(type=='friendly_id')?'bold':'');$('#sortByTitle').css('font-weight',(type=='title')?'bold':'');var sorted=initial.chain().map(function(value,key){return{key:key,value:value.get(type)};}).sortBy(function(item){return item.value;});this.reverseState=second_click?!this.reverseState:false;if(this.reverseState){sorted=sorted.reverse();}\u000aself._clearSelection();self.clear();var counter=0;sorted.each(function(item){self.set(counter+'',initial.value()[item.key]);counter++;});each(self.domList,function(listItem){if(selected.indexOf($(listItem.dom).find('em').data('id')+'')>-1){listItem.eventObservers.click();}});},getList:function(){return this.getSelectedList();},_clearSelection:function(){var self=this;self.clearSelection();if(exists(self.selectedObserver)){self.selectedObserver(self.selectedList);}}},function(existing,observer){var self=this;this.selected=new WatchList();this.reverseState=false;this.SelectableListWidget(observer,false,'UnscheduledContribList');each(existing,function(item,index){self.set(index,$O(item));});this._sortList('friendly_id');});type("AddContributionDialog",["ExclusivePopupWithButtons","PreLoadHandler"],{_preload:[function(hook){var self=this;var args={'confId':self.args.get('conference')};if(self.timetable.contextInfo.sessionSlotId){args.session_block_id=self.timetable.contextInfo.sessionSlotId;}\u000aif(self.timetable.isSessionTimetable){args.session_id=self.timetable.contextInfo.sessionId;}\u000a$.ajax({url:build_url(Indico.Urls.Timetable.contributions.notScheduled,args),cache:false,complete:IndicoUI.Dialogs.Util.progress(),error:handleAjaxError,success:function(data){self.existing=$L(data.contributions);self._processDialogState();hook.set(true);}});}],_processDialogState:function(){var self=this;if(this.existing.length.get()===0&&self.canCreateNew){var dialog=createObject(AddNewContributionDialog,self.newArgs);dialog.draw();this.open=function(){};}else{this.ExclusivePopupWithButtons($T("Add Contribution"),function(){self.close();});}},addExisting:function(contributionIds,date){var self=this;var urlArgs={'confId':self.args.get('conference')};if(self.args.get('slot')){urlArgs.block_id=self.args.get('slot');}\u000aif(self.timetable.isSessionTimetable){urlArgs.session_id=self.args.get('session');}\u000a$.ajax({url:build_url(Indico.Urls.Timetable.contributions.schedule,urlArgs),data:JSON.stringify({'contribution_ids':contributionIds,'day':date}),method:'POST',contentType:'application/json',complete:IndicoUI.Dialogs.Util.progress(),error:handleAjaxError,success:function(data){self.close();if(data){handleNotifications(data);self.timetable._updateDay(data.update);}}});},existingSelectionObserver:function(selectedList){if(typeof this.saveButton=='undefined'){return;}\u000aif(selectedList.isEmpty()){this.saveButton.disabledButtonWithTooltip('disable');}else{this.saveButton.disabledButtonWithTooltip('enable');}},_getButtons:function(){var self=this;return[[$T('Add selected'),function(){var ids=translate(self.unscheduledList.getList(),function(contrib){return contrib.get('id');});self.addExisting(ids,self.selectedDay);}],[$T('Close'),function(){self.close();}]];},draw:function(){var self=this;self.unscheduledList=new UnscheduledContributionList(self.existing,function(selectedList){self.existingSelectionObserver(selectedList);});var createNewLink;if(self.canCreateNew){createNewLink=Html.li({style:{marginBottom:'10px'}},Widget.link(command(function(){var dialog=createObject(AddNewContributionDialog,self.newArgs);self.close();dialog.draw();},$T("Create a new one"))));}\u000avar content=Html.div({},$T("You may choose to:"),Html.ul({},createNewLink,Html.li({},$T("Choose one (or more) unscheduled"),Html.div("UnscheduledContribListDiv",self.unscheduledList.draw()))));this.saveButton=this.buttons.eq(0);this.saveButton.disabledButtonWithTooltip({tooltip:$T('To add an unscheduled contribution, please select at least one'),disabled:true});return this.ExclusivePopupWithButtons.prototype.draw.call(this,content);}},function(args,timetable,callback,canCreateNew){var self=this;this.newArgs=Array.prototype.slice.call(arguments,0);this.args=args;this.selectedDay=args.get('selectedDay');this.callback=callback;this.timetable=timetable;this.canCreateNew=canCreateNew||false;this.PreLoadHandler(self._preload,function(){self.open();});});type("AddNewContributionDialog",[],{draw:function(){var self=this;var urlArgs={confId:self.args.get('conference'),day:self.args.get('selectedDay')};if(self.args.get('slot')){urlArgs.session_block_id=self.args.get('slot');}\u000aif(self.timetable.isSessionTimetable){urlArgs.session_id=self.args.get('session');}\u000aajaxDialog({url:build_url(Indico.Urls.Timetable.contributions.add,urlArgs),title:$T.gettext("Add contribution"),onClose:function(data){if(data){self.callback(data);}}});}},function(args,timetable,callback){var self=this;this.args=clone(args);this.timetable=timetable;this.callback=callback;});type("RescheduleDialog",["ExclusivePopupWithButtons"],{__getCurrentDayText:function(){return this.tt._titleTemplate(this.tt.currentDay);},__getIntervalTitle:function(){if(this.tt.contextInfo.slotTitle){return'"{0}: {1}"'.format(this.tt.contextInfo.title,this.tt.contextInfo.slotTitle);}else{return'"{0}"'.format(this.tt.contextInfo.title);}},__drawChooseAction:function(){var self=this;var actionChooseTitle=Html.div("rescheduleTitle",$T("Step 1: Choose type of rescheduling"));var startTimeRescheduleRB=Html.radio({name:"rescheduleAction",id:"startTimeRescheduleRB",style:{verticalAlign:"middle"}});var startTimeRescheduleExample=Html.a({href:Indico.Urls.ImagesBase+'/resched_ex_1.png',title:'Starting Time Example'},$T("See an example"));$(startTimeRescheduleExample.dom).colorbox();var startTimeRescheduleLabel=Html.label({style:{fontWeight:"normal"}},Html.div("rescheduleLabelTitle",$T("Adjust starting time of all entries")),Html.div("rescheduleLabelDetails",this.isTopLevelTimetable?$T("Move the entries of ")+this.__getCurrentDayText()+$T(" by changing their"):$T("Move the entries of the interval ")+this.__getIntervalTitle()+$T(" by changing their"),Html.strong({},$T(" starting times. ")),this.isTopLevelTimetable?$T("The first entry will start when the event starts (")+this.tt.eventInfo.startDate.time.slice(0,5)+"), ":$T("The first entry will start when the interval starts (")+this.tt.contextInfo.startDate.time.slice(0,5)+"), ",$T("and the other entries will follow consecutively after it. The durations of the entries will not change. "),startTimeRescheduleExample));startTimeRescheduleLabel.dom.htmlFor="startTimeRescheduleRB";var durationRescheduleRB=Html.radio({name:"rescheduleAction",id:"durationRescheduleRB",style:{verticalAlign:"middle"}});var durationRescheduleExample=Html.a({href:Indico.Urls.ImagesBase+'/resched_ex_2.png',title:'Duration Example'},$T("See an example"));$(durationRescheduleExample.dom).colorbox();var durationRescheduleLabel=Html.label({style:{fontWeight:"normal"}},Html.div("rescheduleLabelTitle",$T("Adjust duration of all entries")),Html.div("rescheduleLabelDetails",$T("Adjust the "),Html.strong({},$T(" duration ")),$T("of the entries of "),this.isTopLevelTimetable?this.__getCurrentDayText()+",":$T("the interval ")+this.__getIntervalTitle(),$T(" to fill the gaps between them, so that their starting time don't change. "+"If a time gap is specified, the duration will be extended up to the value of "+"this time gap before the starting time of the next entry. "),durationRescheduleExample));durationRescheduleLabel.dom.htmlFor="durationRescheduleRB";var actionChoose=Html.table({cellpadding:0,cellPadding:0,cellspacing:0,cellSpacing:0});var actionChooseTbody=Html.tbody();var startTimeRescheduleTr=Html.tr();startTimeRescheduleTr.append(Html.td("rescheduleAction",startTimeRescheduleRB));startTimeRescheduleTr.append(Html.td({className:"rescheduleAction",style:{paddingRight:pixels(5)}},startTimeRescheduleLabel));actionChooseTbody.append(startTimeRescheduleTr);var durationRescheduleTr=Html.tr();durationRescheduleTr.append(Html.td("rescheduleAction",durationRescheduleRB));durationRescheduleTr.append(Html.td({className:"rescheduleAction",style:{paddingRight:pixels(5)}},durationRescheduleLabel));actionChooseTbody.append(durationRescheduleTr);actionChoose.append(actionChooseTbody);startTimeRescheduleRB.observeClick(function(){if(self.rescheduleAction=="time"){if(self.fitInnerAction=="noFit"){self.rescheduleButton.disabledButtonWithTooltip('disable');}\u000aself.rescheduleAction="none";startTimeRescheduleTr.dom.className="";startTimeRescheduleRB.dom.checked=false;}\u000aelse{self.rescheduleButton.disabledButtonWithTooltip('enable');self.rescheduleAction="time";startTimeRescheduleTr.dom.className="selectedAction";durationRescheduleTr.dom.className="";}});durationRescheduleRB.observeClick(function(){if(self.rescheduleAction=="duration"){if(self.fitInnerAction=="noFit"){self.rescheduleButton.disabledButtonWithTooltip('disable');}\u000aself.rescheduleAction="none";durationRescheduleTr.dom.className="";durationRescheduleRB.dom.checked=false;}\u000aelse{self.rescheduleButton.disabledButtonWithTooltip('enable');self.rescheduleAction="duration";durationRescheduleTr.dom.className="selectedAction";startTimeRescheduleTr.dom.className="";}});return Html.div("rescheduleSection",actionChooseTitle,actionChoose);},__drawChooseInterval:function(){var self=this;var intervalTitle=Html.div("rescheduleTitle",$T("Step 2: Choose time gap between entries"));this.minuteInput=Html.input("text",{style:{width:"3em",textAlign:"right",marginTop:pixels(5),marginBottom:pixels(5)}},"0");var timeInputLabel=Html.span({style:{marginLeft:pixels(5)}},"(minutes)");var intervalInputDiv=Html.div({style:{textAlign:"center"}},this.minuteInput,timeInputLabel);this.intervalExplanationDiv=Html.div();this.minuteInput.observeEvent("change",function(event){self.__intervalObserver();});return Html.div("rescheduleSection",intervalTitle,intervalInputDiv,this.intervalExplanationDiv);},__drawFitInner:function(){var self=this;var fitInnerTitle=Html.div("rescheduleTitle",$T("Step 3: Choose to fit sessions to their content"));this.fitInnerCheckBox=Html.checkbox({},false);this.fitInnerCheckBox.dom.name='fitInnerCheckBox';var fitInnerLabel=Html.label({htmlFor:'fitInnerCheckBox',className:'rescheduleLabelTitle'},"Fit all the sessions contained on "+this.__getCurrentDayText()+" to their content.");var fitInnerDiv=Html.div({style:{textAlign:"center"}},this.fitInnerCheckBox,fitInnerLabel);this.fitInnerExplanationDiv=Html.div({className:'rescheduleLabelDetails',style:{paddingLeft:pixels(30),paddingTop:pixels(8)}});this.fitInnerExplanationDiv.set($T("This changes the start and end times of the session blocks occuring on "+this.__getCurrentDayText()+" in order to fit their respective content "),Html.strong({},$T("before")),$T(" performing the rescheduling."));this.fitInnerCheckBox.observeEvent("change",function(event){self.__fitInnerObserver();});return Html.div("fitInnerSection",fitInnerTitle,fitInnerDiv,this.fitInnerExplanationDiv);},__intervalObserver:function(){var minutes=this.minuteInput.get();var errors=false;if(!IndicoUtil.isInteger(minutes)||minutes<0){return;}\u000aminutes=parseInt(minutes,10);if(minutes===0){this.intervalExplanationDiv.set($T("There will be no gaps between consecutive entries."));}else{var h=Math.floor(minutes/60);var m=minutes%60;var intervalExplanationText=$T("Entries will be separated by gaps of ");if(h===1){intervalExplanationText+=$T("1 hour ");}else if(h>0){intervalExplanationText+=h+$T(" hours ");}\u000aif(h!==0&&m!==0){intervalExplanationText+=$T("and ");}\u000aif(m===1){intervalExplanationText+=$T("1 minute.");}else if(m>0){intervalExplanationText+=m+$T(" minutes.");}\u000athis.intervalExplanationDiv.set(intervalExplanationText);}},__fitInnerObserver:function(){var checked=this.fitInnerCheckBox.get();if(checked){this.rescheduleButton.disabledButtonWithTooltip('enable');this.fitInnerAction="doFit";}\u000aelse{if(this.rescheduleAction=="none"){this.rescheduleButton.disabledButtonWithTooltip('disable');}\u000athis.fitInnerAction="noFit";}},_getButtons:function(){var self=this;return[[$T('Reschedule'),function(){self.__reschedule();}],[$T('Cancel'),function(){self.close();}]];},__buildParameterManager:function(){this.parameterManager=new IndicoUtil.parameterManager();this.parameterManager.add(this.minuteInput,"non_negative_int",false);},__reschedule:function(){var self=this;if(this.parameterManager.check()){var confirmHandler=function(confirm){if(!confirm){return;}\u000avar urlArgs={confId:self.tt.eventInfo.id};var data={mode:self.rescheduleAction,gap:+self.minuteInput.get(),day:self.tt.currentDay,fit_blocks:self.fitInnerAction=='doFit'};if(self.isIntervalTimetable){data.session_block_id=self.tt.contextInfo.sessionSlotId;}else if(self.isTopLevelTimetable&&exists(self.tt.contextInfo.timetableSession)){data.session_id=self.tt.contextInfo.timetableSession.id;}\u000aif(self.tt.isSessionTimetable){urlArgs.session_id=self.tt.contextInfo.sessionId.toString();}\u000a$.ajax({url:build_url(Indico.Urls.Timetable.reschedule,urlArgs),method:'POST',data:JSON.stringify(data),contentType:'application/json',complete:IndicoUI.Dialogs.Util.progress($T.gettext("Rescheduling...")),error:handleAjaxError,success:function(){location.reload();}});};var confirmText=Html.div({},Html.div({},$T("Are you sure you want to reschedule entries "+\u000a(this.isTopLevelTimetable?"on "+this.__getCurrentDayText():"of the interval "+this.__getIntervalTitle())+"?")),Html.div({},this.fitInnerAction==="doFit"?$T("The entries that are part of a session will"):"",this.fitInnerAction==="doFit"?(this.rescheduleAction==="none"?"":$T(" first")):"",this.fitInnerAction==="doFit"?$T(" be fitted to their content."):""),this.rescheduleAction==="none"?Html.div({},""):Html.div({},(this.fitInnerAction==="doFit"?$T("Then, all entries "):$T("All entries ")),$T(" will have their "),this.rescheduleAction==="time"?$T("starting times"):$T("duration"),$T(" changed.")),Html.br(),Html.div("rescheduleWarning","This change cannot be undone."));var confirmPopup=new ConfirmPopup($T("Please review your choice"),confirmText,confirmHandler);confirmPopup.open();}},draw:function(){var self=this;this.rescheduleButton=this.buttons.eq(0);this.rescheduleButton.disabledButtonWithTooltip({tooltip:$T('Please select the rescheduling type'),disabled:true});var actionChooseDiv=this.__drawChooseAction();var intervalDiv=this.__drawChooseInterval();var actionFitDiv="";if(this.isTopLevelTimetable){actionFitDiv=this.__drawFitInner();}\u000athis.mainContent=Html.div({style:{width:pixels(450)}},actionChooseDiv,intervalDiv,actionFitDiv);this.__intervalObserver();if(this.isTopLevelTimetable){this.__fitInnerObserver();}\u000athis.__buildParameterManager();return this.ExclusivePopupWithButtons.prototype.draw.call(this,this.mainContent);}},function(parentTimetable){this.ExclusivePopupWithButtons($T('Reschedule Entries'));this.tt=parentTimetable;this.isTopLevelTimetable=exists(this.tt.TopLevelManagementTimeTable);this.isIntervalTimetable=exists(this.tt.IntervalManagementTimeTable);this.rescheduleAction="none";this.timeInput=null;this.fitInnerAction="noFit";this.rescheduleButton=null;});type("FitInnerTimetableDialog",["ConfirmPopup"],{__generateSessionBlockTitle:function(){if(this.tt.contextInfo.slotTitle){return'"{0}: {1}"'.format(this.tt.contextInfo.title,this.tt.contextInfo.slotTitle);}else{return'"{0}"'.format(this.tt.contextInfo.title);}},__getContent:function(){var msg=$T.gettext("This will change the starting and ending times of the session block {0} so that it encompasses all entries defined in its timetable.");return Html.div("fitInnerTimetableDialog",msg.format(this.__generateSessionBlockTitle()),Html.br(),$T.gettext("Are you sure you want to proceed?"));},__handler:function(confirm){var self=this;if(!confirm||!this.tt.IntervalManagementTimeTable){return;}\u000avar urlArgs={confId:self.tt.contextInfo.conferenceId,block_id:self.tt.contextInfo.sessionSlotId};if(self.tt.isSessionTimetable){urlArgs.session_id=self.tt.contextInfo.sessionId;}\u000a$.ajax({url:build_url(Indico.Urls.Timetable.sessionBlocks.fit,urlArgs),method:'POST',complete:IndicoUI.Dialogs.Util.progress($T.gettext("Fitting...")),error:handleAjaxError,success:function(){location.reload();}});}},function(parentTimetable){this.tt=parentTimetable;this.ConfirmPopup($T("Fit timetable to content"),this.__getContent(),this.__handler);});type("SessionSectionPopupMenu",["SectionPopupMenu"],{_processItem:function(pair){var self=this;var value=pair.get();var color=null;var title=null;if(exists(value.title)){title=value.title;}else{title=pair.key;}\u000aif(exists(value.color)){color=value.color;value=value.func;}\u000avar colorSquare=null;if(color!==null){colorSquare=Html.div({style:{backgroundColor:color,color:color,cssFloat:'right',width:'15px',height:'15px'}});}\u000avar link=Html.a({className:'fake-link',style:{display:'inline',padding:0,paddingLeft:'4px',paddingRight:'4px'}},Util.truncate(title));var divInput=Html.div({style:{height:'20px',overflow:'auto'}},colorSquare,link);if(typeof value=="string"){link.setAttribute('href',value);if(self.closeOnClick){link.observeClick(function(){self.close();});}}\u000aelse{link.observeClick(value.PopupWidget?function(e){if(self.selected){self.selected.dom.className=null;self.selected=null;}\u000alink.dom.className='selected';self.selected=link;var pos=listItem.getAbsolutePosition();each(self.items,function(item,key){if(item.PopupWidget&&item.isOpen()){item.close();}});value.open(pos.x+(value.alignRight?0:link.dom.offsetWidth),pos.y-1);return false;}:function(){value(self);if(self.closeOnClick){self.close();}});}\u000avar listItem=Html.li({},divInput);return listItem;}},function(items,chainElements,cssClass,closeOnClick,alignRight,closeHandler){this.SectionPopupMenu(items,chainElements,cssClass,closeOnClick,alignRight,closeHandler);});type("TimetableFilterList",["CheckPopupWidget"],{draw:function(x,y){return this.CheckPopupWidget.prototype.draw.call(this,x,y,300,{position:'fixed',left:pixels(x),bottom:pixels(y)});}},function(filterName,timetableDrawer,chainElements,noOptionsMessage){var filterObject=TimetableDefaults.filters[filterName].filter;var optionStates=filterObject.getOptionStates();var optionNames=filterObject.getOptionNames();var optionColors=filterObject.getOptionColors();var optionTextColors=filterObject.getOptionTextColors();optionStates.observe(function(){if(!timetableDrawer.preventRedraw)\u000atimetableDrawer.setLoading(true,timetableDrawer.redraw);});this.CheckPopupWidget(optionNames,optionStates,optionColors,optionTextColors,chainElements,noOptionsMessage);});type("TimetableFilterMenu",["PopupMenu"],{},function(triggerElement,timetableDrawer){var menu={};var self=this;each(TimetableDefaults.filters,function(value,key){menu[value.name]=new TimetableFilterList(key,timetableDrawer,[triggerElement,self],'No '+key+'s found');});this.PopupMenu(menu,[triggerElement]);this.timetableDrawer=timetableDrawer;});type("Filter",[],{getOptionNames:function(){return this.options;},getOptionStates:function(){return this.optionStates;},getOptionColors:function(){return this.optionColors;},getOptionTextColors:function(){return this.optionTextColors;},setData:function(data,day){this.data=data;this.day=day;this.computeOptions();},computeOptions:function(){var self=this;this.options.clear();this.optionStates.clear();var dayData=this.data[this.day];if(this.day=='all'){each(this.data,function(dayData,day){each(dayData,function(entryData,entry){self.processEvent(entryData,entry);});});}else{each(dayData,function(entryData,entry){self.processEvent(entryData,entry);});}},reset:function(){var self=this;each(this.options,function(value,id){self.resetEvent(id);});}},function(){this.options=new WatchObject();this.optionStates=new WatchObject();this.optionColors=new WatchObject();this.optionTextColors=new WatchObject();});type("SessionFilter",["Filter"],{apply:function(event){var show=true;this.optionStates.each(function(value,key){if(event.entryType=='Session'&&key==event.sessionId){if(!value){show=false;}}});return show;},processEvent:function(entryData,entry){var self=this;if(entryData.entryType=='Session'){self.options.set(entryData.sessionId,entryData.title);self.optionStates.set(entryData.sessionId,true);self.optionColors.set(entryData.sessionId,entryData.color);self.optionTextColors.set(entryData.sessionId,entryData.textColor);}},resetEvent:function(entry){this.optionStates.set(entry,true);}},function(){this.Filter();});type("RoomFilter",["Filter"],{apply:function(event){var show=true;this.optionStates.each(function(value,key){if(event.room==key){if(!value){show=false;}}});return show;},processEvent:function(entryData,entry){var self=this;if(exists(entryData.room)&&trim(entryData.room)!==''){self.options.set(entryData.room,entryData.room);self.optionStates.set(entryData.room,true);}},resetEvent:function(entry){this.optionStates.set(entry,true);}},function(){this.Filter();});type("TimeTableFilter",["IWidget"],{draw:function(){var self=this;var content=Html.div('content clearfix');var closeButton=Html.div('closeButton');closeButton.observeClick(function(e){if(self.closeHandler())\u000aself.show(false);});content.append(closeButton);this.tableRow=Html.tr();content.append(Html.table({cellPadding:0,cellSpacing:1,border:0},Html.tbody({},this.tableRow)));var sessionsLink=Html.span('i-button borderless dropup-menu',$T('Sessions'));var sessionsMenu=new TimetableFilterList('session',self.timetableDrawer,[sessionsLink],$T('No sessions in the timetable'));this.setUpFilterMenu(sessionsLink,sessionsMenu);var roomsLink=Html.span('i-button borderless dropup-menu',$T('Rooms'));var roomsMenu=new TimetableFilterList('room',self.timetableDrawer,[roomsLink],$T('No rooms found in the timetable'));this.setUpFilterMenu(roomsLink,roomsMenu);this.tableRow.insert(Html.td({style:{width:'90px',color:'#777',fontWeight:'bold'}},$T('Filter options')));var resetButton=Html.input('button',{style:{cssFloat:'right',marginRight:'50px'}},$T('Reset filter'));resetButton.observeClick(function(){each(TimetableDefaults.filters,function(TTfilter){TTfilter.filter.reset()});});this.tableRow.append(Html.td({style:{width:'auto'}},resetButton));this.div.append(content);this.height=$(self.div.dom).height();this.div.dom.style.display='none';},setUpFilterMenu:function(link,menu)\u000a{var self=this;this.tableRow.append(Html.td({},link));link.observeClick(function(){if(menu.active){menu.close();return;}\u000avar pos=link.getAbsolutePosition();menu.open(pos.x-30,self.height);});},show:function(show){this.state.set(!this.state.get());if(show)\u000a$(this.div.dom).show("slide",{direction:"down"},200);else\u000a$(this.div.dom).hide("slide",{direction:"down"},200);},toggle:function(){this.show(!this.state.get())}},function(timetableDrawer,closeHandler){var self=this;this.timetableDrawer=timetableDrawer;this.closeHandler=closeHandler;this.state=new WatchValue(false);this.div=Html.div({className:'timetableFilter',style:{display:"none"}});$E(document.body).append(this.div);});type("TimetableLayoutManager",[],{_buildCheckpointTable:function(data){var checkpoints={};var addCheckpoint=function(key,time,type,sessionId,sessionSlotId){if(!checkpoints[time]){checkpoints[time]=[];}\u000acheckpoints[time].push([key,type,sessionId,sessionSlotId]);};var orderedKeys=keys(data);orderedKeys.sort(function(e1,e2){if(exists(data[e1].sessionCode)&&exists(data[e2].sessionCode)){var byCode=SortCriteria.Integer(data[e1].sessionCode,data[e2].sessionCode);if(byCode!=0){return byCode;}}\u000areturn SortCriteria.Integer(e1,e2);});each(orderedKeys,function(key){var value=data[key];var sTime=value.startDate.time.replace(/:/g,'');var eTime=value.endDate.time.replace(/:/g,'');if(value.isPoster&&value.duration>(TimetableDefaults.wholeDay*60)){addCheckpoint(key,sTime,'wholeday',value.sessionId,value.sessionSlotId);}\u000aelse{addCheckpoint(key,sTime,'start',value.sessionId,value.sessionSlotId);if(eTime>=sTime){addCheckpoint(key,eTime,'end');}else if(eTime=='000000'){addCheckpoint(key,'240000','end');}\u000aelse{addCheckpoint(key,'nextday','end');}}});this.checkpoints=checkpoints;return checkpoints;},pointsBetween:function(hStart,hEnd){var result=[];each(this.checkpoints,function(points,time){if((hStart=='nextday'&&time=='nextday')||(hStart!='nextday'&&time>hStart&&time<hEnd))\u000a{result=concat(result,points);}});return result;},assign:function(assigned,block){var ks=keys(assigned);ks.sort();for(var key in ks){if(!assigned[key]){block.assigned=key;assigned[key]=block;return;}}\u000avar newElem=ks.length;block.assigned=newElem;assigned[newElem]=block;},reorderAssigned:function(assigned,lastAssigned,currentGroup,currentPos){var getLastAssignedId=function(block){return"{0}l{1}".format(block.sessionId,block.sessionSlotId);};var correctlyAssigned=function(block){return exists(lastAssigned[getLastAssignedId(block)])&&lastAssigned[getLastAssignedId(block)].col==block.assigned;};var numAssignedBlocks=function(sessionId){return keys(lastAssigned[sessionId].blocks).length;};var lastAssign=function(block,col){if(!exists(lastAssigned[getLastAssignedId(block)])){lastAssigned[getLastAssignedId(block)]={'blocks':{}};}\u000aif(col!==undefined){lastAssigned[getLastAssignedId(block)].col=col;}\u000alastAssigned[getLastAssignedId(block)].blocks[block.id]=true;};var reassign=function(block,col){assigned[block.assigned]=null;block.assigned=col;assigned[col]=block;lastAssign(block,col);};var swap_columns=function(block1,block2){var block1_old_col=block1.assigned;reassign(block1,block2.assigned);reassign(block2,block1_old_col);assigned[block1.assigned]=block1;};for(var key in currentGroup){var block=currentGroup[key];if(!exists(block.sessionId)){continue;}\u000aif(exists(lastAssigned[getLastAssignedId(block)])){lastAssign(block);}else{lastAssign(block,block.assigned);continue;}\u000aif(correctlyAssigned(block)){continue;}\u000avar preferedCol=lastAssigned[getLastAssignedId(block)].col;var existingBlock=assigned[preferedCol];if(!existingBlock){if(block.start==currentPos&&preferedCol<_(assigned).size()){reassign(block,preferedCol);}}else if(!exists(existingBlock.sessionId)||!exists(lastAssigned[existingBlock.sessionId])||numAssignedBlocks(block.sessionId)>numAssignedBlocks(existingBlock.sessionId)){if(existingBlock.start==block.start){swap_columns(existingBlock,block)}}}},getBlock:function(blocks,key){var block;if(blocks[key]){block=blocks[key];}else{block=blocks[key]={id:key,collapsed:false};}\u000areturn block;},addWholeDayBlock:function(blocks,key){blocks[key]={id:key};},getNumColumnsForGroup:function(group){return group[1];},getHeader:function(){return null;},shouldShowRoom:function(){return true;},reorderColumns:function(group){}});type("IncrementalLayoutManager",["TimetableLayoutManager"],{name:'incremental',drawDay:function(data,detailLevel,startTime,endTime,managementMode){var self=this;this.eventData=data;this.detailLevel=any(detailLevel,'session');var checkpoints=this._buildCheckpointTable(data);var ks=keys(checkpoints);ks.sort();managementMode=any(managementMode,true);var startingHour,endingHour;if(ks.length>1){startingHour=parseInt(ks[0].substring(0,2),10);var last=ks.length-1;while(!endingHour&&last>=0){endingHour=parseInt(ks[last].substring(0,2),10);last--;}}else{startingHour=parseInt(any(startTime,'8:00').split(':')[0],10);endingHour=parseInt(any(endTime,'17:00').split(':')[0],10);}\u000avar endMin;var algData={grid:[],assigned:{},blocks:{},active:0,currentGroup:[],topPx:0,groups:[],extraPx:{},lastAssigned:{},wholeDayBlocks:{}};var hEnd;if(managementMode){if(startingHour>0){for(var min=0;min<60;min+=TimetableDefaults.resolution){self.processTimeBlock(startingHour-1,startingHour,(startingHour-1)*60,min,algData);}}}\u000afor(var minutes=0;minutes<((endingHour+1-startingHour)*60);minutes+=TimetableDefaults.resolution){var startMin=(startingHour*60+minutes);endMin=(startingHour*60+minutes+TimetableDefaults.resolution);var hStart=zeropad(parseInt(startMin/60,10))+''+zeropad(startMin%60);hEnd=zeropad(parseInt(endMin/60,10))+''+zeropad(endMin%60);self.processTimeBlock(hStart,hEnd,startMin,minutes,algData);}\u000aif($L(ks).indexOf('nextday')!==null){self.processTimeBlock('nextday','nextday',(startingHour*60+minutes),minutes,algData);}else if(endMin/60<25&&managementMode){algData.grid.push([(endMin/60)%24,algData.topPx]);}\u000avar counter=0;each(algData.groups,function(group){self.reorderColumns(group[0]);each(group[0],function(block){block.group=counter;});counter++;});return[algData.topPx,algData.grid,algData.blocks,algData.groups,algData.wholeDayBlocks];}});type("CompactLayoutManager",["IncrementalLayoutManager"],{name:'compact',processTimeBlock:function(hStart,hEnd,startMin,minutes,algData){var self=this;var points=self.pointsBetween(hStart,hEnd);var incrementPx=0;var block;var smallBlockList=[];var pxStep=Math.floor(TimetableDefaults.layouts.compact.values.pxPerHour*TimetableDefaults.resolution/60);var endPoints=[];each(points,function(point){if(point[1]=='end'){block=self.getBlock(algData.blocks,point[0]);block.end=algData.topPx;if(algData.assigned[block.assigned]){algData.active--;algData.assigned[block.assigned]=null;var diff=TimetableDefaults.layouts.compact.values.minPxPerBlock-(block.end-block.start);if(diff>0){block.end+=diff;incrementPx=diff>incrementPx?diff:incrementPx;algData.topPx+=incrementPx;}\u000aif(hStart=='nextday'){block.end+=hStart=='nextday'?20:0;block.unfinished=true;}\u000aendPoints.push(block);}else{smallBlockList.push(block);}}});if(endPoints.length){var maxPx=_(endPoints).max(function(block){return block.end;}).end;_(endPoints).each(function(block){block.end=maxPx;});}\u000aif(minutes%60===0){algData.grid.push([startMin/60%24,algData.topPx]);}\u000aif(!algData.active){if(algData.currentGroup.length>0){algData.groups.push([algData.currentGroup,keys(algData.assigned).length]);algData.currentGroup=[];algData.assigned={};}}\u000avar blockAdded=false;each(points,function(point){if(point[1]=='start'){blockAdded=true;block=self.getBlock(algData.blocks,point[0]);block.sessionId=point[2];block.sessionSlotId=point[3];block.start=algData.topPx;algData.active++;self.assign(algData.assigned,block);algData.currentGroup.push(block);}else if(point[1]=='wholeday'){self.addWholeDayBlock(algData.wholeDayBlocks,point[0]);}});if(blockAdded){self.reorderAssigned(algData.assigned,algData.lastAssigned,algData.currentGroup,algData.topPx);}\u000aif(algData.active>0){var extraPx=0;each(algData.extraPx,function(value,key){if(value>extraPx){extraPx=value;}});algData.topPx+=pxStep+extraPx;}else{algData.topPx+=TimetableDefaults.layouts.compact.values.pxPerSpace;}\u000aeach(smallBlockList,function(block){block.end=block.start+TimetableDefaults.layouts.compact.values.minPxPerBlock;algData.topPx+=TimetableDefaults.layouts.compact.values.minPxPerBlock;algData.assigned[block.assigned]=null;algData.active--;});}});type("ProportionalLayoutManager",["IncrementalLayoutManager"],{name:'proportional',processTimeBlock:function(hStart,hEnd,startMin,minutes,algData){var self=this;var points=self.pointsBetween(hStart,hEnd);var incrementPx=0;var block;var pxStep=Math.floor(TimetableDefaults.layouts.proportional.values.pxPerHour*TimetableDefaults.resolution/60);var smallBlocks=[];each(points,function(point){if(point[1]=='end'){block=self.getBlock(algData.blocks,point[0]);block.end=algData.topPx;if(algData.assigned[block.assigned]){algData.active--;algData.assigned[block.assigned]=null;var diff=TimetableDefaults.layouts.proportional.values.minPxPerBlock-(block.end-block.start);if(diff>0){block.end+=diff;block.collapsed=true;algData.topPx+=diff;}\u000aif(hStart=='nextday'){block.end+=hStart=='nextday'?20:0;block.unfinished=true;}}else{smallBlocks.push(block);}}});var hour=startMin/60;if(minutes%60===0&&hour<=24){algData.grid.push([hour%24,algData.topPx]);}\u000aif(!algData.active){if(algData.currentGroup.length>0){algData.groups.push([algData.currentGroup,keys(algData.assigned).length]);algData.currentGroup=[];algData.assigned={};}}\u000aeach(points,function(point){if(point[1]=='start'){block=self.getBlock(algData.blocks,point[0]);block.start=algData.topPx;algData.active++;self.assign(algData.assigned,block);algData.currentGroup.push(block);}});each(smallBlocks,function(block){algData.active--;algData.assigned[block.assigned]=null;block.collapsed=true;block.end=algData.topPx+TimetableDefaults.layouts.proportional.values.minPxPerBlock;});if(smallBlocks.length>0){algData.topPx+=TimetableDefaults.layouts.proportional.values.minPxPerBlock;}\u000aalgData.topPx+=pxStep;}});type("RoomLayoutManager",["CompactLayoutManager"],{drawDay:function(data,detailLevel,startTime,endTime){this.roomsCols={};return this.CompactLayoutManager.prototype.drawDay.call(this,data,detailLevel,startTime,endTime);},assign:function(assigned,block){var roomName=this.eventData[block.id].room;var col=0;if(!exists(this.roomsCols[roomName])){if(trim(roomName)!==""){col=this.roomsCols[roomName]=keys(this.roomsCols).length;}}else{col=this.roomsCols[roomName];}\u000ablock.assigned=col;assigned[col]=block;},reorderColumns:function(currentGroup){var self=this;var roomNames=keys(this.roomsCols);roomNames.sort();this.roomsCols={};var counter=0;each(roomNames,function(name){self.roomsCols[name]=counter;counter++;});for(var key in currentGroup){var block=currentGroup[key];var roomName=this.eventData[block.id].room;var col=0;if(trim(roomName)!==""){col=this.roomsCols[roomName];}\u000ablock.assigned=col;}},getNumColumnsForGroup:function(group){if(group[0].length==1&&this.eventData[group[0][0].id].room===""){return 1;}else{return keys(this.roomsCols).length;}},getHeader:function(width){var roomNames=keys(this.roomsCols);var cols=roomNames.length;var borderPixels=1;return Html.div({style:{marginLeft:pixels(TimetableDefaults.leftMargin),paddingBottom:pixels(10),paddingTop:pixels(20)}},translate(roomNames,function(key){return Html.div({className:"headerRoomLayoutTimeTable",style:{width:pixels(Math.floor((width-TimetableDefaults.leftMargin)/cols)-borderPixels)}},key);}));},shouldShowRoom:function(){return false;}},function(){this.roomsCols={};});type("PosterLayoutManager",["TimetableLayoutManager"],{drawDay:function(data,detailLevel){return data;}});type("UndoMixin",[],{updateUndoDiv:function(tt_status_info){var undo_contents=$('<a href="#" class="i-button icon-undo warning hidden"/>').text($T('Undo last operation')).click(function(){$('body').trigger('timetable_undo');return false;});var elem=tt_status_info||$('#tt_status_info');if($(window).data('undo')){elem.show().html($('<div class="group right"/>').append(undo_contents));}else{elem.hide();}},enableUndo:function(undoLabel,savedData){$(window).data('undo',{label:undoLabel,data:$.extend(true,{},savedData)});this.updateUndoDiv();}});function highlight_undo(elemId){var elem=activeTT.get_elem(elemId);if((elem.offset().top>($(window).scrollTop()+$(window).height()))||((elem.offset().top+elem.height())<$(window).scrollTop())){$('html, body').animate({scrollTop:elem.offset().top-150},500);}\u000aelem.effect("pulsate",{times:3},500)}\u000afunction undo_action(){var undo_info=$(window).data('undo');var data=undo_info.data;var management=activeTT.managementActions;var ordinalStartDate=Util.formatDateTime(data.eventData.startDate,IndicoDateTimeFormats.Ordinal);var dfr;if((undo_info.label=="placementChange")||(undo_info.label=="resize")){dfr=management.editEntryStartEndDate(Util.formatDateTime(data.eventData.startDate,IndicoDateTimeFormats.Server),Util.formatDateTime(data.eventData.endDate,IndicoDateTimeFormats.Server),data.eventData,data.shifted,null);}else if(undo_info.label=="drop"){var oldBlock=data.eventData.sessionId?(data.eventData.sessionId+":"+data.eventData.sessionSlotId):"conf:"+ordinalStartDate;var oldStartDate=Util.formatDateTime(data.eventData.startDate,IndicoDateTimeFormats.Server);dfr=management.moveToSession(data.entry,oldBlock,null,oldStartDate);}\u000areturn dfr.done(function(){highlight_undo(data.eventData.id);});}\u000afunction goto_slot(slotId){return activeTT.switchToInterval(slotId).then(function(){return undo_action();});}\u000afunction goto_origin(data){var ordinalStartDate=Util.formatDateTime(data.eventData.startDate,IndicoDateTimeFormats.Ordinal);var parentTT=activeTT.parentTimetable?activeTT.parentTimetable:activeTT;var inSlot=!!activeTT.parentTimetable;var toSlot=!!data.eventData.sessionId&&data.eventData.entryType=='Contribution';var goto_day=function(day){var next_step=function(){if(toSlot){var slotId='s'+data.eventData.sessionId+'l'+data.eventData.sessionSlotId;return goto_slot(slotId);}else{return undo_action();}};if(parentTT.currentDay!=day){return parentTT.setSelectedTab(day).then(next_step);}else{return next_step();}};if(inSlot){if(toSlot&&activeTT.contextInfo.id==('s'+data.eventData.sessionId+'l'+data.eventData.sessionSlotId)){return undo_action();}else{return parentTT.switchToTopLevel().then(function(){return goto_day(ordinalStartDate);});}}else if(!inSlot){return goto_day(ordinalStartDate);}}\u000a$(function(){if($('#timetableDiv').data('mode')!='management'){return;}\u000a$("body").bind('timetable_undo',function(){var undo_info=$(window).data('undo');var data=undo_info.data;var ordinalStartDate=Util.formatDateTime(data.eventData.startDate,IndicoDateTimeFormats.Ordinal);goto_origin(data).done(function(){$(window).removeData('undo');});}).bind("timetable_ready",function(event,tt){tt.updateUndoDiv();});});var TimetableDefaults={topMargin:30,bottomMargin:40,leftMargin:55,rightMargin:5,resolution:1,menuWidth:150,blockMargin:4,wholeday:7,minContribHeight:20,layouts:{'compact':{name:"Compact",values:{pxPerHour:150,pxPerSpace:2,minPxPerBlock:50},manager:new CompactLayoutManager()},'proportional':{name:'Proportional',values:{pxPerHour:120,minPxPerBlock:25},manager:new ProportionalLayoutManager()},'poster':{name:'Poster',manager:new PosterLayoutManager()},'room':{name:'Room',manager:new RoomLayoutManager()}},filters:{'session':{name:$T('Session'),filter:new SessionFilter()},'room':{name:$T('Room'),filter:new RoomFilter()}}};type("TimeTable",["HistoryListener"],{_draw:function(timetableDiv){return $('<div/>').css({width:this.width}).append($('<div/>').css('display','block'),this.legend,this.header,timetableDiv.dom,this.loadingIndicator.dom).get();},_getMenu:function(){return Html.div();},postDraw:function(){this.timetableDrawer.postDraw();},getData:function(){return this.data;},get_elem:function(blkId){return $(this.getTimetableDrawer()._blockMap[blkId]);},getById:function(id){var info=Util.parseId(id);var type=info[0];var compositeId="";info=info.slice(2);if(type=='Conference'){return this.eventInfo;}\u000aelse if(type=='Contribution'){throw'not implemented!';}else if(type=='Session'){return this.eventInfo.sessions[info[0]];}else if(type=='SessionSlot'){compositeId='s'+info[0]+'l'+info[1];}else{throw'unrecognized id!';}\u000afor(var day in this.data){if(this.data[day][compositeId]){return this.data[day][compositeId];}}},setSelectedTab:function(val){var dfr=$.Deferred();$('body').one('timetable_ready',function(){dfr.resolve();});this.JLookupTabWidget.prototype.setSelectedTab.call(this,val);return dfr.promise();},getTimetableDrawer:function(){return this.timetableDrawer;},setData:function(data,intervalData,startTime,endTime){this.timetableDrawer.setData(data,startTime,endTime);},_createLoadingIndicator:function(){return Html.div('timetableLoading',$T('Updating the timetable...'));},_getHeader:function(){return Html.div({});},_getLegend:function(){return Html.div({});},_functionButtons:function(){return[];},redrawLegend:function(){return;}},function(data,width,wrappingElement,detailLevel,managementMode){var self=this;this.data=data;this.enabled=true;this.processedWarnings=new WatchList();this.width=width;this.loadingIndicator=this._createLoadingIndicator();this.header=this._getHeader();this.legend=$('<div/>');});type("DisplayTimeTable",["TimeTable"],{filterMenu:function(){var self=this;var filterLink=Html.a({href:'#'},$T("Filter"));this.filterMenu=new TimetableFilterMenu(filterLink,self.timetableDrawer);filterLink.observeClick(function(e){var pos=filterLink.getAbsolutePosition();self.filterMenu.open(pos.x+filterLink.dom.offsetWidth,pos.y);return false;});return Html.ul({className:"inner",style:{display:'none'}},Html.li("menuConfMiddleCell",filterLink));},printMenu:function(){var self=this;var printLink=Html.a({href:'#'},$T("Printable version"));printLink.observeClick(function(e){self.print();});return Html.ul({className:"inner",style:{display:'none'}},Html.li("menuConfMiddleCell",printLink));},print:function(){var self=this;self.timetableDrawer.setPrintableVersion(true);var timetableElements=translate(self.timetableDrawer.canvas.dom.childNodes,function(value){return value;});var goBackLink=$('<a/>').prop('href',window.location.hash).html($T('Go back')).css('font-size','17px');var separator=$('<a/>').html(' | ').css('fontSize','17px');var printLink=$('<a/>').prop('href',window.location.hash).html($T('Print')).css('font-size','17px');var links=$('<span/>').append(goBackLink,separator,printLink).css('float','right');var header=$('<div/>').addClass('timetableHeader clearfix').append(links).css({'padding':'0px 5px 5px 5px','border-bottom':'1px solid black','text-align':'center','width':self.timetableDrawer.width});header.append($('<span/>').append(self._titleTemplate(self.timetableDrawer.day)).css('float','left'));goBackLink.click(function(){location.reload();});printLink.click(function(){window.print();});var timetableDiv=$('<div/>').append(timetableElements).css({'padding-top':'20px','position':'relative'});$("body").html(header.add(timetableDiv));$("body").css("padding","30px");},pdf:function(){if($('html').data('static-site')){window.location=build_url(Indico.Urls.Timetable.default_pdf,{confId:this.eventInfo.id});}else{ajaxDialog({url:build_url(Indico.Urls.Timetable.pdf,{confId:this.eventInfo.id}),title:$T.gettext('Export to PDF')});}},fullScreen:function(){var self=this;IndicoUI.Dialogs.Util.progress($T("Switching to full screen mode..."));setTimeout(function(){self.timetableDrawer.width=$(window).width()-50;var header=$('<div/>').addClass('timetableFullScreenHeader clearfix').css('width',self.timetableDrawer.width);header.append($('<span/>').append(self._titleTemplate(self.timetableDrawer.day)).css('float','left'));var timetableCanvas=$('#timetable_canvas');$('#timetable_canvas').width('width',self.timetableDrawer.width);$("body").html(header);$("body").css("padding","30px");$(".timetableFullScreenHeader").before(self._getExtraButtons());$(".timetableFullScreenHeader").before(self.legend);$(".timetableFullScreenHeader").after(timetableCanvas);self.timetableDrawer.redraw(self.currentDay);self._filterSetup();if(self.timetableDrawer.detail.get()=='contribution'){var newDetailLevel=self.timetableDrawer.detail.get()=='contribution'?'session':'contribution';self.timetableDrawer.detail.set(newDetailLevel);self.toggleDetailedView();}},50);},_getExtraButtons:function(){var self=this;var container=$('<div class="tabExtraButtons"/>');var goBackButton={'btn':Html.div('buttonWhite',$T('Exit Full Screen')),'onclick':function(btnContainer){location.reload();}};var buttons=self._functionButtons();buttons[2]=goBackButton;$.each(buttons,function(i,btnData){var btn=$('<div class="buttonContainer"/>').append(btnData.btn.dom||btnData.btn).click(function(){btnData.onclick(btn);});container.append(btn);});container.children(':first').addClass('buttonContainerLeft');container.children(':last').addClass('buttonContainerRight');goBackButton.btn.getParent().dom.style.background="#9F883B";return container;},_filterSetup:function(){var self=this;this.filter=new TimeTableFilter(this.timetableDrawer,function(){self.filterButtonContainer.css('background','');return true;});this.filter.draw();},toggleDetailedView:function(){var self=this;var detailLevel=this.timetableDrawer.detail.get();var newDetailLevel=detailLevel=='contribution'?'session':'contribution';this.timetableDrawer.detail.set(newDetailLevel);var state=(newDetailLevel=='contribution');this.inDetailedMode=state;this.detailsButton.btn.getParent().dom.style.background=state?"#9F883B":"";this._addToHistory(this.currentDay+(state?'.detailed':''));var legend;if(this.inDetailedMode){legend=this._getLegend();this.legend.replaceWith(legend);if(this._legendActive){self._toggleLegend(true);}else{self._legendPostDraw();}}else{if(this._legendActive){self._toggleLegend(false);}\u000alegend=$('<div/>');this.legend.replaceWith(legend)}\u000athis.legend=legend;},_functionButtons:function(){var self=this;this.printButton={'btn':Html.div('printButtonWhite',$T('Print')),'onclick':function(btnContainer){self.print();}};this.pdfButton={'btn':Html.div('buttonWhite',$T('PDF')),'onclick':function(btnContainer){self.pdf();}};this.fullScreenButton={'btn':Html.div('buttonWhite',$T('Full screen')),'onclick':function(btnContainer){self.fullScreen();}};this.linkButton=Html.div('linkButtonWhite',$T('Link'));this.detailsButton={'btn':Html.div({className:'buttonWhite',id:'detailsButton'},Html.span({},$T('Detailed view'))),'onclick':function(){self.toggleDetailedView();}};this.filterButton={'btn':Html.div('buttonWhite',$T('Filter')),'onclick':function(btnContainer){self.filterButtonContainer=btnContainer;self.filter.toggle();var state=self.filter.state.get();self._filterActive=state;btnContainer.css('background',state?"#9F883B":"");}};return[this.printButton,this.pdfButton,this.fullScreenButton,this.detailsButton,this.filterButton];}},function(data,width,wrappingElement,detailLevel){this.TimeTable(data,width,wrappingElement,detailLevel,false);if(keys(data).length>1){this.data.all=data;}});type("TopLevelTimeTableMixin",["JLookupTabWidget"],{draw:function(){return this.JLookupTabWidget.prototype.draw.call(this);},getDays:function(){return this.sortedKeys;},disable:function(){this.enabled=false;this.JLookupTabWidget.prototype.disable.call(this);},enable:function(){this.enabled=true;this.JLookupTabWidget.prototype.enable.call(this);},_titleTemplate:function(text){if(text=='all'){return $T('All days');}\u000avar day=text.substring(6,8);var month=text.substring(4,6);var strDate=day+'/'+month+'/'+text.substring(0,4);var delements=parseDate(strDate);var nDate=new Date(delements[2],delements[1]-1,delements[0]);return Indico.Data.WeekDays[nDate.getDay()].substring(0,3)+' '+day+'/'+month;},_parseDayInterval:function(hash){var m=hash.match(/#(\u005cd{8}|all)(?:\u005c.((?:s\u005cd+)|detailed))?/);if(m){return[m[1],m[2]];}else{return[null,null];}},switchToInterval:function(intervalId){var dfr=$.Deferred();this.disable();var intervalInfo=this.data[this.currentDay][intervalId];var data=intervalInfo.entries;this.intervalTimeTable=new IntervalManagementTimeTable(this,data,intervalInfo,this.eventInfo,this.width.slice(0,-2),this.canvas[0],'contribution',this.isSessionTimetable,this.customLinks,this.canManageSession,this.canManageBlocks,this.canManageContribs);this.intervalTimeTable.setData(intervalInfo);var content=this.intervalTimeTable.draw();this.canvas.html(content[0]);this.intervalTimeTable.postDraw();$('body').trigger('timetable_switch_interval',this.intervalTimeTable);dfr.resolve();return dfr.promise();},postDraw:function(){this.TimeTable.prototype.postDraw.call(this);},switchToTopLevel:function(day){day=day||this.currentDay;var dfr=$.Deferred();this.enable();this.setSelectedTab(day||this.currentDay);this._generateContent(this.getSelectedPanel());this.timetableDrawer.redraw();var header=this._getHeader();this.header.replaceWith(header);this.header=header;$('body').trigger('timetable_switch_toplevel',this);window.location='#'+day;dfr.resolve();return dfr.promise();}},function(data,width,wrappingElement,detailLevel,managementActions,historyBroker,timetableLayoutId){var self=this;this.managementActions=managementActions;this.canvas=Html.div({});historyBroker.addListener(this);this.timetableDrawer=new TimetableDrawer(this,width,wrappingElement,detailLevel,this._functionButtons(),this.loadingIndicator,!!managementActions,managementActions,timetableLayoutId);this.sortedKeys=keys(this.data);this.sortedKeys.sort();var today=new Date();var todayStr=IndicoUtil.formatDate2(today);var originalHash=window.location.hash;var dayAndInterval=this._parseDayInterval(originalHash);var initialTab=null;if(dayAndInterval[0]){initialTab=dayAndInterval[0];}\u000aif(initialTab===null){if(exists(data[todayStr])){initialTab=todayStr;}else{for(var day in this.data){if(Object.getOwnPropertyNames(this.data[day]).length>0){initialTab=day;break;}}\u000aif(initialTab===null){initialTab=this.sortedKeys[0];}}}\u000athis.currentDay=initialTab;this.JLookupTabWidget(translate(this.sortedKeys,function(key){return[key,function(){var detailed=self.inDetailedMode?'.detailed':'';self.currentDay=key;if(key=='all'){self._addToHistory('all'+detailed);return self._draw(self.timetableDrawer.drawAllDays());}else{if(!self.enabled){throw"stopDrawing";}\u000aself._addToHistory(key+detailed);return self._draw(self.timetableDrawer.drawDay(key));}}];}),this.width,100,initialTab,this._functionButtons(),this.canvas);this.makeScrollable();if(dayAndInterval[1]){var subref=dayAndInterval[1];setTimeout(function(){if(subref=='detailed'){self.toggleDetailedView();}else{self.switchToInterval(subref);}},500);}});type("IntervalTimeTableMixin",[],{draw:function(){this.parentTimetable._addToHistory(this.currentDay+'.'+this.contextInfo.id);return this._draw(this.timetableDrawer.drawDay(this.currentDay));},_getInfoBoxContent:function(){return Html.div({},Html.span({style:{fontStyle:'italic',fontSize:'0.9em'}},$T('You are viewing the contents of the session block:')),Html.div({style:{fontWeight:'bold',marginTop:'5px',fontSize:'1.3em'}},this._generateSlotTitle(this.contextInfo),Html.span({style:{fontWeight:'normal'}}," (",$B(Html.span({}),this.slotStartTime)," - ",$B(Html.span({}),this.slotEndTime),")")));},postDraw:function(){this.timetableDrawer.postDraw();},setData:function(data){var day=IndicoUtil.formatDate2(IndicoUtil.parseJsonDate(data.startDate));var ttData={};this.data=data.entries;this.slotStartTime=new WatchValue(data.startDate.time.substring(0,5));this.slotEndTime=new WatchValue(data.endDate.time.substring(0,5));ttData[day]=data.entries;this.currentDay=day;this.timetableDrawer.setData(ttData,day,data.isPoster);this.infoBox.set(this._getInfoBoxContent());},getDays:function(){return this.parentTimetable.getDays();},getById:function(id){return this.parentTimetable.getById(id);}},function(parent,width,wrappingElement,managementActions,layout){this.managementActions=managementActions;this.parentTimetable=parent;this.timetableDrawer=new IntervalTimetableDrawer(this,width,wrappingElement,this._functionButtons(),this.loadingIndicator,!!managementActions,managementActions,layout||'compact');});type("ManagementTimeTable",["TimeTable","UndoMixin"],{_generateSlotTitle:function(slotData){return slotData.title+(slotData.slotTitle?": "+slotData.slotTitle:'');},_createInfoArea:function(){var closeButton=Html.div({className:'balloonPopupCloseButton',style:{position:'absolute',top:'10px',right:'10px',padding:'0px'}});var self=this;closeButton.observeClick(function(){self._hideWarnings();});return Html.div("timetableManagementInfoArea",Html.div({},$T("Your changes triggered the automatic modification of some settings:")),$B(Html.ul({}),this.processedWarnings,function(item){var title=item[4];var atoms=Util.parseId(item[1]);var message={OWNER_START_DATE_EXTENDED:{SessionSlot:$T('The <strong>starting time</strong> of the session interval <strong>')+title+$T('</strong> was moved from '),Session:$T('The <strong>starting time</strong> of the session interval <strong>')+title+$T('</strong> was moved from '),Conference:$T('The <strong>starting time</strong> of the <strong>Event</strong> was moved from ')},OWNER_END_DATE_EXTENDED:{SessionSlot:$T('The <strong>ending time</strong> of the session interval <strong>')+title+$T('</strong> was moved from '),Session:$T('The <strong>ending time</strong> of the session interval <strong>')+title+$T('</strong> was moved from '),Conference:$T('The <strong>ending time</strong> of the <strong>Event</strong> was moved from ')},ENTRIES_MOVED:{SessionSlot:$T('The contents of the interval <strong>')+title+$T('</strong> were moved from ')}}[item[0]][atoms[0]];var span=Html.span({style:{verticalAlign:'middle',marginLeft:'5px'}});span.dom.innerHTML=message+' <strong>'+item[3]+'</strong>'+$T(' to ')+'<strong>'+item[2]+'</strong>';return Html.li({},span);}),closeButton);},_updateMovedEntry:function(result,oldEntryId){return this._updateEntry(result,oldEntryId,function(data){var oldDate=IndicoUtil.formatDateTime(IndicoUtil.parseJsonDate(result.old.startDate),'d/MM/YYYY hh:mm');var oldDay=Util.formatDateTime(Util.parseDateTime(oldDate,IndicoDateTimeFormats.Default),IndicoDateTimeFormats.Ordinal);if(result.old.sessionId){delete data[oldDay]['s'+result.old.sessionSlotEntryId].entries[result.old.id];}else{delete data[oldDay][result.old.id];}\u000aif(result.slotEntry){data[result.day][result.slotEntry.id].entries[result.id]=result.entry;data[result.day][result.slotEntry.id].startDate.time=result.slotEntry.startDate.time;data[result.day][result.slotEntry.id].endDate.time=result.slotEntry.endDate.time;data[result.day][result.slotEntry.id].duration=result.slotEntry.duration;}else{data[result.day][result.id]=result.entry;}});},_processAutoOps:function(result){this._hideWarnings();var self=this;if(result.autoOps&&result.autoOps.length>0){each(result.autoOps,function(op){var warning=self._processWarning(op);if(warning&&self.processedWarnings.indexOf(warning)===null){self.warningArea.dom.style.display='block';self.processedWarnings.append(warning);}});}},_hideWarnings:function(){this.warningArea.dom.style.display='none';this.warnings.clear();this.processedWarnings.clear();},_processWarning:function(entry){var msg=entry[1];var finalTime=entry[3];var type=Util.parseId(entry[2])[0];var conference=null;var slot=null;var title="";var startTime="";var endTime="";if(type=="Session"){return null;}else if(type=='Conference'){conference=this.getById(entry[2]);title=conference.title;startTime=conference.startDate.time.slice(0,5);endTime=conference.endDate.time.slice(0,5);}else if(type=='SessionSlot'){slot=this.getById(entry[2]);startTime=slot.startDate.time.slice(0,5);endTime=slot.endDate.time.slice(0,5);title=this._generateSlotTitle(slot);}\u000aif(msg=="OWNER_END_DATE_EXTENDED"){if(endTime!=finalTime){return concat(entry.slice(1),[endTime,title]);}}else if(msg=="OWNER_START_DATE_EXTENDED"){if(startTime!=finalTime){return concat(entry.slice(1),[startTime,title]);}}else{return concat(entry.slice(1),[startTime,title]);}\u000areturn null;},_allowCreateHere:function(elementType){switch(elementType){case'Session':return(this.contextInfo._type=="Conference");case'Break':return(this.contextInfo._type=="Conference"?true:(this.contextInfo.isPoster===false));case'Contribution':return true;}},_retrieveSessionColor:function(session){return this.getById("s"+session.id).color;},_openSessionMenu:function(triggerElement,parent){if(exists(this.addMenu)&&this.addMenu.isOpen()){return;}\u000avar self=this;var sessions={};each(this.eventInfo.sessions,function(session,key){sessions[session.id]={};sessions[session.id].func=function(){self.managementActions.addSessionSlot(session);};sessions[session.id].color=self._retrieveSessionColor(session);sessions[session.id].title=session.title;});var menu={'':{content:{'Create a new session':function(){self.managementActions.addSession();$('.button-menu').dropdown('close');}},description:''},'Add another block to:':{content:sessions,description:''}};var te=new Html(triggerElement.find('a').get(0));var sessMenu=new SessionSectionPopupMenu(menu,[te],'timetableSectionPopupList popupListChained',true,true);var pos=triggerElement.offset();sessMenu.open(pos.left,pos.top-1);},_createAddMenu:function(elem){var self=this;var ul=$('<ul class="dropdown"/>');if(this._allowCreateHere('Session')){var sessionAdd=$('<a href="#"/>').text($T('Session block')).appendTo(ul).wrap("<li/>");sessionAdd.bind('menu_select',function(){if(keys(self.eventInfo.sessions).length===0){$(this).closest('.group').dropdown('close');self.managementActions.addSession();}else{self._openSessionMenu($(this).parent(),ul);}\u000areturn true;});}\u000aif(this._allowCreateHere('Contribution')){$('<a href="#"/>').text($T('Contribution')).bind('menu_select',function(){self.managementActions.addContribution();$(this).closest('.group').dropdown('close');return false;}).appendTo(ul).wrap("<li/>");}\u000aif(this._allowCreateHere('Break')){$('<a href="#"/>').text($T('Break')).bind('menu_select',function(){self.managementActions.addBreak();$(this).closest('.group').dropdown('close');return false;}).appendTo(ul).wrap("<li/>");}\u000areturn ul;},_getHeader:function(){var self=this;this.infoBox=Html.div({className:'toolbar f-j-end',style:{'margin':'5px'}});this.addMenuLink=this.contextInfo.isPoster?$('<a href="#" data-toggle="menu_select"/>').text($T('Add poster')).bind('menu_select',function(){self.managementActions.addContribution();}):$('<a href="#" id="add_new" class="arrow hide-if-locked" data-toggle="dropdown">').text($T('Add new'));this.rescheduleLink=$('<a href="#" class="hide-if-locked" data-toggle="menu_select">').text($T('Reschedule'));this.rescheduleLink.bind('menu_select',function(){var popup=new RescheduleDialog(self);popup.open();return false;});this.fitInnerTimetableLink=$('<a href="#" class="hide-if-locked" data-toggle="menu_select">').text($T('Fit to content'));this.fitInnerTimetableLink.bind('menu_select',function(){var popup=new FitInnerTimetableDialog(self);popup.open();return false;});this.addIntervalLink=$('<a href="#" class="hide-if-locked" data-toggle="menu_select"/>').text($T('Add new block'))\u000athis.addIntervalLink.bind('menu_select',function(){self.managementActions.addSessionSlot(self.eventInfo.timetableSession);return false;});var customLinks=$();for(var linkName in this.customLinks){var link=$('<a href="#" class="hide-if-locked">').text(linkName).addClass('js-{0}'.format(this.customLinks[linkName])).data('timetable',self);customLinks=customLinks.add(link);}\u000athis.warningArea=this._createInfoArea();this.warningArea.dom.style.display='none';this.menu=$('<div class="group"/>');if(this.isSessionTimetable&&this.isTopLevel){if(this.canManageBlocks){this.menu.append(this.addIntervalLink);}}\u000aelse{this.menu.append(this.addMenuLink);}\u000aif(!this.contextInfo.isPoster){if(this.canManageBlocks){if(this.contextInfo.entryType=='Session'){this.fitInnerTimetableLink.appendTo(this.menu);}\u000athis.rescheduleLink.appendTo(this.menu);}}\u000acustomLinks.appendTo(this.menu);var tt_hour_tip=$('<div id="tt_hour_tip"/>').hide().append($('<img/>').prop('src',imageSrc('tt_time')).prop('title',$T("Add one hour")));var tt_status_info=$('<div id="tt_status_info" />');this.menu.children('a').addClass('i-button');if(!this.contextInfo.isPoster&&(!this.isTopLevel||!this.sessionTimetable)){this.menu.find('#add_new').after(this._createAddMenu(this.addMenuLink.parent()));}\u000avar ret=$('<div/>').append(this.warningArea.dom,$('<div id="headPanel" class="ui-follow-scroll"></div>').append($('<div class="toolbar f-j-end" id="tt_menu"/>').append(this.menu.dropdown({effect_on:'slideDown'}),tt_status_info)),this.infoBox.dom,tt_hour_tip);var extra=this.getTTMenu();if(extra){ret.find('#tt_menu .group').after(extra);}\u000areturn ret;}},function(data,contextInfo,eventInfo,width,wrappingElement,detailLevel,customLinks,canManageSession,canManageBlocks,canManageContribs,canManageEvent){this.customLinks=customLinks;this.eventInfo=eventInfo;this.contextInfo=contextInfo;this.canManageSession=canManageSession||false;this.canManageBlocks=canManageBlocks||false;this.canManageContribs=canManageContribs||false;this.canManageEvent=canManageEvent||false;this.warnings=new WatchList();this.TimeTable(data,width,wrappingElement,detailLevel,true);});type("TopLevelDisplayTimeTable",["DisplayTimeTable","TopLevelTimeTableMixin"],{_retrieveHistoryState:function(hash){var currentDay=this._parseDayInterval(hash)[0];this.setSelectedTab(currentDay);},_getLegend:function(){var self=this;self._maxLegendItemsShownInitially=4;var toggleLegendButton=$('<div id="legendMainToggle">'+\u000a$T("Session legend")+'</div>');if(this._legendActive){toggleLegendButton.addClass('active');}\u000atoggleLegendButton.click(function(){self._legendActive=!self._legendActive;self._toggleLegend(self._legendActive);});self._toggleLegendButton=toggleLegendButton;this.legendItems=self._legendItemsContainer();this.legendItems.hide();this.legendItems.bind('update',function(){$(this).html(self._legendItemsContainer().children());if(self._legendActive&&self.legendSessionInfo[self.currentDay].length){$(this).slideDown();}else{$(this).slideUp();}\u000aself._legendPostDraw();});return $('<div id="wholeLegend"/>').append(toggleLegendButton).append(this.legendItems);},_legendItemsContainer:function(){var self=this;var state=false;var moreText=$T("see more...");var showMoreLink=$('<a id="showMoreLink" class="showMoreLink">'+moreText+'</a>').click(function(){if(!state){self._fadeShowAllLegendItems();showMoreLink.text($T('less...'));}else{self._fadeHideLegendItems();showMoreLink.text(moreText);}\u000aself._legendPostDraw();state=!state;});var closeButton=$('<div class="legendCloseButton"/>').click(function(){self._toggleLegend(false);self._legendActive=false;});var sessions=self.legendSessionInfo[this.currentDay];var container=$('<div id="timeTableLegend" class="timeTableLegend ui-follow-scroll">').append(closeButton);if(sessions.length){var legendElements=self._generateLegendDivItems(sessions);container.append($('<div id="legendItemContainer"/>').append(legendElements));if(sessions.length>self._maxLegendItemsShownInitially){container.append(showMoreLink);}}\u000areturn container;},_generateLegendDivItems:function(sessions){var self=this;var showNumSessionsCounter=0;var container=$('<div>');$.each(sessions,function(idx,l){var div=$('<div class="legendItem" />').append($('<div class="timeTableItemColour" />').css('background',l[2]),$('<span/>').text(l[1]));container.append(div);if(idx>=self._maxLegendItemsShownInitially){div.hide();}});return container;},redrawLegend:function(){if(this.legendItems){this.legendItems.trigger('update');}},_fadeShowAllLegendItems:function(){$('.legendItem').fadeIn();},_fadeHideLegendItems:function(){$('.legendItem').slice(this._maxLegendItemsShownInitially).fadeOut();},_toggleLegend:function(state){var self=this;if(state){$('#legendMainToggle').addClass('active');if(this.legendSessionInfo[this.currentDay].length){$('#timeTableLegend').slideDown();}}else{$('#timeTableLegend').slideUp();$('#legendMainToggle').removeClass('active');}\u000athis._legendPostDraw();},_legendPostDraw:function(){var self=this;var initialTruncing=null;var i=0;$('.legendItem').each(function(){var titleIsTruncated=false;var fullTitle=$(this).text();initialTruncing=fullTitle.length;var span=$(this).children('span');while(span.get(0).offsetHeight>25||span.get(0).offsetWidth>130){titleIsTruncated=true;var truncSessionTitle=TimetableBlockBase.prototype.truncateTitle(--initialTruncing,fullTitle);span.html(truncSessionTitle);}\u000aif(titleIsTruncated){$(this).qtip({content:fullTitle,position:{my:'top middle',at:'bottom middle'}});}});if($('#detailsButton').length){$('#legendMainToggle').position({my:'left top',at:'left bottom',of:$('#detailsButton').parent('.buttonContainer')});$('#timeTableLegend:visible').width($('#timeTableLegend').get(0).clientWidth-10);}},_extractSessionInfo:function(data){var days={};_(data).each(function(entries,day){days[day]=_(entries).chain().select(function(e){return e.entryType=='Session';}).groupBy(function(e){return e.sessionId;}).reduce(function(l,s){return l.concat(s[0]);},[]).map(function(e){return[e.id,e.title,e.color,e.sessionId];}).sortBy(function(e){return e[1];}).value();});days['all']=_(days).chain().flatten(true).groupBy(function(e){return e[3];}).reduce(function(l,s){return l.concat([s[0]]);},[]).sortBy(function(e){return e[1];}).value();return days;}},function(data,contextInfo,width,wrappingElement,detailLevel,historyBroker,timetableLayoutId){this.postDraw=TopLevelTimeTableMixin.prototype.postDraw;this.legendSessionInfo=this._extractSessionInfo(data);this._legendActive=true;this.DisplayTimeTable(data,width,wrappingElement,detailLevel);this.TopLevelTimeTableMixin(data,width,wrappingElement,detailLevel,null,historyBroker,timetableLayoutId);this.eventInfo=contextInfo;this._filterSetup();});type("TopLevelManagementTimeTable",["ManagementTimeTable","TopLevelTimeTableMixin"],{_deleteOldEntry:function(data,result,oldEntryId){var oldStartDate;if(result.entry.entryType=="Session"&&data[this.currentDay][result.id]){var slot=data[this.currentDay][result.id];oldStartDate=slot.startDate.date.replace(/-/g,'');}else{oldStartDate=this.currentDay;}\u000adelete data[oldStartDate][oldEntryId];return data[oldStartDate][oldEntryId]?data[oldStartDate][oldEntryId].entries:null;},_updateEntry:function(result,oldEntryId,updateCycle){var self=this;var data=this.getData();this._processAutoOps(result);var oldContent=this._deleteOldEntry(data,result,oldEntryId);if(updateCycle){updateCycle(data);}else{if(exists(result.slotEntry)){data[result.day][result.slotEntry.id].entries[result.entry.id]=result.entry;}else{data[result.day][result.id]=result.entry;}\u000aif(oldContent){data[result.day][result.id].entries=result.entry.entryType=="Session"?result.entry.entries:oldContent;}\u000aif(result.session){this.eventInfo.sessions[result.session.id]=result.session;}}\u000avar dfr=$.Deferred();$('body').one('timetable_redraw',function(){$('body').trigger('timetable_update',self);dfr.resolve();});this.timetableDrawer.redraw();return dfr.promise();},_updateDay:function(update){this._processAutoOps(update);var data=this.getData();var entries={};entries[update.day]=update.entries;extend(data,entries);this._removeMissingEntries(update.entries,update.day);if(exists(update.session)){this.eventInfo.sessions[update.session.id]=update.session;}\u000avar self=this;var dfr=$.Deferred();$('body').bind('timetable_redraw',function(){dfr.resolve();$('body').trigger('timetable_update',self);});this.timetableDrawer.redraw();return dfr.promise();},_removeMissingEntries:function(entries,day){var self=this;_.each(self.data[day],function(value,key){if(!entries[key]){delete self.data[key];}});},_updateSessionData:function(sessionId,fields,newValues){var data=this.getData();for(var day in data){for(var entry in data[day]){if(data[day][entry]["entryType"]=="Session"&&data[day][entry]["sessionId"]==sessionId){for(var i=0;i<fields.length;++i){data[day][entry][fields[i]]=newValues[i];}}}}\u000athis.timetableDrawer.redraw();},_getInfoBoxContent:function(){return'';},getTTMenu:function(){if(this.isSessionTimetable&&this.canManageEvent){var goBackLink=$('<a>',{'class':'icon-arrow-up i-button','href':build_url(Indico.Urls.Timetable.management,{'confId':this.eventInfo.id})}).text($T.gettext('Go to event timetable'));return $('<div>',{'class':'group right'}).append(goBackLink);}else{return null;}},_retrieveHistoryState:function(hash){var dayInterval=this._parseDayInterval(hash);var currentDay=dayInterval[0]||keys(this.data)[0];if(dayInterval[1]){this.setSelectedTab(dayInterval[0]);this.switchToInterval(dayInterval[1]);}else{this.switchToTopLevel();this.setSelectedTab(dayInterval[0]);}}},function(data,eventInfo,width,wrappingElement,detailLevel,historyBroker,isSessionTimetable,customLinks,canManageSession,canManageBlocks,canManageContribs,canManageEvent){this.isSessionTimetable=isSessionTimetable;this.isTopLevel=true;this.ManagementTimeTable(data,eventInfo,eventInfo,width,wrappingElement,detailLevel,customLinks,canManageSession,canManageBlocks,canManageContribs,canManageEvent);var managementActions=new TopLevelTimeTableManagementActions(this,eventInfo,eventInfo,isSessionTimetable);this.TopLevelTimeTableMixin(data,width,wrappingElement,detailLevel,managementActions,historyBroker,'proportional');this.postDraw=TopLevelTimeTableMixin.prototype.postDraw;});type("IntervalManagementTimeTable",["ManagementTimeTable","IntervalTimeTableMixin"],{_updateTimes:function(newStartTime,newEndTime){this.slotStartTime.set(newStartTime.slice(0,5));this.slotEndTime.set(newEndTime.slice(0,5));},_updateEntry:function(result,oldEntryId,updateCycle){var self=this;var slot=this.contextInfo;delete this.parentTimetable.data[this.currentDay][slot.id].entries[oldEntryId];this._processAutoOps(result);if(updateCycle){updateCycle(this.parentTimetable.getData());}else{if(result.session){this.parentTimetable.eventInfo.sessions[result.session.id]=result.session;}\u000aif(exists(result.slotEntry)){result.slotEntry.entries=slot.entries;this.parentTimetable.data[result.day][result.slotEntry.id]=result.slotEntry;this.contextInfo=result.slotEntry;}\u000athis.parentTimetable.data[result.day][slot.id].entries[result.entry.id]=result.entry;this._updateTimes(result.slotEntry.startDate.time,result.slotEntry.endDate.time);}\u000avar dfr=$.Deferred();$('body').one('timetable_redraw',function(){$('body').trigger('timetable_update',self);dfr.resolve();});this.timetableDrawer.redraw();return dfr.promise();},_updateDay:function(update){this._processAutoOps(update);var slot=this.contextInfo;extend(this.data,update.entries);this._removeMissingEntries(update.entries);if(exists(update.session)){this.parentTimetable.eventInfo.sessions[update.session.sessionId]=update.session;}\u000aif(exists(update.slotEntry)){update.slotEntry.entries=slot.entries;this.parentTimetable.data[update.day][update.slotEntry.id]=update.slotEntry;this.contextInfo=update.slotEntry;this._updateTimes(update.slotEntry.startDate.time,update.slotEntry.endDate.time);}\u000avar dfr=$.Deferred();$('body').bind('timetable_redraw',function(){dfr.resolve();});this.timetableDrawer.redraw();return dfr.promise();},_removeMissingEntries:function(entries){var self=this;_.each(self.data,function(value,key){if(!entries[key]){delete self.data[key];}});},getTTMenu:function(){var self=this;var goBackLink=$('<a class="icon-arrow-up i-button go_back" href="#"/>').text($T('Up to timetable')).click(function(){self.parentTimetable.switchToTopLevel();self._hideWarnings();self.session=null;return false;});return $('<div class="group right"/>').append(goBackLink);}},function(parent,data,contextInfo,eventInfo,width,wrappingElement,detailLevel,isSessionTimetable,customLinks,canManageSession,canManageBlocks,canManageContribs){this.isSessionTimetable=isSessionTimetable;this.isTopLevel=false;this.ManagementTimeTable(data,contextInfo,eventInfo,width,wrappingElement,detailLevel,customLinks,canManageSession,canManageBlocks,canManageContribs);var managementActions=new IntervalTimeTableManagementActions(this,eventInfo,contextInfo,isSessionTimetable);this.IntervalTimeTableMixin(parent,width,wrappingElement,managementActions,'proportional');this.canvas=Html.div({});this.isPoster=contextInfo.isPoster;this.setData=IntervalTimeTableMixin.prototype.setData;this.getById=IntervalTimeTableMixin.prototype.getById;this.postDraw=IntervalTimeTableMixin.prototype.postDraw;});type("SessionDisplayTimeTable",["TopLevelDisplayTimeTable"],{_functionButtons:function(){var self=this;this.TopLevelDisplayTimeTable.prototype._functionButtons.call(this);return[this.printButton,this.fullScreenButton,this.filterButton];}},function(data,eventInfo,width,wrappingElement,historyBroker){this.TopLevelDisplayTimeTable(data,eventInfo,width,wrappingElement,'contribution',historyBroker,null);});function _revert_element(ui){if(ui.originalSize){ui.helper.height(ui.originalSize.height);}}\u000atype("TimeDisplacementManager",[],{_cached_attrs:{gridTop:function(){return $('#timetable_grid').offset().top},heightLimits:function(){return[$('.hourLine:first').offset().top,$('.hourLine:last').offset().top+1]}},_cache_get:function(param){if(this._cache[param]===undefined){this._cache[param]=this._cached_attrs[param]();}\u000areturn this._cache[param];},_cache_set:function(param,val){this._cache[param]=val;},_initializeTooltip:function(){var tip=$('<div id="dragTip"><span>'+$T('move to resize')+'</span></div>');tip.append($('<div class="pointer"/>'));$('body').append(tip.hide().fadeIn(300));},_updateTipPos:function(gridTime,block,type){var txt=gridTime[0]+":"+gridTime[1];if(txt!=this.txt){$('#dragTip span').text(txt);this.txt=txt;}\u000a$('#dragTip').position({my:"right center",at:type=='resize'?"left bottom":"left top",of:block,offset:'-5 0'});},_killTip:function(){$('#dragTip').fadeOut(300,function(){$(this).remove();});},_snap:function(block,time){var hourline=$('#hourLine_'+parseFloat(time[0]));var hourHeight=hourline.height();var target=Math.floor(hourline.position().top+(time[1]/60)*hourHeight);block.clearQueue();block.animate({height:target-block.position().top},{queue:true});var tip=$('#dragTip');tip.css({'top':this._cache_get('gridTop')+target-(tip.outerHeight()/2)});},release:function(startHour,startMinute,endHour,endMinute,eventData,ui,undo_caption){var self=this;var startDT=!startHour?eventData.startDate:{'date':eventData.startDate.date,'time':startHour+":"+startMinute};var endDT;if(!endHour){endDT=new Date(Util.dateTimeIndicoToJS(startDT).getTime()+eventData.duration*60000);}else{endDT={'date':eventData.endDate.date,'time':endHour+":"+endMinute};}\u000aself.managementActions.editEntryStartEndDate(Util.formatDateTime(startDT,IndicoDateTimeFormats.Server),Util.formatDateTime(endDT,IndicoDateTimeFormats.Server),eventData,$(window).data('shiftIsPressed'),undo_caption).fail(function(){_revert_element(ui);});self._cache={};},requestNewHourLine:function(){var first=this._grid.first()[0];if(first>0){this._addHourLine('up',first-1);return first>1}},_addHourLine:function(direction,hour){var last=this._grid.last();var first=this._grid.first();var last_hourline=$('#hourLine_'+last[0]);var first_hourline=$('#hourLine_'+first[0]);if(direction=='down'){var height=$('#hourLine_'+((last[0]==0?24:last[0])-1)).height();var top=last[1]+height;this._grid.push([hour,top]);var width=last_hourline.width();}else{var top=first[0];var height=$('#hourLine_'+first[0]).height();this._grid.each(function(tuple){tuple[1]+=height;});$('.hourLine, .timetableBlock').css('top',function(i,val){return parseFloat(val)+height;});this._grid.unshift([hour,0]);var width=first_hourline.width();}\u000avar hourline=$('<div class="hourLine"/>').attr('id','hourLine_'+hour).css({'top':top+'px',height:height,width:width}).text(zeropad(hour)+':00');if(direction=='down'){$('#timetable_grid').append(hourline);last_hourline.height(height);}else{$('#timetable_grid').prepend(hourline);}\u000a$('#timetable_canvas').height($('#timetable_canvas').height()+height);$('#timetable').height($('#timetable_canvas').height()+height);var ttdrawer=this._timetable.getTimetableDrawer();ttdrawer.make_droppable(hourline,hour);return height;},_hourLineNow:function(elem,type){type=type||'resize';var height=elem.height();var newPos=elem.offset().top+(type=='drag'?0:height);var otherTip=newPos+(type=='drag'?height:height);var curBestDiff=Number.MAX_VALUE;var curHour=null;var parentPos=this._cache_get('gridTop');var hl=this._cache_get('heightLimits');var last=this._grid.last();var first=this._grid.first();if(otherTip>hl[1]){if(last[0]!=0){var height=this._addHourLine('down',(last[0]+1)%24);this._cache_set('heightLimits');if(type=='drag'){elem.data('ui-draggable')._setContainment();}else{elem.data('ui-resizable').resetContainment();}}}else if(newPos>hl[1]){return last;}else if(newPos<=hl[0]){return first;}\u000athis._grid.each(function(tuple){var diff=newPos-parentPos-tuple[1];if((diff>0)&&(diff<curBestDiff)){curBestDiff=diff;curHour=tuple;}});return curHour;},round5:function(hour,minute){var closest=Math.floor(((minute+2.5)/5))*5;if(closest>59){return[zeropad((hour+1)%24),zeropad(0)]}else{return[zeropad(hour),zeropad(closest)]}},_updateTime:function(elem,type){var hour_line=this._hourLineNow(elem,type);if(hour_line==this._grid.last()){var gridTime=[zeropad(this._grid.last()[0]),"00"];}else{var blockPosTop=elem.position().top;var reference=type=="drag"?blockPosTop:blockPosTop+elem.height();var gridTime=this.round5(hour_line[0],this._calculateRelativeMinuteOffset(reference,hour_line));}\u000athis._updateTipPos(gridTime,elem,type);if(type=='resize'){this._snap(elem,gridTime,type);}\u000areturn gridTime;},_calculateRelativeMinuteOffset:function(position,hour_line){var hour=hour_line[0];var hourTop=hour_line[1];var hourHeight=$("#hourLine_"+hour).height();var offsetHeight=(position-hourTop);var minute=Math.floor((offsetHeight/hourHeight)*59);return((minute>60)||(minute<0))?null:minute;},_withNoEvents:function(func){var ttdrawer=this._timetable.getTimetableDrawer();ttdrawer.toggleEvents(false);func();_.defer(function(){ttdrawer.toggleEvents(true);});}},function(timetable){this._timetable=timetable;this._cache={};});type("DraggableBlockMixin",[],{_makeDraggable:function(){var self=this;var originalWidth=this.element.width();var originalHeight=this.element.height();var maxCol=self.timetable.getTimetableDrawer().maxCol;var newWidth=(Math.round($('#timetable').width()/(maxCol)));var heightThreshold=450;var heightChange=(originalHeight>heightThreshold);var newHeight=(heightChange)?heightThreshold:originalHeight;var widthChange=(!(newWidth==originalWidth));var hourLine_mode=false;var draggable=this.element.super_draggable({containment:$('#timetable'),revert:'invalid',refreshPositions:true,start:function(event,ui){var $qbubble=self.element.find('[data-hasqtip]');if($qbubble.length){$qbubble.qbubble('destroy');$qbubble.qbubble('api').disable();}\u000amaxCol=self.timetable.getTimetableDrawer().maxCol;newWidth=(maxCol>1)?Math.round($('#timetable').width()/(maxCol)):originalWidth;ui.helper.animate({width:newWidth});ui.helper.height(newHeight);$(this).data('ui-draggable')._setContainment(newWidth,newHeight);self._initializeTooltip();var pos=ui.helper.position();draggable.data('initialPosition',pos);},drag:function(event,ui){if(hourLine_mode&&$(this).position().left>0){hourLine_mode=false;$('.ui-droppable').super_droppable('enable');}\u000aif($(this).position().left==0){$('.hourLine.ui-droppable').super_droppable('enable');$('.timetableBlock.ui-droppable').super_droppable('disable');hourLine_mode=true;}},stop:function(event,ui){if(widthChange||heightChange){ui.helper.animate({width:originalWidth,height:originalHeight});}\u000aself._killTip();}});draggable.data('eventData',this.eventData);}});type("ResizableBlockMixin",[],{_makeResizable:function(){var self=this;this.resizable=this.element.reset_resizable({ignoreShift:true,containment:$('#timetable_canvas'),maxWidth:this.element.width(),minWidth:this.element.width(),start:function(event,ui){if(!$('#dragTip').length){self._initializeTooltip(ui.helper,function(){self._updateTime(ui.helper,"resize");});}else{$('#dragTip').fadeIn(300);}},resize:function(event,ui){var hours=self._updateTime(ui.helper,"resize");if(hours){$(ui.helper).data('endHour',hours[0]);$(ui.helper).data('endMinute',hours[1]);}},stop:function(event,ui){ui.helper.stop(true);var data=$(ui.helper).data();self._withNoEvents(function(){self.release(null,null,data.endHour,data.endMinute,self.eventData,ui,"resize");});self._killTip();}});}});type("DroppableTimetableMixin",["TimeDisplacementManager"],{_shiftKeyListener:function(){var indicatorDiv=$('.bottomTip');var self=this;if(!(indicatorDiv.length>0)){indicatorDiv=$('<div class="bottomTip"/>').html($T('<span class="key light">Shift</span> is currently pressed. Changes will be applied to blocks after.')).appendTo('body');}\u000a$(document).keydown(function(e){if(self._timetable.isTopLevel&&self._timetable.isSessionTimetable&&!self._timetable.canManageBlocks){return;}\u000aif(e.keyCode=='16'){$(window).data('shiftIsPressed',true);indicatorDiv.fadeIn("fast");}}).keyup(function(e){if(e.keyCode=='16'){$(window).data('shiftIsPressed',false);indicatorDiv.fadeOut("fast");}}).blur(function(){$(window).data('shiftIsPressed',false);indicatorDiv.fadeOut("fast");});$(window).data('shiftIsPressed',false);},make_droppable:function(element,hour){var thisDragSpaceName=("drag."+hour);var minute=null;var self=this;element.droppable({drop:function(event,ui){self._withNoEvents(function(){if(event.target.id==='hourLine_'+hour.toString().replace(/^0/,'')){self.release(hour,minute,null,null,$(ui.draggable.context).data("eventData"),ui.helper,"placementChange");}});},tolerance:'touch',accept:'.ui-draggable.timetableBlock',over:function(event,ui){$('#timetable').on(thisDragSpaceName,'.ui-draggable.timetableBlock',function(event,ui){if(element.droppable("option","disabled")){return;}\u000avar gridTime=self._updateTime(ui.helper,"drag");if((gridTime==null)){return;}\u000ahour=gridTime[0];minute=gridTime[1];});},out:function(event,ui){$('#timetable').off(thisDragSpaceName,'.ui-draggable.timetableBlock');}});}},function(timetable){this.TimeDisplacementManager(this.timetable);if(this.managementMode){this._shiftKeyListener.call(this);}\u000athis._grid=_(this.grid);});type("DroppableBlockMixin",[],{_makeDroppable:function(){if(this.eventData.entryType!='Session'){return;}\u000avar self=this;function isSession(ui){return($(ui.draggable).hasClass("timetableSession"));}\u000afunction isTouchingWall(ui){return $(ui.draggable).position().left==0;}\u000afunction removeBottomMove(ui){$('#tt_bottom_move').fadeOut(500,function(){$(this).remove();});}\u000avar inside=false;this.element.super_droppable({drop:function(event,ui){$('#dragTip').remove();if(isSession(ui)||isTouchingWall(ui)){return;}\u000avar blockEventData=$(ui.draggable).data('eventData');var chosenValue={'parent_id':self.eventData.scheduleEntryId};var initialPosition=$(ui.draggable).data('initialPosition');removeBottomMove();self._withNoEvents(function(){self.managementActions.moveToSession(blockEventData,chosenValue,'drop');});return;},greedy:true,tolerance:'pointer',activeClass:'ui-droppable-active',over:function(event,ui){if(isSession(ui)||isTouchingWall(ui)){return;}\u000aif(!inside){var newWidth=$(this).width()*0.75,newHeight=$(this).height()*0.75;ui.draggable.data('draggingWidth',ui.draggable.width());ui.draggable.data('draggingHeight',ui.draggable.height());ui.draggable.animate({width:newWidth});ui.draggable.height({height:newHeight});ui.draggable.data('ui-draggable')._setContainment(newWidth,newHeight);$('.timetableBlock.ui-droppable').not(this).super_droppable('disable');$('.hourLine.ui-droppable').droppable('disable');$('#dragTip').hide();inside=true;if(!$('#tt_bottom_move').length){$('<div class="bottomTip" id="tt_bottom_move"/>').html('<div class="circle"></div>'+$T('Drop to move block inside session')).appendTo('body').fadeIn();}else{$('#tt_bottom_move').stop(true).fadeTo(500,1);}}},out:function(event,ui){inside=false;if(isSession(ui)){return;}\u000aui.draggable.width(ui.draggable.data('draggingWidth'));ui.draggable.height(ui.draggable.data('draggingHeight'));$('#dragTip').show();$('.timetableBlock.ui-droppable').not(this).super_droppable('enable');$('.hourLine.ui-droppable').droppable('enable');removeBottomMove();}});}});type("DragAndDropBlockMixin",["DroppableBlockMixin","ResizableBlockMixin","DraggableBlockMixin","TimeDisplacementManager"],{_postDraw:function(){var entryType=this.eventData.entryType;if(!this.timetable.isSessionTimetable||entryType!='Session'||this.timetable.canManageBlocks){this._makeResizable();this._makeDraggable();this._makeDroppable();}}},function(){this.TimeDisplacementManager(this.timetable);this.element=$(this.block.dom);this._grid=_(this.timetable.getTimetableDrawer().grid);});var activeTT;function switchTT(event,tt){activeTT=tt;var tdrawer=tt.getTimetableDrawer();if(!tdrawer.isPoster){if(tdrawer._grid.first()[0]!=0){$('#tt_hour_tip').fadeIn();}else{$('#tt_hour_tip').fadeOut();}}}\u000a$(function(){$("body").bind('timetable_ready',function(event,tt){$('#tt_menu').css('width',tt.width);switchTT(event,tt);$('#tt_hour_tip').unbind();$('#tt_hour_tip').click(function(evt){if(!activeTT.getTimetableDrawer().requestNewHourLine()){$(this).fadeOut();}});});$("body").one('timetable_ready',function(){var closeMenu=function(){var dropdown=$('#tt_menu .group');if(dropdown){try{dropdown.dropdown('close');}catch(e){}}};$.ui.sticky({sticky:closeMenu,normal:closeMenu});});$("body").bind('timetable_switch_toplevel',switchTT);$("body").bind('timetable_switch_interval',switchTT);$("body").bind('timetable_update',switchTT);});type("TimetableBlockBase",[],{truncateTitle:function(numChars,title){if(numChars>=title.length){return title;}\u000aif(numChars<0){if(-numChars>=title.length){return title;}\u000aif(numChars>=-3){numChars=-4;}\u000anumChars=title.length+numChars;}\u000atitle=title.substring(0,numChars)+"...";return title;},openPopup:function(event){var self=this;self.popupActive=true;self._drawPopup(event);},createMaterialMenu:function(attachments,triggerElement,closeHandler){var menuItems={},sections={'':{content:menuItems,description:''}};$.each(attachments.files,function(i,attachment){menuItems["material"+attachment.download_url]={action:attachment.download_url,display:attachment.title,description:attachment.description};});$.each(attachments.folders,function(i,folder){var sectionItems={},section=folder.title;$.each(folder.attachments,function(i,attachment){sectionItems["material"+attachment.download_url]={action:attachment.download_url,display:attachment.title,description:attachment.description};});sections[section]={content:sectionItems,description:folder.description};});return new SectionPopupMenu(sections,[triggerElement],null,null,true,closeHandler);},getMaterialMenu:function(attachments){var root=$('<ul class="material_list"/>');each(attachments.files,function(attachment){var resource_html=$('<li/>').append($('<a/>').attr('href',attachment.download_url).text(attachment.title));root.append(resource_html);});each(attachments.folders,function(folder){var resources=$('<ul class="resource_list"/>');each(folder.attachments,function(attachment){var resource_html=$('<li/>').append($('<a/>').attr('href',attachment.download_url).text(attachment.title));resources.append(resource_html);});var material_html=$('<li/>').append($('<h3/>').append(folder.title),resources);root.append(material_html);});return root;},createMaterialButton:function(attachments){var self=this;var button=Html.a('i-link entry-attachments');var $button=$(button.dom);$button.qtip({content:{text:self.getMaterialMenu(attachments)},show:{event:false},hide:{event:'unfocus'},events:{show:function(){$button.addClass('open').trigger('indico:closeAutoTooltip');},hide:function(){$button.removeClass('open');}},position:{my:'top right',at:'bottom left'},style:{classes:'material_tip'},suppress:false}).on('click',function(evt){evt.stopPropagation();$(this).qtip('show');}).attr('title',$T.gettext("Show materials")).data('qtip-position','right');return button;},_getRightSideDecorators:function(){return Html.span({});},_formatConveners:function(conveners){if(conveners){return _.map(_.sortBy(conveners,_.property('displayOrderKey')),_.property('name')).join(', ');}else{return'';}}},function(timetable){this.timetable=timetable;this.popupActive=false;this.popupAllowClose=true;});type("TimetableBlockNormal",["TimetableBlockBase"],{_getTitle:function(){var title=this.eventData.title;if(this.eventData.slotTitle&&this.eventData.slotTitle!==""){title+=": "+this.eventData.slotTitle;}\u000areturn title;},_blockDescription:function(block,event){var self=this;this.titleDiv=Html.div({className:'timetableBlockTitle',style:{fontWeight:this.eventData.fontWeight}},this._getTitle());this.titleWrapper=Html.div({},this.titleDiv);this.div=Html.div({className:'entry-content',style:{width:'100%',height:'100%'}},this.titleWrapper);if(this.compactMode){this.timeDiv=Html.div('timetableBlockTimeDiscreet',this.eventData.startDate.time.substring(0,5)+' - '+this.eventData.endDate.time.substring(0,5));this.div.insert(this.timeDiv);}else{if(this.eventData.startDate.time==this.eventData.endDate.time){this.timeDiv=Html.div({className:'timetableBlockTime'},this.eventData.startDate.time.substring(0,5));}else{this.timeDiv=Html.div({className:'timetableBlockTime'},this.eventData.startDate.time.substring(0,5)+' - '+this.eventData.endDate.time.substring(0,5));}\u000athis.locationDiv=Html.div('timetableBlockLocation');var addComma=false;if(this.eventData.room&&this.timetable.getTimetableDrawer().layoutChooser.get().shouldShowRoom()){this.locationDiv.append(this.eventData.room);addComma=true;}\u000aif(this.eventData.location){this.locationDiv.append(addComma?', ':'');this.locationDiv.append(this.eventData.location);}\u000aif(self.eventData.presenters&&self.eventData.presenters.length>0){var firstPresenter=self.eventData.presenters[0];this.presentersDiv=Html.div({className:'timetableBlockPresenters'});this.presentersDiv.append(firstPresenter.name);if(self.eventData.presenters.length>1){this.presentersDiv.append(' '+$T('et al.'));}\u000athis.titleWrapper.insert(this.presentersDiv);}\u000aif(!self.managementActions&&self.eventData.attachments&&self.eventData.attachments.files){this.titleWrapper.insert(this.createMaterialButton(this.eventData.attachments));}\u000athis.convenerDiv=Html.div('timetableBlockConvener',self._formatConveners(this.eventData.conveners));this.div.append(this.convenerDiv);this.div.append(this.timeDiv);this.div.append(this.locationDiv);}\u000areturn this.div;},redraw:function(){this.block.clear();this.block.set(this._blockDescription());},draw:function(leftPos,width){var self=this;this.leftPos=leftPos;this.width=width;this.height=this.blockData.end-this.blockData.start-3;this.topPos=this.blockData.start;var blockIsDraggable=((this.detailLevel!="session")&&(this.detailLevel!="contribution"));var additionalClasses='ui-draggable ui-resizable';var contributionClass=(blockIsDraggable)?'timetableContribution '+additionalClasses:'timetableContribution';var breakClass=(blockIsDraggable)?'timetableBreak '+additionalClasses:'timetableBreak';var sessionClass=(blockIsDraggable)?'timetableSession '+additionalClasses:'timetableSession';var classTable={'Session':sessionClass,'Contribution':contributionClass,'Break':breakClass};$(this.block.dom).css({position:'absolute',top:pixels(this.topPos),height:pixels(this.height),'background-color':this.eventData.color,color:this.eventData.textColor,left:pixels(this.leftPos),width:pixels(this.width-3),'border-bottom-style':this.blockData.unfinished?'dashed':''});$(this.block.dom).addClass('timetableBlock '+\u000aclassTable[this.eventData.entryType]);this.block.set(this._getRightSideDecorators(),this._blockDescription());if(this.detailLevel=='contribution'&&this.eventData.isPoster&&this.height>30){var pileDiv=this.createPileEffect();pileDiv.dom.onmouseover=function(){};var numContribs=0;each(this.eventData.entries,function(value,key){if(value.entryType=='Contribution'){numContribs++;}});pileDiv.dom.onmouseover=function(event){if(self.popupActive){return;}\u000aIndicoUI.Widgets.Generic.tooltip(pileDiv.dom,event,"<div style='padding:3px'>"+\u000a$T('This poster session has ')+numContribs+$T(' contribution(s).')+"<br / >"+\u000a$T('Please click for more information.')+"</div>");};}\u000aif(!self.printableVersion){$(this.block.dom).on('click','.entry-content',function(e){if(!self.timetable.getTimetableDrawer().eventsDisabled){$(this).trigger('tt_block.balloon',e);}});highlightWithMouse(this.div,this.block);}\u000areturn this.block;},_postDraw:function(){},postDraw:function(hook){var self=this;var title=this._getTitle();var contentHeight=function(){var h=0;if(!self.compactMode){var locationHeight=self.locationDiv.dom.style.display!='none'?self.locationDiv.dom.offsetHeight:0;var timeHeight=self.timeDiv.dom.style.display!='none'?self.timeDiv.dom.offsetHeight:0;h=Math.max(locationHeight,timeHeight);}\u000areturn self.titleDiv.dom.offsetHeight+h;};var contentWidth=function(){return self.timeDiv.dom.offsetWidth+self.locationDiv.dom.offsetWidth+2*self.margin;};var parentDivHeight=this.div.dom.parentNode.offsetHeight;var parentDivWidth=this.div.dom.parentNode.offsetWidth;if(!parentDivHeight){return;}\u000aif(this.compactMode&&parentDivWidth<200){this.timeDiv.dom.style.display='none';}\u000aif(!this.compactMode){var locationMaxWidth=parentDivWidth-20;if(this.timeDiv.dom.offsetWidth+8>=parentDivWidth){this.timeDiv.dom.style.display='none';}\u000aelse if(contentWidth()>=parentDivWidth||contentHeight()>=parentDivHeight){this.timeDiv.dom.style.display='none';}else{locationMaxWidth-=this.timeDiv.dom.offsetWidth;}\u000athis.locationDiv.dom.style.maxWidth=locationMaxWidth>0?pixels(locationMaxWidth):'0px';if(contentWidth()>=parentDivWidth||contentHeight()>=parentDivHeight){this.timeDiv.dom.style.display='none';this.locationDiv.dom.style.maxWidth=pixels(parentDivWidth-20);}\u000aif(this.presentersDiv&&this.presentersDiv.dom.offsetWidth>parentDivWidth/2){this.presentersDiv.dom.style.display='none';}\u000aif(this.convenerDiv&&this.convenerDiv.dom.offsetWidth>parentDivWidth/2){var newLength=parentDivWidth/2/this.convenerDiv.dom.offsetWidth*this.convenerDiv.get().length;this.convenerDiv.set(this.truncateTitle(newLength-1,this.convenerDiv.get()));}\u000aif(this.convenerDiv&&this.convenerDiv.dom.offsetHeight+contentHeight()>parentDivHeight){this.convenerDiv.dom.style.display='none';}}\u000aif(contentHeight()>parentDivHeight){if(this.timeDiv.dom.style.display=='none'){this.locationDiv.dom.style.display='none';}\u000aif(contentHeight()>parentDivHeight){var topContentWidth=function(){var width=2*self.margin;if(self.titleDiv)\u000awidth+=self.titleDiv.dom.offsetWidth;if(self.presentersDiv)\u000awidth+=self.presentersDiv.dom.offsetWidth;self._postDraw();return width;};title=this.truncateTitle(Math.ceil(title.length*((parentDivHeight)/contentHeight())),title);this.titleDiv.set(title);var step=2;while(title!=="..."&&contentHeight()>parentDivHeight&&topContentWidth()>parentDivWidth*0.8){title=this.truncateTitle(-step,title);this.titleDiv.set(title);}}}\u000athis._postDraw();return null;},createPileEffect:function(){var self=this;var pileEffect=Html.div({style:{position:'absolute',top:'3px',left:'0',width:pixels(this.width-3)}},Html.div({},Html.div('timetableBlock timetableBlockPileEffect'),Html.div('timetableBlock timetableBlockPileEffect'),Html.div('timetableBlock timetableBlockPileEffect')));this.div.insert(pileEffect);this.titleWrapper.dom.style.paddingTop='15px';if(this.compactMode){this.timeDiv.dom.style.paddingTop='15px';}\u000areturn pileEffect;},setColors:function(textColor,bgColor){this.block.dom.style.backgroundColor=bgColor;this.block.dom.style.color=textColor;}},function(timetable,eventData,blockData,compactMode,printableVersion,detailLevel){this.TimetableBlockBase(timetable);this.compactMode=compactMode;this.eventData=eventData;this.blockData=blockData;this.margin=TimetableDefaults.blockMargin;this.printableVersion=printableVersion;this.detailLevel=detailLevel;this.arrows=Html.span({});this.block=Html.div({});var self=this;$(this.block.dom).bind('tt_block.balloon',function(event,originalEvent){if(!self.popupActive){self.openPopup(originalEvent);}})});type("TimetableBlockWholeDayBase",["TimetableBlockBase"],{_blockDescription:function(block,event){var self=this;this.titleDiv=Html.div({className:'timetableBlockTitle',style:{fontWeight:this.eventData.fontWeight}},this.eventData.title);this.titleWrapper=Html.div({},this._getRightSideDecorators(),this.titleDiv);this.div=Html.div({style:{width:'100%',height:'100%'}},this.titleWrapper);this.timeDiv=Html.div('timetableBlockTimeDiscreet',this.eventData.startDate.time.substring(0,5)+' - '+this.eventData.endDate.time.substring(0,5));this.div.insert(this.timeDiv);if(self.eventData.attachments&&self.eventData.attachments.files){this.titleWrapper.insert(this.createMaterialButton(this.eventData.attachments));}\u000areturn this.div;},draw:function(){var self=this;var classTable={'Session':'timetableSession','Contribution':'timetableContribution ','Break':'timetableBreak '};var block=Html.div({style:{backgroundColor:this.eventData.color,color:this.eventData.textColor,maxHeight:'30px',margin:'2px 0',overflow:'hidden'},className:'timetableBlock '+classTable[this.eventData.entryType]},this._blockDescription());if(!self.printableVersion){block.dom.style.cursor='pointer';block.observeClick(function(e){self.openPopup(e);});highlightWithMouse(this.div,block);}\u000areturn block;},postDraw:function(){}},function(timetable,eventData,blockData){this.TimetableBlockBase(timetable);this.eventData=eventData;this.blockData=blockData;this.margin=TimetableDefaults.blockMargin;this.arrows=Html.span({});});function loadBalloonContent(self,api,editable){var entryId=self.eventData.scheduleEntryId?self.eventData.scheduleEntryId:self.eventData.id.substring(1);var url=editable?Indico.Urls.Timetable.entries.info.manage:Indico.Urls.Timetable.entries.info.display;var urlParams={'confId':self.eventData.conferenceId,'entry_id':entryId};if(self.timetable.isSessionTimetable){urlParams.session_id=self.eventData.sessionId;}\u000a$.ajax({url:build_url(url,urlParams)}).then(function(content){api.set('content.text',content.html);var $content=api.elements.content;function hideBalloon(){api.cache.event.type='click';api.hide();}\u000aif(editable){var qtipId=$content.closest('.qtip').data('qtip-id');var $balloonQtip=$('[data-hasqtip='+qtipId+']');var closeBalloon=false;$content.find('.js-edit-time').ajaxqbubble({url:build_url(Indico.Urls.Timetable.entries.editTime,urlParams),qBubbleOptions:{style:{classes:'balloon-time-qtip'},position:{at:'top center',my:'bottom center',},events:{hidden:function(){if(closeBalloon){$balloonQtip.qbubble('hide');}}}},qtipConstructor:function(element,qtipOptions){$balloonQtip.qbubble('createNested',element,qtipOptions);},onClose:function(data){handleNotifications(data);if(data){self.timetable._updateDay(data.update);closeBalloon=true;}}});$content.on('indico:confirmed','.js-delete',function(evt){evt.preventDefault();self.managementActions.deleteEntry(self.eventData);}).on('ajaxDialog:closed','.js-manage-attachments, .js-manage-subcontribs',function(e){api.set('content.text',function(evt,api){loadBalloonContent(self,api,editable);});}).on('ajaxDialog:loadError','.js-move, .js-edit',function(evt,xhr){if(xhr.status==404){evt.preventDefault();handleErrorResponse(xhr);}});$content.find('.js-switch-to-interval').on('click',function(){self.managementActions.switchToIntervalTimetable(self.eventData.id);});$content.find('.js-edit').on('click',function(){var extraParams=$(this).data('extra-params');ajaxDialog({trigger:this,url:build_url(Indico.Urls.Timetable.entries.edit,$.extend({},urlParams,extraParams)),title:$(this).data('title'),onClose:function(data){if(data){handleNotifications(data);self.timetable._updateDay(data.update);}}});});$content.find('.js-move').on('click',function(){var urlArgs={confId:self.eventData.conferenceId,entry_id:self.eventData.scheduleEntryId};if(self.timetable.isSessionTimetable){urlArgs.session_id=self.timetable.contextInfo.sessionId;}\u000aajaxDialog({url:build_url(Indico.Urls.Timetable.entries.move,urlArgs),data:{'day':self.timetable.currentDay},title:$T.gettext("Move entry"),subtitle:$(this).data('subtitle'),trigger:this,onClose:function(data){if(data){self.managementActions.moveToSession(self.eventData,data,true,null);}}});});var $picker=$content.find('.palette-picker');$picker.palettepicker({availableColors:$picker.data('palette'),selectedColor:$picker.data('initial-color'),onSelect:function(background,text){$.ajax({url:$picker.data('href'),method:$picker.data('method'),data:JSON.stringify({'colors':{'text':text,'background':background}}),dataType:'json',contentType:'application/json',complete:IndicoUI.Dialogs.Util.progress(),error:handleAjaxError,success:function(data){self.managementActions._addEntries(data.entries);}});},qtipConstructor:function(element,qtipOptions){var qtipId=$picker.closest('.qtip').data('qtip-id');$('[data-hasqtip='+qtipId+']').qbubble('createNested',element,qtipOptions);}});}\u000a$content.find('.js-hide-balloon').on('click',hideBalloon);$content.closest('.qtip').trigger('qbubble:ajaxload');},function(xhr,status,error){if(xhr.status==404){handleErrorResponse(xhr);api.set('content.text',$T.gettext('This timetable entry does not exist anymore. Please refresh the page.'));}});return $T.gettext('Loading...');}\u000afunction handleErrorResponse(xhr){cornerMessage({message:$T.gettext('This timetable entry does not exist anymore. Please refresh the page.'),actionLabel:$T.gettext('Refresh'),actionCallback:function(){location.reload();},duration:10000,class:'error'});}\u000afunction drawBalloon(self,evt,editable){var timetableBlock=$(self.div.dom);var entryId=self.eventData.scheduleEntryId?self.eventData.scheduleEntryId:self.eventData.id.substring(1);if($('html').data('static-site')){var url;if(self.eventData.entryType=='Session'){url=build_url(Indico.Urls.Sessions.display_session,{'confId':self.eventData.conferenceId,'session_id':self.eventData.sessionId});}else if(self.eventData.entryType=='Contribution'){url=build_url(Indico.Urls.Contributions.display_contribution,{'confId':self.eventData.conferenceId,'contrib_id':self.eventData.contributionId});}else{return;}\u000alocation.href=url;}else{var isBreak=self.eventData.entryType=='Break';timetableBlock.qbubble({id:entryId.toString(),content:{text:function(evt,api){return loadBalloonContent(self,api,editable);}},show:{ready:true},hide:{event:'unfocus',fixed:true},events:{hide:function(evt,api){if(evt.originalEvent.type=='mouseleave'){evt.preventDefault();}},render:function(e,api){api.elements.target.on('click',function(){api.hide();});},},position:{at:'top center',my:'bottom center',target:[evt.pageX,evt.pageY],adjust:{mouse:false},effect:false},style:{classes:'balloon-qtip '+(editable?'edit-mode':'display-mode')+(isBreak?' no-details':'')}});}}\u000atype("TimetableBlockDisplayMixin",[],{_drawPopup:function(evt){drawBalloon(this,evt,false);}});type("TimetableBlockManagementMixin",["DragAndDropBlockMixin"],{_drawPopup:function(evt){drawBalloon(this,evt,true);},_getRightSideDecorators:function(){return this.arrows;},_drawArrows:function(){var self=this;var arrowUp=$('<a>',{class:'i-link icon-collapse'});var arrowDown=$('<a>',{class:'i-link icon-expand'});if(self.eventData.canSwapUp){arrowUp.attr('title',$T.gettext('Move up'));arrowUp.on('click',function(){self.managementActions.swapEntry(self.eventData,'up');});}else{arrowUp.addClass('disabled');}\u000aif(self.eventData.canSwapDown){arrowDown.attr('title',$T.gettext('Move down'));arrowDown.on('click',function(){self.managementActions.swapEntry(self.eventData,'down');});}else{arrowDown.addClass('disabled');}\u000aif(self.eventData.canSwapDown||self.eventData.canSwapUp){this.arrows=Html.div({className:'entry-arrows'},arrowUp.get(0),arrowDown.get(0));}}},function(){var isParallel=this.timetable.isSessionTimetable?this.eventData.isParallelInSession:this.eventData.isParallel;if(!isParallel&&(!this.timetable.isTopLevel||this.timetable.canManageBlocks)){this._drawArrows();}\u000athis.DragAndDropBlockMixin();});type("TimetableBlockWholeDayDisplay",["TimetableBlockWholeDayBase","TimetableBlockDisplayMixin"],{},function(timetable,eventData,blockData){this.TimetableBlockWholeDayBase(timetable,eventData,blockData);});type("TimetableBlockWholeDayManagement",["TimetableBlockWholeDayBase","TimetableBlockManagementMixin"],{},function(timetable,eventData,blockData,managementActions){this.TimetableBlockWholeDayBase(timetable,eventData,blockData);this.managementActions=managementActions;this.TimetableBlockManagementMixin();this._getRightSideDecorators=TimetableBlockManagementMixin.prototype._getRightSideDecorators;this._postDraw=TimetableBlockManagementMixin.prototype._postDraw;});type("TimetableBlockNormalDisplay",["TimetableBlockNormal","TimetableBlockDisplayMixin"],{},function(timetable,eventData,blockData,compactMode,printableVersion,detailLevel)\u000a{this.TimetableBlockNormal(timetable,eventData,blockData,compactMode,printableVersion,detailLevel);});type("TimetableBlockNormalManagement",["TimetableBlockNormal","TimetableBlockManagementMixin"],{_getTitle:function(){var title=this.TimetableBlockNormal.prototype._getTitle.call(this);return this.eventData.friendlyId>=0?this.eventData.friendlyId+" - "+title:title;}},function(timetable,eventData,blockData,compactMode,printableVersion,detailLevel,managementActions)\u000a{this.TimetableBlockNormal(timetable,eventData,blockData,compactMode,printableVersion,detailLevel);this.managementActions=managementActions;this.TimetableBlockManagementMixin();this._getRightSideDecorators=TimetableBlockManagementMixin.prototype._getRightSideDecorators;this._postDraw=TimetableBlockManagementMixin.prototype._postDraw;});type("TimetablePopup",["ExclusivePopup"],{draw:function(){var self=this;var div=Html.div({style:{padding:pixels(30)}});var timetable=new TimeTable({"20090617":{"s420":this.eventData}},710,div,'contribution',false);div.set(timetable.draw());timetable.postDraw();return this.ExclusivePopup.prototype.draw.call(this,Html.div({style:{marginBottom:pixels(10)}},div));}},function(eventData,contributions,closeHandler){this.contributions=contributions;this.eventData=eventData;this.width=500;this.ExclusivePopup('Session timetable',closeHandler);});type("TimetableDrawer",["IWidget","DroppableTimetableMixin"],{_minuteDifference:function(time1,time2){var t1=parseInt(time1.substring(0,2),10)*60+parseInt(time1.substring(3,6),10);var t2=parseInt(time2.substring(0,2),10)*60+parseInt(time2.substring(3,6),10);return t2-t1;},_drawGrid:function(scale){var scaleDiv=Html.div({id:'timetable_grid',style:{position:'relative',top:pixels(TimetableDefaults.topMargin)}});var last=scale[scale.length-1][0];for(var n=0;n<scale.length;++n){var hour=scale[n][0];var px=scale[n][1];if(scale[n].length>2){scaleDiv.append(Html.div({style:{position:'absolute',top:pixels(px),width:pixels(this.width),height:hour==last?'0px':scale[n+1][1]-px,borderTop:'1px dotted red',fontSize:'11px'}}));continue;}\u000avar hourLineDiv=Html.div({id:'hourLine_'+parseInt(hour),className:'hourLine',style:{top:pixels(px),width:pixels(this.width),height:hour==last?'20px':scale[n+1][1]-px}},zeropad(hour)+':00');this.make_droppable($(hourLineDiv.dom),parseInt(hour));scaleDiv.append(hourLineDiv);}\u000areturn Html.div({},this.layoutChooser.get().getHeader(this.width),scaleDiv);},_drawWholeDayBlocks:function(data,blocks){var self=this;var wholeDayBlockDiv=Html.div({style:{position:'relative',marginTop:pixels(TimetableDefaults.topMargin),top:pixels(10),marginLeft:pixels(TimetableDefaults.leftMargin),marginRight:pixels(TimetableDefaults.rightMargin)}});self.wholeDayBlocks=[];var blockAdded=false;each(blocks,function(blockData){var eventData=data[blockData.id];var block;if(self.managementMode){block=new TimetableBlockWholeDayManagement(self.timetable,eventData,blockData,self.managementActions);}else{block=new TimetableBlockWholeDayDisplay(self.timetable,eventData,blockData);}\u000awholeDayBlockDiv.append(block.draw(0,100));blockAdded=true;});return blockAdded?wholeDayBlockDiv:Html.div({});},_drawBlocks:function(data,blocks,groups){var self=this;var colN=0;var blockDiv=Html.div({style:{position:'relative',top:pixels(TimetableDefaults.topMargin)}});this.blocks=[];this._blockMap={};each(blocks,function(blockData){var nCol=self.layoutChooser.get().getNumColumnsForGroup(groups[blockData.group]);self.maxCol=((self.maxCol==null)||(self.maxCol<nCol))?nCol:self.maxCol;var colWidth=Math.floor((self.width-TimetableDefaults.leftMargin)/nCol);var leftPos=TimetableDefaults.leftMargin+colWidth*blockData.assigned;var width;if(parseInt(blockData.assigned,10)==(nCol-1)){width=self.width-leftPos-TimetableDefaults.rightMargin;}else{width=colWidth;}\u000avar eventData=data[blockData.id];var block;var compactMode=false;if(self.managementMode){block=new TimetableBlockNormalManagement(self.timetable,eventData,blockData,compactMode,self.printableVersion,self.detail.get(),self.managementActions);}else{block=new TimetableBlockNormalDisplay(self.timetable,eventData,blockData,compactMode,self.printableVersion,self.detail.get());}\u000ablockDiv.append(block.draw(leftPos,width));self._blockMap[blockData.id]=block.block.dom;self.blocks.push(block);});return blockDiv;},setLayout:function(layout){this.layout.set(layout);this.layoutChooser.set(layout);},redraw:function(day){if(this.preventRedraw){return;}\u000athis.timetable.redrawLegend();day=any(day,this.day);if(day=='all'){this.redrawAllDays();return;}\u000avar dayFiltered=this.applyFilters(this.data[day]);if(this.detail.get()=='contribution'){dayFiltered=this.flatten(dayFiltered);}\u000avar dayData=this.layoutChooser.get().drawDay(dayFiltered,'session',this.startTime,this.endTime,this.managementMode);var height=dayData[0]+TimetableDefaults.topMargin+TimetableDefaults.bottomMargin;this.wrappingElement.setStyle('height',pixels(height+(this.printableVersion?0:100)));this.grid.length=0;$.merge(this.grid,dayData[1]);var gridElems=this._drawGrid(this.grid);var blocks=this._drawBlocks(dayFiltered,dayData[2],dayData[3]);var wholeDayBlocks=this._drawWholeDayBlocks(dayFiltered,dayData[4]);this.canvas.set([wholeDayBlocks,Html.div({style:{position:'relative'}},gridElems,blocks)]);var totalHeight=height+wholeDayBlocks.dom.offsetHeight;this.canvas.dom.style.height=pixels(totalHeight);this.postDraw();$('body').trigger('timetable_redraw',this);return totalHeight;},setPrintableVersion:function(printableVersion){this.printableVersion=printableVersion;this.redraw();},postDraw:function(){each(this.blocks,function(block){if(exists(block.postDraw)){block.postDraw();}});},flatten:function(data){var result={};each(data,function(entry,key){if(entry.entryType=='Session'&&!entry.isPoster&&keys(entry.entries).length>0){each(entry.entries,function(subentry,subkey){result[subkey]=clone(subentry);result[subkey].color=subentry.entryType=='Break'?subentry.color:entry.color;result[subkey].textColor=subentry.entryType=='Break'?subentry.textColor:entry.textColor;});}else{result[key]=entry;}});return result;},drawDay:function(day){this.day=day;this.preventRedraw=true;this.updateFilters(day);this.preventRedraw=false;this.setLoading(true,this.redraw,day);return this.canvas;},drawAllDays:function(){this.day='all';this.preventRedraw=true;this.updateFilters('all');this.preventRedraw=false;this.setLoading(true,this.redrawAllDays);return this.canvas;},redrawAllDays:function(){var self=this;var days=[];each(this.data.all,function(value,key){if(key!='all'){value.date=key;days.push(value);}});days.sort(function(a,b){if(a.date>b.date){return 1;}\u000areturn-1;});var div=Html.div({});var height=0;var headerHeight=0;var header=Html.div({className:'timetableHeader',style:{visibility:'hidden'}},'Test');self.wrappingElement.append(header);headerHeight=header.dom.offsetHeight+20;self.wrappingElement.remove(header);var firstDay=true;each(days,function(value){var day=value.date;delete value.date;var h=self.redraw(day);var elements=translate(self.canvas.dom.childNodes,function(value){return $E(value);});var dayCanvas=Html.div({style:{position:'relative',height:pixels(h)}},elements);var headerStyle={width:pixels(self.width-10)};if(self.printableVersion){headerStyle.textAlign='center';headerStyle.borderBottom='0';}else if(firstDay){headerStyle.marginTop='0';}\u000avar nDate=Util.parseJSDateTime(day,IndicoDateTimeFormats.Ordinal);var dayStr=Indico.Data.WeekDays[nDate.getDay()].substring(0,3)+' '+nDate.getDate()+'/'+(nDate.getMonth()+1);header=Html.div({className:'timetableHeader',style:headerStyle},dayStr);div.append(header);div.append(dayCanvas);height+=h+headerHeight;firstDay=false;});var margin=30+(self.printableVersion?0:100);self.wrappingElement.setStyle('height',pixels(height+margin));this.canvas.set(div);return this.canvas;},setWidth:function(width){this.width=width;},applyFilters:function(data){var result={};var self=this;each(data,function(event,key){var show=true;self.filterState.each(function(value,filterName){if(value){var filter=TimetableDefaults.filters[filterName].filter;if(!filter.apply(event)){show=false;}}});if(show){result[key]=event;}});return result;},updateFilters:function(){var self=this;self.filterState.each(function(value,filterName){if(value){TimetableDefaults.filters[filterName].filter.setData(self.data,self.day);}});},setLoading:function(loading,funcToCall,arg){var self=this;funcToCall=any(funcToCall,function(){});this.loading+=loading?1:-1;if(this.loading>0){this.loadingIndicator.dom.style.visibility='visible';setTimeout(function(){funcToCall.call(self,arg);$('body').trigger('timetable_ready',self.timetable);self.setLoading(false);},100);}else{this.loadingIndicator.dom.style.visibility='hidden';this.loading=0;}},setData:function(data,startTime,endTime){this.startTime=startTime;this.endTime=endTime;this.data=data;this.redraw();},toggleEvents:function(value){if(value===undefined){this.eventsDisabled=!this.eventsDisabled;}else{this.eventsDisabled=!value;}}},function(timetable,width,wrappingElement,detailLevel,extraButtons,loadingIndicator,managementMode,managementActions,defaultLayout){var self=this;this.grid=[];this.wrappingElement=wrappingElement;this.canvas=Html.div({'id':'timetable_canvas'});this.filterList=new WatchList();this.data=timetable.data;this.timetable=timetable;this.blocks=[];this.width=width;this.preventRedraw=false;this.printableVersion=false;this.layoutChooser=new Chooser(map(TimetableDefaults.layouts,function(value,key){return value.manager;}));this.detail=new WatchValue();this.layout=new WatchValue();this.loading=0;this.loadingIndicator=loadingIndicator;this.managementMode=managementMode;this.managementActions=managementActions;this.layout.set(any(defaultLayout,'compact'));this.layoutChooser.set(any(defaultLayout,'compact'));this.detail.set(any(detailLevel,'session'));this.eventsDisabled=false;var filterState=map(TimetableDefaults.filters,function(value,key){return true;});this.filterState=$O(filterState);this.detail.observe(function(value){if(!self.preventRedraw){self.setLoading(true,self.redraw);}});this.layout.observe(function(value){self.layoutChooser.set(value);if(!self.preventRedraw){self.setLoading(true,self.redraw);}});this.DroppableTimetableMixin();});type("IntervalTimetableDrawer",["TimetableDrawer"],{posterRedraw:function(){var dayData=this.layoutChooser.get().drawDay(this.data[this.day]);var blocks=this._posterBlocks(dayData);this.canvas.set(Html.div({style:{position:'relative'}},blocks));var height=this.canvas.dom.clientHeight+50+TimetableDefaults.topMargin+TimetableDefaults.bottomMargin;this.wrappingElement.setStyle('height',pixels(height+(this.printableVersion?0:100)));this.postDraw();return height;},redraw:function(){if(this.isPoster){return this.posterRedraw();}else{return this.TimetableDrawer.prototype.redraw.call(this);}},_posterBlocks:function(data){data=_.sortBy(data,function(d){return[d.startDate.date,d.startDate.time,d.title];});var self=this;var blockDiv=Html.div({style:{position:'relative',top:pixels(TimetableDefaults.topMargin)}});self.blocks=[];var topPx=0;each(data,function(blockData,id){function createEditLink(blockData){var link=$('<a>',{class:'i-link icon-edit',title:$T.gettext("Edit"),data:{title:$T.gettext("Edit poster"),confId:blockData.conferenceId,timetableEntryId:blockData.scheduleEntryId}}).on('click',function(evt,params){var $this=$(this);var urlArgs={'confId':$this.data('confId'),'entry_id':$this.data('timetableEntryId')};if(self.timetable.isSessionTimetable){urlArgs.session_id=self.timetable.contextInfo.sessionId;}\u000aajaxDialog({trigger:this,url:build_url(Indico.Urls.Timetable.entries.edit,urlArgs),title:$this.data('title'),onClose:function(data){if(data){handleNotifications(data);self.timetable._updateDay(data.update);}}});});return Html.$(link);}\u000afunction createProtectionLink(blockData){var link=$('<a>',{class:'i-link icon-shield',title:$T.gettext("Manage protection"),data:{title:$T.gettext("Manage poster protection"),confId:blockData.conferenceId,contribId:blockData.contributionId}}).on('click',function(evt){var $this=$(this);var urlArgs={'confId':$this.data('confId'),'contrib_id':$this.data('contribId'),};ajaxDialog({trigger:this,url:build_url(Indico.Urls.Timetable.contributions.protection,urlArgs),title:$this.data('title'),onClose:function(data){if(data&&data.entries){self.managementActions._addEntries(data.entries);}}});});return Html.$(link);}\u000afunction createDeleteLink(blockData){var tooltipText,dialogTitle,dialogText;if(self.timetable.eventInfo.isConference){tooltipText=$T.gettext("Unschedule");dialogTitle=$T.gettext("Unschedule poster");dialogText=$T.gettext("Are you sure you want to unschedule the poster?");}else{tooltipText=$T.gettext("Delete");dialogTitle=$T.gettext("Delete poster");dialogText=$T.gettext("Are you sure you want to delete the poster?");}\u000avar link=$('<a>',{class:'i-link icon-remove',title:tooltipText,data:{title:dialogTitle,confirm:dialogText}}).on('click',function(evt){confirmPrompt($(this).data('confirm'),$(this).data('title')).then(function(){self.managementActions.deleteEntry(blockData);});});return Html.$(link);}\u000avar entryTools=Html.div({className:'group right'});if(!self.timetable.isSessionTimetable||self.timetable.canManageContribs){entryTools.append(createEditLink(blockData));entryTools.append(createProtectionLink(blockData));}\u000aif(self.timetable.eventInfo.isConference||self.timetable.canManageContribs){entryTools.append(createDeleteLink(blockData));}\u000avar entryInfo=Html.div({},blockData.friendlyId+" - "+blockData.title);var block=Html.div({className:'posterEntry'},entryTools,entryInfo,Html.div({}));blockDiv.append(block);self.blocks.push(block);});return blockDiv;},setData:function(data,day,isPoster){this.isPoster=isPoster;this.day=day;if(this.isPoster){this.setLayout('poster');}else{this.setLayout(this.layout.get());}\u000athis.TimetableDrawer.prototype.setData.call(this,data);}},function(data,width,wrappingElement,extraButtons,loadingIndicator,managementMode,managementActions,layout){this.TimetableDrawer(data,width,wrappingElement,'session',extraButtons,loadingIndicator,managementMode,managementActions,data.isPoster?'poster':'proportional');this.wrappingElement=data.parentTimetable.timetableDrawer.wrappingElement;});(function(){'use strict';$(document).on('qbubble:ajaxload','.balloon-qtip.display-mode:not(.no-details)',function(){var $description=$(this).find('.description');$description.on('click',function(e){var newTab=e.which==2;var url=$(this).data('displayHref');if(newTab){window.open(url,'_blank');}else{window.location.href=url;}});});})();type("TimetableManagementActions",[],{deleteEntry:function(eventData){var self=this;var info=new WatchObject();info.set('scheduleEntry',eventData.scheduleEntryId);info.set('conference',eventData.conferenceId);info.set('sessionTimetable',self.isSessionTimetable);var urlArgs={'confId':eventData.conferenceId,'entry_id':eventData.scheduleEntryId};if(self.timetable.isSessionTimetable){urlArgs.session_id=self.timetable.contextInfo.sessionId||self.timetable.contextInfo.timetableSession.id;}\u000a$.ajax({url:build_url(Indico.Urls.Timetable.entries.delete,urlArgs),method:'POST',complete:IndicoUI.Dialogs.Util.progress(),error:function(xhr){if(xhr.status==404){handleErrorResponse(xhr);}else{handleAjaxError(xhr);}},success:function(data){if(data){self.timetable._updateDay(data.update);}}});},editEntryStartEndDate:function(startDate,endDate,eventData,shift,undo){var self=this;var urlArgs={confId:eventData.conferenceId,entry_id:eventData.scheduleEntryId};if(self.isSessionTimetable){urlArgs.session_id=self.timetable.contextInfo.sessionId||self.timetable.contextInfo.timetableSession.id;}\u000areturn $.ajax({url:build_url(Indico.Urls.Timetable.entries[shift?'shift':'editDatetime'],urlArgs),method:'POST',data:{startDate:startDate,endDate:endDate},error:function(xhr){handleAjaxError(xhr);self.timetable.timetableDrawer.redraw();},complete:IndicoUI.Dialogs.Util.progress(),success:function(data){if(undo){self.timetable.enableUndo(undo,{eventData:eventData,shifted:shift});}\u000aif(data){handleNotifications(data);self.timetable._updateDay(data.update);}}});},moveToSession:function(eventData,data,undo,newTime){var self=this;if(!data){return false;}\u000avar urlArgs={confId:eventData.conferenceId,entry_id:eventData.scheduleEntryId};if(self.isSessionTimetable){urlArgs.session_id=self.timetable.contextInfo.sessionId;}\u000areturn $.ajax({url:build_url(Indico.Urls.Timetable.entries.move,urlArgs),method:'POST',data:JSON.stringify(data),dataType:'json',contentType:'application/json',error:function(xhr){handleAjaxError(xhr);self.timetable.timetableDrawer.redraw();},complete:IndicoUI.Dialogs.Util.progress(),success:function(data){if(undo){self.timetable.enableUndo(undo,{eventData:eventData,entry:data.entry},null);}\u000aself.timetable._updateMovedEntry(data.entry,data.entry.old.id);handleNotifications(data);}});},switchToIntervalTimetable:function(intervalId){this.timetable.switchToInterval(intervalId);},_dateStr2Date:function(dateStr){var year=parseInt(dateStr.substr(0,4),10);var month=parseInt(dateStr.substr(4,2),10);var day=parseInt(dateStr.substr(6,2),10);return new Date(year,month-1,day);},_addParams:function(type){return{startDate:Util.formatDateTime(this.eventInfo.startDate,IndicoDateTimeFormats.Server),selectedDay:Util.formatDateTime(this._dateStr2Date(this.timetable.currentDay),IndicoDateTimeFormats.Server.slice(0,8)),roomInfo:{location:this.eventInfo.location,room:this.eventInfo.room,address:this.eventInfo.address},conference:this.eventInfo.id,sessionTimetable:any(this.isSessionTimetable,false),type:type,parentType:'Event'};},_addToSessionParams:function(session,type){var params=this._addParams(type);if(type!='SessionSlot'){params.roomInfo={location:session.location,room:session.room,address:session.address};}\u000aparams.sessionConveners=session.sessionConveners;params.session=exists(session.sessionId)?session.sessionId:session.id;if(type!='SessionSlot'){params.slot=session.sessionSlotId;params.type='Session'+params.type;}\u000aparams.parentType=(type=='SessionSlot'?'Session':'SessionSlot');return params;},addContribution:function(){var self=this;var params;if(this.session!==null){params=this._addToSessionParams(this.session,'Contribution');}else{params=this._addParams('Contribution');}\u000avar canCreateNew=!self.isSessionTimetable||self.timetable.canManageSession;var dialog=new AddContributionDialog($O(params),this.timetable,function(result){handleNotifications(result);self._addEntries(result.entries);},canCreateNew);dialog.execute();},addBreak:function(){var self=this;var params=self._addParams();var urlArgs={confId:self.eventInfo.id,day:params.selectedDay};if(self.session!==null){urlArgs.session_block_id=self.session.sessionSlotId;}\u000aif(self.isSessionTimetable){urlArgs.session_id=self.timetable.contextInfo.sessionId;}\u000aajaxDialog({trigger:self,url:build_url(Indico.Urls.Timetable.breaks.add,urlArgs),title:$T.gettext("Add break"),onClose:function(data){if(data){handleNotifications(data);self.timetable._updateDay(data.update);}}});},addSession:function(){var self=this;var params=this._addParams('Session');ajaxDialog({trigger:this,url:build_url(Indico.Urls.Timetable.sessions.add,{'confId':params.conference}),title:$T.gettext("Add session"),onClose:function(data){if(data){handleNotifications(data);self.timetable.eventInfo.sessions[data.session.id]=data.session;if(data.success){self.addSessionSlot(data.session);}}}});},addSessionSlot:function(session){var self=this;var params=this._addToSessionParams(session,'SessionSlot');var urlArgs={'confId':params.conference,'day':params.selectedDay,'parent_session_id':params.session,};if(self.isSessionTimetable){urlArgs.session_id=self.timetable.contextInfo.timetableSession.id;}\u000aajaxDialog({trigger:this,url:build_url(Indico.Urls.Timetable.sessionBlocks.add,urlArgs),title:$T.gettext("Add session block"),onLoadError:function(xhr){if(xhr.status==404){handleErrorResponse(xhr);}else{handleAjaxError(xhr);}\u000areturn false;},onError:function(xhr){if(xhr.status==404){handleErrorResponse(xhr);$(this).trigger('ajaxDialog:close');}else{handleAjaxError(xhr);}},onClose:function(data){if(data){handleNotifications(data);self.timetable._updateDay(data.update);}}});},swapEntry:function(eventData,direction){var self=this;var info=this._getLocatorParams(eventData);info.set('direction',direction);if(exists(eventData.sessionId)){info.set('session',eventData.sessionId);info.set('slot',eventData.sessionSlotId);}\u000avar urlArgs={'confId':eventData.conferenceId,'entry_id':eventData.scheduleEntryId};if(self.timetable.isSessionTimetable){urlArgs.session_id=self.timetable.contextInfo.sessionId||self.timetable.contextInfo.timetableSession.id;}\u000a$.ajax({url:build_url(Indico.Urls.Timetable.entries.swap,urlArgs),method:'POST',data:info.getAll(),error:handleAjaxError,complete:IndicoUI.Dialogs.Util.progress(),success:function(data){if(data){self.timetable._updateDay(data.update);}}});},_addEntries:function(entries){var self=this;each(entries,function(update){self.timetable._updateDay(update);});}},function(timetable,eventInfo,isSessionTimetable){this.timetable=timetable;this.eventInfo=eventInfo;this.isSessionTimetable=isSessionTimetable;});type("TopLevelTimeTableManagementActions",["TimetableManagementActions"],{_getLocatorParams:function(eventData){var info=new WatchObject();info.set('scheduleEntryId',eventData.scheduleEntryId);info.set('conference',eventData.conferenceId);if(this.isSessionTimetable){info.set('sessionTimetable',this.isSessionTimetable);info.set('sessionId',eventData.sessionId);}\u000areturn info;}},function(timetable,eventInfo,contextInfo,isSessionTimetable){this.TimetableManagementActions(timetable,eventInfo,isSessionTimetable);this.session=null;});type("IntervalTimeTableManagementActions",["TimetableManagementActions"],{_getLocatorParams:function(eventData){var info=new WatchObject();info.set('scheduleEntryId',eventData.scheduleEntryId);info.set('conference',eventData.conferenceId);info.set('sessionId',eventData.sessionId);info.set('sessionSlotId',eventData.sessionSlotId);return info;}},function(timetable,eventInfo,intervalInfo,isSessionTimetable){this.TimetableManagementActions(timetable,eventInfo,isSessionTimetable);this.session=intervalInfo;});
p1
.